
 config/elfos.h            |   14 +++++++++
 config/i386/i386-protos.h |    1 
 config/i386/i386.c        |    7 ++++
 config/i386/i386.h        |    2 -
 config/rs6000/linux.h     |    3 +
 config/rs6000/linux64.h   |    3 +
 config/rs6000/rs6000.c    |    5 +--
 output.h                  |    6 +++
 tree.h                    |   11 +++++++
 varasm.c                  |   70 ++++++++++++++++++++++++++++++++++++++++++++--
 10 files changed, 114 insertions(+), 8 deletions(-)

diff -uNrp trunk/gcc.orig/config/elfos.h trunk/gcc/config/elfos.h
--- trunk/gcc.orig/config/elfos.h	2006-03-22 00:17:54.000000000 +0100
+++ trunk/gcc/config/elfos.h	2006-03-22 14:28:10.000000000 +0100
@@ -489,3 +489,17 @@ Boston, MA 02110-1301, USA.  */
         fprintf ((FILE), "\"\n");					\
     }									\
   while (0)
+
+/* A C statement (sans semicolon) to output to the stdio stream STREAM
+   any text necessary for declaring the name of an external symbol
+   named NAME whch is referenced in this compilation but not defined.
+   It is needed to properly support non-default visibility.  */
+
+#ifndef ASM_OUTPUT_EXTERNAL
+#define ASM_OUTPUT_EXTERNAL(FILE, DECL, NAME) \
+  default_elf_asm_output_external (FILE, DECL, NAME)
+#endif
+
+#ifndef TARGET_ASM_FILE_END
+#define TARGET_ASM_FILE_END default_elf_asm_file_end
+#endif
diff -uNrp trunk/gcc.orig/config/i386/i386.c trunk/gcc/config/i386/i386.c
--- trunk/gcc.orig/config/i386/i386.c	2006-03-22 14:20:45.000000000 +0100
+++ trunk/gcc/config/i386/i386.c	2006-03-22 14:28:10.000000000 +0100
@@ -4751,6 +4751,13 @@ ix86_file_end (void)
     file_end_indicate_exec_stack ();
 }
 
+void
+ix86_elf_file_end (void)
+{
+  ix86_file_end ();
+  default_elf_asm_file_end ();
+}
+
 /* Emit code for the SET_GOT patterns.  */
 
 const char *
diff -uNrp trunk/gcc.orig/config/i386/i386.h trunk/gcc/config/i386/i386.h
--- trunk/gcc.orig/config/i386/i386.h	2006-03-22 00:17:11.000000000 +0100
+++ trunk/gcc/config/i386/i386.h	2006-03-22 14:28:10.000000000 +0100
@@ -1438,7 +1438,7 @@ typedef struct ix86_args {
 #define EXPAND_BUILTIN_VA_START(VALIST, NEXTARG) \
   ix86_va_start (VALIST, NEXTARG)
 
-#define TARGET_ASM_FILE_END ix86_file_end
+#define TARGET_ASM_FILE_END ix86_elf_file_end
 #define NEED_INDICATE_EXEC_STACK 0
 
 /* Output assembler code to FILE to increment profiler label # LABELNO
diff -uNrp trunk/gcc.orig/config/i386/i386-protos.h trunk/gcc/config/i386/i386-protos.h
--- trunk/gcc.orig/config/i386/i386-protos.h	2006-03-22 00:17:11.000000000 +0100
+++ trunk/gcc/config/i386/i386-protos.h	2006-03-22 14:28:10.000000000 +0100
@@ -29,6 +29,7 @@ extern int ix86_frame_pointer_required (
 extern void ix86_setup_frame_addresses (void);
 
 extern void ix86_file_end (void);
+extern void ix86_elf_file_end (void);
 extern HOST_WIDE_INT ix86_initial_elimination_offset (int, int);
 extern void ix86_expand_prologue (void);
 extern void ix86_expand_epilogue (int);
diff -uNrp trunk/gcc.orig/config/rs6000/linux64.h trunk/gcc/config/rs6000/linux64.h
--- trunk/gcc.orig/config/rs6000/linux64.h	2006-03-22 00:17:37.000000000 +0100
+++ trunk/gcc/config/rs6000/linux64.h	2006-03-22 14:28:10.000000000 +0100
@@ -563,7 +563,8 @@ while (0)
 #undef DRAFT_V4_STRUCT_RET
 #define DRAFT_V4_STRUCT_RET (!TARGET_64BIT)
 
-#define TARGET_ASM_FILE_END rs6000_elf_end_indicate_exec_stack
+#undef TARGET_ASM_FILE_END
+#define TARGET_ASM_FILE_END rs6000_elf_file_end
 
 #define TARGET_POSIX_IO
 
diff -uNrp trunk/gcc.orig/config/rs6000/linux.h trunk/gcc/config/rs6000/linux.h
--- trunk/gcc.orig/config/rs6000/linux.h	2006-03-22 00:17:37.000000000 +0100
+++ trunk/gcc/config/rs6000/linux.h	2006-03-22 14:28:10.000000000 +0100
@@ -108,7 +108,8 @@
 #define RELOCATABLE_NEEDS_FIXUP \
   (target_flags & target_flags_explicit & MASK_RELOCATABLE)
 
-#define TARGET_ASM_FILE_END file_end_indicate_exec_stack
+#undef TARGET_ASM_FILE_END
+#define TARGET_ASM_FILE_END rs6000_elf_file_end
 
 #define TARGET_POSIX_IO
 
diff -uNrp trunk/gcc.orig/config/rs6000/rs6000.c trunk/gcc/config/rs6000/rs6000.c
--- trunk/gcc.orig/config/rs6000/rs6000.c	2006-03-22 00:17:37.000000000 +0100
+++ trunk/gcc/config/rs6000/rs6000.c	2006-03-22 14:28:10.000000000 +0100
@@ -614,7 +614,7 @@ static void rs6000_file_start (void);
 static unsigned int rs6000_elf_section_type_flags (tree, const char *, int);
 static void rs6000_elf_asm_out_constructor (rtx, int);
 static void rs6000_elf_asm_out_destructor (rtx, int);
-static void rs6000_elf_end_indicate_exec_stack (void) ATTRIBUTE_UNUSED;
+static void rs6000_elf_file_end (void) ATTRIBUTE_UNUSED;
 static void rs6000_elf_asm_init_sections (void);
 static section *rs6000_elf_select_section (tree, int, unsigned HOST_WIDE_INT);
 static void rs6000_elf_unique_section (tree, int);
@@ -18221,10 +18221,11 @@ rs6000_elf_declare_function_name (FILE *
 }
 
 static void
-rs6000_elf_end_indicate_exec_stack (void)
+rs6000_elf_file_end (void)
 {
   if (TARGET_32BIT)
     file_end_indicate_exec_stack ();
+  default_elf_asm_file_end ();
 }
 #endif
 
diff -uNrp trunk/gcc.orig/output.h trunk/gcc/output.h
--- trunk/gcc.orig/output.h	2006-03-22 00:17:58.000000000 +0100
+++ trunk/gcc/output.h	2006-03-22 14:28:10.000000000 +0100
@@ -608,6 +608,12 @@ extern void default_file_start (void);
 extern void file_end_indicate_exec_stack (void);
 extern bool default_valid_pointer_mode (enum machine_mode);
 
+extern void default_elf_asm_output_external (FILE *file, tree,
+					     const char *);
+extern void default_elf_asm_output_external_1 (tree);
+extern void default_elf_asm_file_end (void);
+extern int maybe_assemble_visibility (tree);
+
 extern int default_address_cost (rtx);
 
 /* dbxout helper functions */
diff -uNrp trunk/gcc.orig/tree.h trunk/gcc/tree.h
--- trunk/gcc.orig/tree.h	2006-03-22 00:17:58.000000000 +0100
+++ trunk/gcc/tree.h	2006-03-22 14:28:10.000000000 +0100
@@ -4388,6 +4388,17 @@ extern void process_pending_assemble_ext
 extern void finish_aliases_1 (void);
 extern void finish_aliases_2 (void);
 
+/* Linked list of all external symbols that are to be emitted by
+   GCC.  */
+
+struct extern_symbol_list GTY(())
+{
+  struct extern_symbol_list *next;
+  tree decl;
+};
+
+extern GTY(()) struct extern_symbol_list *extern_symbol_head;
+
 /* In stmt.c */
 extern void expand_computed_goto (tree);
 extern bool parse_output_constraint (const char **, int, int, int,
diff -uNrp trunk/gcc.orig/varasm.c trunk/gcc/varasm.c
--- trunk/gcc.orig/varasm.c	2006-03-22 00:17:58.000000000 +0100
+++ trunk/gcc/varasm.c	2006-03-22 14:28:10.000000000 +0100
@@ -126,7 +126,6 @@ static unsigned HOST_WIDE_INT array_size
 static unsigned min_align (unsigned, unsigned);
 static void output_constructor (tree, unsigned HOST_WIDE_INT, unsigned int);
 static void globalize_decl (tree);
-static void maybe_assemble_visibility (tree);
 #ifdef BSS_SECTION_ASM_OP
 #ifdef ASM_OUTPUT_BSS
 static void asm_output_bss (FILE *, tree, const char *,
@@ -5039,13 +5038,18 @@ default_assemble_visibility (tree decl, 
 
 /* A helper function to call assemble_visibility when needed for a decl.  */
 
-static void
+int
 maybe_assemble_visibility (tree decl)
 {
   enum symbol_visibility vis = DECL_VISIBILITY (decl);
 
   if (vis != VISIBILITY_DEFAULT)
-    targetm.asm_out.visibility (decl, vis);
+    {
+      targetm.asm_out.visibility (decl, vis);
+      return 1;
+    }
+  else
+    return 0;
 }
 
 /* Returns 1 if the target configuration supports defining public symbols
@@ -6194,4 +6198,64 @@ output_object_blocks (void)
   htab_traverse (object_block_htab, output_object_block_htab, NULL);
 }
 
+struct extern_symbol_list *extern_symbol_head;
+
+void
+default_elf_asm_output_external_1 (tree decl)
+{
+  struct extern_symbol_list *p
+    = ggc_alloc (sizeof (struct extern_symbol_list));
+
+  p->decl = decl;
+  p->next = extern_symbol_head;
+  extern_symbol_head = p;
+}
+
+/* Emit text to declare externally defined symbols. It is needed to
+   properly support non-default visibility.  */
+
+void
+default_elf_asm_output_external (FILE *file ATTRIBUTE_UNUSED,
+				 tree decl,
+				 const char *name)
+{
+  /* Ignore builtin functions.  */
+  if (TREE_CODE (decl) == FUNCTION_DECL
+      && strstr (name, "__builtin_") == name)
+    return;
+  else 
+    default_elf_asm_output_external_1 (decl);
+}
+
+/* Print out the list of referenced global symbols with non-default
+   visibility.  */
+
+void
+default_elf_asm_file_end (void)
+{
+  struct extern_symbol_list *p;
+
+  for (p = extern_symbol_head; p; p = p->next)
+    {
+      tree decl = p->decl;
+      tree id = DECL_ASSEMBLER_NAME (decl);
+
+      if (!id)
+	abort ();
+
+      /* We output the name if and only if TREE_SYMBOL_REFERENCED is
+	 set in order to avoid putting out names that are never really
+	 used.  */
+      if (targetm.binds_local_p (decl)
+	  && !TREE_ASM_WRITTEN (decl)
+	  && TREE_SYMBOL_REFERENCED (id))
+	{
+	  maybe_assemble_visibility (decl);
+	  TREE_ASM_WRITTEN (decl) = 1;
+	}
+    }
+
+  extern_symbol_head = 0;
+}
+
 #include "gt-varasm.h"
