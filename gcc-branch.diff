Index: gcc-4_2-branch/libgomp/configure
===================================================================
--- gcc-4_2-branch/libgomp/configure	(revision 123014)
+++ gcc-4_2-branch/libgomp/configure	(revision 124164)
@@ -9315,7 +9315,7 @@
   # does some of this, but throws away the result.
 
   ldver=`$LD --version 2>/dev/null | head -1 | \
-         sed -e 's/GNU ld version \([0-9.][0-9.]*\).*/\1/'`
+         sed -e 's/GNU ld \(version \)\{0,1\}\(([^)]*) \)\{0,1\}\([0-9.][0-9.]*\).*/\3/'`
 
   libgomp_gnu_ld_version=`echo $ldver | \
          $AWK -F. '{ if (NF<3) $3=0; print ($1*100+$2)*100+$3 }'`
Index: gcc-4_2-branch/libgomp/ChangeLog
===================================================================
--- gcc-4_2-branch/libgomp/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/libgomp/ChangeLog	(revision 124164)
@@ -1,3 +1,9 @@
+2007-03-18  Andreas Schwab  <schwab@suse.de>
+
+	* acinclude.m4: Adjust regular expression for ld version
+	extraction.
+	* configure: Regenerate.
+
 2007-02-07  Jakub Jelinek  <jakub@redhat.com>
 
 	PR c++/30703
Index: gcc-4_2-branch/libgomp/acinclude.m4
===================================================================
--- gcc-4_2-branch/libgomp/acinclude.m4	(revision 123014)
+++ gcc-4_2-branch/libgomp/acinclude.m4	(revision 124164)
@@ -148,7 +148,7 @@
   # does some of this, but throws away the result.
   changequote(,)
   ldver=`$LD --version 2>/dev/null | head -1 | \
-         sed -e 's/GNU ld version \([0-9.][0-9.]*\).*/\1/'`
+         sed -e 's/GNU ld \(version \)\{0,1\}\(([^)]*) \)\{0,1\}\([0-9.][0-9.]*\).*/\3/'`
   changequote([,])
   libgomp_gnu_ld_version=`echo $ldver | \
          $AWK -F. '{ if (NF<3) [$]3=0; print ([$]1*100+[$]2)*100+[$]3 }'`
Index: gcc-4_2-branch/gcc/tree-vrp.c
===================================================================
--- gcc-4_2-branch/gcc/tree-vrp.c	(revision 123014)
+++ gcc-4_2-branch/gcc/tree-vrp.c	(revision 124164)
@@ -266,6 +266,10 @@
 
       cmp = compare_values (min, max);
       gcc_assert (cmp == 0 || cmp == -1 || cmp == -2);
+
+      if (needs_overflow_infinity (TREE_TYPE (min)))
+	gcc_assert (!is_overflow_infinity (min)
+		    || !is_overflow_infinity (max));
     }
 
   if (t == VR_UNDEFINED || t == VR_VARYING)
@@ -314,6 +318,23 @@
     bitmap_clear (vr->equiv);
 }
 
+/* Set value range VR to a single value.  This function is only called
+   with values we get from statements, and exists to clear the
+   TREE_OVERFLOW flag so that we don't think we have an overflow
+   infinity when we shouldn't.  */
+
+static inline void
+set_value_range_to_value (value_range_t *vr, tree val)
+{
+  gcc_assert (is_gimple_min_invariant (val));
+  if (is_overflow_infinity (val))
+    {
+      val = copy_node (val);
+      TREE_OVERFLOW (val) = 0;
+    }
+  set_value_range (vr, VR_RANGE, val, val, NULL);
+}
+
 /* Set value range VR to a non-negative range of type TYPE.
    OVERFLOW_INFINITY indicates whether to use a overflow infinity
    rather than TYPE_MAX_VALUE; this should be true if we determine
@@ -1565,7 +1586,7 @@
   if (TREE_CODE (op0) == SSA_NAME)
     vr0 = *(get_value_range (op0));
   else if (is_gimple_min_invariant (op0))
-    set_value_range (&vr0, VR_RANGE, op0, op0, NULL);
+    set_value_range_to_value (&vr0, op0);
   else
     set_value_range_to_varying (&vr0);
 
@@ -1573,7 +1594,7 @@
   if (TREE_CODE (op1) == SSA_NAME)
     vr1 = *(get_value_range (op1));
   else if (is_gimple_min_invariant (op1))
-    set_value_range (&vr1, VR_RANGE, op1, op1, NULL);
+    set_value_range_to_value (&vr1, op1);
   else
     set_value_range_to_varying (&vr1);
 
@@ -1892,10 +1913,18 @@
       return;
     }
 
+  /* We punt if:
+     1) [-INF, +INF]
+     2) [-INF, +-INF(OVF)]
+     3) [+-INF(OVF), +INF]
+     4) [+-INF(OVF), +-INF(OVF)]
+     We learn nothing when we have INF and INF(OVF) on both sides.
+     Note that we do accept [-INF, -INF] and [+INF, +INF] without
+     overflow.  */
   if ((min == TYPE_MIN_VALUE (TREE_TYPE (min))
-       || is_negative_overflow_infinity (min))
+       || is_overflow_infinity (min))
       && (max == TYPE_MAX_VALUE (TREE_TYPE (max))
-	  || is_positive_overflow_infinity (max)))
+	  || is_overflow_infinity (max)))
     {
       set_value_range_to_varying (vr);
       return;
@@ -1946,7 +1975,7 @@
   if (TREE_CODE (op0) == SSA_NAME)
     vr0 = *(get_value_range (op0));
   else if (is_gimple_min_invariant (op0))
-    set_value_range (&vr0, VR_RANGE, op0, op0, NULL);
+    set_value_range_to_value (&vr0, op0);
   else
     set_value_range_to_varying (&vr0);
 
@@ -2078,7 +2107,9 @@
 	min = fold_unary_to_constant (code, TREE_TYPE (expr), vr0.max);
       else if (needs_overflow_infinity (TREE_TYPE (expr)))
 	{
-	  if (supports_overflow_infinity (TREE_TYPE (expr)))
+	  if (supports_overflow_infinity (TREE_TYPE (expr))
+	      && !is_overflow_infinity (vr0.min)
+	      && vr0.min != TYPE_MIN_VALUE (TREE_TYPE (expr)))
 	    min = positive_overflow_infinity (TREE_TYPE (expr));
 	  else
 	    {
@@ -2254,6 +2285,18 @@
       if (needs_overflow_infinity (TREE_TYPE (expr)))
 	{
 	  gcc_assert (code != NEGATE_EXPR && code != ABS_EXPR);
+
+	  /* If both sides have overflowed, we don't know
+	     anything.  */
+	  if ((is_overflow_infinity (vr0.min)
+	       || TREE_OVERFLOW (min))
+	      && (is_overflow_infinity (vr0.max)
+		  || TREE_OVERFLOW (max)))
+	    {
+	      set_value_range_to_varying (vr);
+	      return;
+	    }
+
 	  if (is_overflow_infinity (vr0.min))
 	    min = vr0.min;
 	  else if (TREE_OVERFLOW (min))
@@ -2350,7 +2393,7 @@
   else if (TREE_CODE_CLASS (code) == tcc_comparison)
     extract_range_from_comparison (vr, expr);
   else if (is_gimple_min_invariant (expr))
-    set_value_range (vr, VR_RANGE, expr, expr, NULL);
+    set_value_range_to_value (vr, expr);
   else
     set_value_range_to_varying (vr);
 
@@ -4514,6 +4557,17 @@
 	      return;
 	    }
 
+	  /* Check for useless ranges.  */
+	  if (INTEGRAL_TYPE_P (TREE_TYPE (min))
+	      && ((min == TYPE_MIN_VALUE (TREE_TYPE (min))
+		   || is_overflow_infinity (min))
+		  && (max == TYPE_MAX_VALUE (TREE_TYPE (max))
+		      || is_overflow_infinity (max))))
+	    {
+	      set_value_range_to_varying (vr0);
+	      return;
+	    }
+
 	  /* The resulting set of equivalences is the intersection of
 	     the two sets.  */
 	  if (vr0->equiv && vr1->equiv && vr0->equiv != vr1->equiv)
@@ -4639,6 +4693,12 @@
 	    vr_arg = *(get_value_range (arg));
 	  else
 	    {
+	      if (is_overflow_infinity (arg))
+		{
+		  arg = copy_node (arg);
+		  TREE_OVERFLOW (arg) = 0;
+		}
+
 	      vr_arg.type = VR_RANGE;
 	      vr_arg.min = arg;
 	      vr_arg.max = arg;
Index: gcc-4_2-branch/gcc/doc/invoke.texi
===================================================================
--- gcc-4_2-branch/gcc/doc/invoke.texi	(revision 123014)
+++ gcc-4_2-branch/gcc/doc/invoke.texi	(revision 124164)
@@ -695,9 +695,11 @@
 -mwarn-framesize  -mwarn-dynamicstack  -mstack-size -mstack-guard}
 
 @emph{Score Options}
-@gccoptlist{-mel -mel @gol
+@gccoptlist{-meb -mel @gol
+-mnhwloop @gol
+-muls @gol
 -mmac @gol
--mscore5u -mscore7}
+-mscore5 -mscore5u -mscore7 -mscore7d}
  
 @emph{SH Options}
 @gccoptlist{-m1  -m2  -m2e  -m3  -m3e @gol
@@ -2834,7 +2836,7 @@
 
 @item -Wstrict-overflow
 @item -Wstrict-overflow=@var{n}
-@opindex -Wstrict-overflow
+@opindex Wstrict-overflow
 This option is only active when @option{-fstrict-overflow} is active.
 It warns about cases where the compiler optimizes based on the
 assumption that signed overflow does not occur.  Note that it does not
@@ -2847,7 +2849,10 @@
 overflow never does, in fact, occur.  Therefore this warning can
 easily give a false positive: a warning about code which is not
 actually a problem.  To help focus on important issues, several
-warning levels are defined.
+warning levels are defined.  No warnings are issued for the use of
+undefined signed overflow when estimating how many iterations a loop
+will require, in particular when determining whether a loop will be
+executed at all.
 
 @table @option
 @item -Wstrict-overflow=1
@@ -4673,7 +4678,7 @@
 arithmetic on them.  This produces better code by making all memory
 references potential common subexpressions.  When they are not common
 subexpressions, instruction combination should eliminate the separate
-register-load. This option is now a nop and will be removed in 4.2.
+register-load. This option is now a nop and will be removed in 4.3.
 
 @item -fforce-addr
 @opindex fforce-addr
@@ -5298,7 +5303,7 @@
 @option{-funroll-loops},
 
 @item -fsplit-ivs-in-unroller
-@opindex -fsplit-ivs-in-unroller
+@opindex fsplit-ivs-in-unroller
 Enables expressing of values of induction variables in later iterations
 of the unrolled loop using the value in the first iteration.  This breaks
 long dependency chains, thus improving efficiency of the scheduling passes.
@@ -5311,7 +5316,7 @@
 This optimization is enabled by default.
 
 @item -fvariable-expansion-in-unroller
-@opindex -fvariable-expansion-in-unroller
+@opindex fvariable-expansion-in-unroller
 With this option, the compiler will create multiple copies of some
 local variables when unrolling a loop which can result in superior code.
 
@@ -8161,13 +8166,13 @@
 @samp{"PrivateHeaders"} or @samp{"Headers"} directory.
 
 @item -gused
-@opindex -gused
+@opindex gused
 Emit debugging information for symbols that are used.  For STABS
 debugging format, this enables @option{-feliminate-unused-debug-symbols}.
 This is by default ON@.
 
 @item -gfull
-@opindex -gfull
+@opindex gfull
 Emit debugging information for all symbols and types.
 
 @item -mmacosx-version-min=@var{version}
@@ -8189,7 +8194,7 @@
 @option{-mlong-branch} for PowerPC targets.
 
 @item -mone-byte-bool
-@opindex -mone-byte-bool
+@opindex mone-byte-bool
 Override the defaults for @samp{bool} so that @samp{sizeof(bool)==1}.
 By default @samp{sizeof(bool)} is @samp{4} when compiling for
 Darwin/PowerPC and @samp{1} when compiling for Darwin/x86, so this
@@ -8238,12 +8243,12 @@
 output file being linked.  See man ld(1) for more information.
 
 @item -dynamiclib
-@opindex -dynamiclib
+@opindex dynamiclib
 When passed this option, GCC will produce a dynamic library instead of
 an executable when linking, using the Darwin @file{libtool} command.
 
 @item -force_cpusubtype_ALL
-@opindex -force_cpusubtype_ALL
+@opindex force_cpusubtype_ALL
 This causes GCC's output file to have the @var{ALL} subtype, instead of
 one controlled by the @option{-mcpu} or @option{-march} option.
 
@@ -9759,7 +9764,9 @@
 The 32-bit environment sets int, long and pointer to 32 bits and
 generates code that runs on any i386 system.
 The 64-bit environment sets int to 32 bits and long and pointer
-to 64 bits and generates code for AMD's x86-64 architecture.
+to 64 bits and generates code for AMD's x86-64 architecture. For
+darwin only the -m64 option turns off the @option{-fno-pic} and
+@option{-mdynamic-no-pic} options.
 
 @item -mno-red-zone
 @opindex no-red-zone
@@ -9947,8 +9954,8 @@
 
 @item -mno-sched-br-data-spec
 @itemx -msched-br-data-spec
-@opindex -mno-sched-br-data-spec
-@opindex -msched-br-data-spec
+@opindex mno-sched-br-data-spec
+@opindex msched-br-data-spec
 (Dis/En)able data speculative scheduling before reload.
 This will result in generation of the ld.a instructions and
 the corresponding check instructions (ld.c / chk.a).
@@ -9956,8 +9963,8 @@
 
 @item -msched-ar-data-spec
 @itemx -mno-sched-ar-data-spec
-@opindex -msched-ar-data-spec
-@opindex -mno-sched-ar-data-spec
+@opindex msched-ar-data-spec
+@opindex mno-sched-ar-data-spec
 (En/Dis)able data speculative scheduling after reload.
 This will result in generation of the ld.a instructions and
 the corresponding check instructions (ld.c / chk.a).
@@ -9965,8 +9972,8 @@
 
 @item -mno-sched-control-spec
 @itemx -msched-control-spec
-@opindex -mno-sched-control-spec
-@opindex -msched-control-spec
+@opindex mno-sched-control-spec
+@opindex msched-control-spec
 (Dis/En)able control speculative scheduling.  This feature is
 available only during region scheduling (i.e. before reload).
 This will result in generation of the ld.s instructions and
@@ -9975,8 +9982,8 @@
 
 @item -msched-br-in-data-spec
 @itemx -mno-sched-br-in-data-spec
-@opindex -msched-br-in-data-spec
-@opindex -mno-sched-br-in-data-spec
+@opindex msched-br-in-data-spec
+@opindex mno-sched-br-in-data-spec
 (En/Dis)able speculative scheduling of the instructions that
 are dependent on the data speculative loads before reload.
 This is effective only with @option{-msched-br-data-spec} enabled.
@@ -9984,8 +9991,8 @@
 
 @item -msched-ar-in-data-spec
 @itemx -mno-sched-ar-in-data-spec
-@opindex -msched-ar-in-data-spec
-@opindex -mno-sched-ar-in-data-spec
+@opindex msched-ar-in-data-spec
+@opindex mno-sched-ar-in-data-spec
 (En/Dis)able speculative scheduling of the instructions that
 are dependent on the data speculative loads after reload.
 This is effective only with @option{-msched-ar-data-spec} enabled.
@@ -9993,8 +10000,8 @@
 
 @item -msched-in-control-spec
 @itemx -mno-sched-in-control-spec
-@opindex -msched-in-control-spec
-@opindex -mno-sched-in-control-spec
+@opindex msched-in-control-spec
+@opindex mno-sched-in-control-spec
 (En/Dis)able speculative scheduling of the instructions that
 are dependent on the control speculative loads.
 This is effective only with @option{-msched-control-spec} enabled.
@@ -10002,8 +10009,8 @@
 
 @item -msched-ldc
 @itemx -mno-sched-ldc
-@opindex -msched-ldc
-@opindex -mno-sched-ldc
+@opindex msched-ldc
+@opindex mno-sched-ldc
 (En/Dis)able use of simple data speculation checks ld.c .
 If disabled, only chk.a instructions will be emitted to check
 data speculative loads.
@@ -10011,8 +10018,8 @@
 
 @item -mno-sched-control-ldc
 @itemx -msched-control-ldc
-@opindex -mno-sched-control-ldc
-@opindex -msched-control-ldc 
+@opindex mno-sched-control-ldc
+@opindex msched-control-ldc 
 (Dis/En)able use of ld.c instructions to check control speculative loads.
 If enabled, in case of control speculative load with no speculatively
 scheduled dependent instructions this load will be emitted as ld.sa and
@@ -10021,14 +10028,14 @@
 
 @item -mno-sched-spec-verbose
 @itemx -msched-spec-verbose
-@opindex -mno-sched-spec-verbose
-@opindex -msched-spec-verbose
+@opindex mno-sched-spec-verbose
+@opindex msched-spec-verbose
 (Dis/En)able printing of the information about speculative motions.
 
 @item -mno-sched-prefer-non-data-spec-insns
 @itemx -msched-prefer-non-data-spec-insns
-@opindex -mno-sched-prefer-non-data-spec-insns
-@opindex -msched-prefer-non-data-spec-insns
+@opindex mno-sched-prefer-non-data-spec-insns
+@opindex msched-prefer-non-data-spec-insns
 If enabled, data speculative instructions will be chosen for schedule
 only if there are no other choices at the moment.  This will make
 the use of the data speculation much more conservative.
@@ -10036,8 +10043,8 @@
 
 @item -mno-sched-prefer-non-control-spec-insns
 @itemx -msched-prefer-non-control-spec-insns
-@opindex -mno-sched-prefer-non-control-spec-insns
-@opindex -msched-prefer-non-control-spec-insns
+@opindex mno-sched-prefer-non-control-spec-insns
+@opindex msched-prefer-non-control-spec-insns
 If enabled, control speculative instructions will be chosen for schedule
 only if there are no other choices at the moment.  This will make
 the use of the control speculation much more conservative.
@@ -10045,8 +10052,8 @@
 
 @item -mno-sched-count-spec-in-critical-path
 @itemx -msched-count-spec-in-critical-path
-@opindex -mno-sched-count-spec-in-critical-path
-@opindex -msched-count-spec-in-critical-path
+@opindex mno-sched-count-spec-in-critical-path
+@opindex msched-count-spec-in-critical-path
 If enabled, speculative dependencies will be considered during
 computation of the instructions priorities.  This will make the use of the
 speculation a bit more conservative.
@@ -12273,25 +12280,41 @@
 These options are defined for Score implementations:
 
 @table @gcctabopt
-@item -mel
-@opindex -mel
-Compile code for little endian mode. 
-
 @item -meb
 @opindex meb
 Compile code for big endian mode.  This is the default.
 
+@item -mel
+@opindex mel
+Compile code for little endian mode. 
+
+@item -mnhwloop
+@opindex mnhwloop
+Disable generate bcnz instruction.
+
+@item -muls
+@opindex muls
+Enable generate unaligned load and store instruction.
+
 @item -mmac
 @opindex mmac
 Enable the use of multiply-accumulate instructions. Disabled by default. 
 
+@item -mscore5
+@opindex mscore5
+Specify the SCORE5 as the target architecture.
+
 @item -mscore5u
 @opindex mscore5u
 Specify the SCORE5U of the target architecture.
 
 @item -mscore7
 @opindex mscore7
-Specify the SCORE7 of the target architecture. This is the default.
+Specify the SCORE7 as the target architecture. This is the default.
+
+@item -mscore7d
+@opindex mscore7d
+Specify the SCORE7D as the target architecture.
 @end table
 
 @node SH Options
Index: gcc-4_2-branch/gcc/doc/md.texi
===================================================================
--- gcc-4_2-branch/gcc/doc/md.texi	(revision 123014)
+++ gcc-4_2-branch/gcc/doc/md.texi	(revision 124164)
@@ -2814,7 +2814,7 @@
 cp1 + cp2 + cp3 registers.
 
 @item I
-Unsigned 15 bit integer (in the range 0 to 32767).
+High 16-bit constant (32-bit constant with 16 LSBs zero).
 
 @item J
 Unsigned 5 bit integer (in the range 0 to 31).
@@ -2831,18 +2831,6 @@
 @item N
 Signed 14 bit integer (in the range @minus{}8192 to 8191).
 
-@item O
-Signed 15 bit integer (in the range @minus{}16384 to 16383).
-
-@item P
-Signed 12 bit integer (in the range @minus{}2048 to 2047).
-
-@item J
-An integer constant with exactly a single bit set.
-
-@item Q
-An integer constant.
-
 @item Z
 Any SYMBOL_REF.
 @end table
Index: gcc-4_2-branch/gcc/DATESTAMP
===================================================================
--- gcc-4_2-branch/gcc/DATESTAMP	(revision 123014)
+++ gcc-4_2-branch/gcc/DATESTAMP	(revision 124164)
@@ -1 +1 @@
-20070317
+20070425
Index: gcc-4_2-branch/gcc/tree-ssa-loop-ch.c
===================================================================
--- gcc-4_2-branch/gcc/tree-ssa-loop-ch.c	(revision 123014)
+++ gcc-4_2-branch/gcc/tree-ssa-loop-ch.c	(revision 124164)
@@ -1,5 +1,5 @@
 /* Loop header copying on trees.
-   Copyright (C) 2004, 2005 Free Software Foundation, Inc.
+   Copyright (C) 2004, 2005, 2006, 2007 Free Software Foundation, Inc.
    
 This file is part of GCC.
    
@@ -204,6 +204,27 @@
 	  continue;
 	}
 
+      /* If the loop has the form "for (i = j; i < j + 10; i++)" then
+	 this copying can introduce a case where we rely on undefined
+	 signed overflow to eliminate the preheader condition, because
+	 we assume that "j < j + 10" is true.  We don't want to warn
+	 about that case for -Wstrict-overflow, because in general we
+	 don't warn about overflow involving loops.  Prevent the
+	 warning by setting TREE_NO_WARNING.  */
+      if (warn_strict_overflow > 0)
+	{
+	  unsigned int i;
+
+	  for (i = 0; i < n_bbs; ++i)
+	    {
+	      tree last;
+
+	      last = last_stmt (copied_bbs[i]);
+	      if (TREE_CODE (last) == COND_EXPR)
+		TREE_NO_WARNING (last) = 1;
+	    }
+	}
+
       /* Ensure that the latch and the preheader is simple (we know that they
 	 are not now, since there was the loop exit condition.  */
       loop_split_edge_with (loop_preheader_edge (loop), NULL);
Index: gcc-4_2-branch/gcc/reload.c
===================================================================
--- gcc-4_2-branch/gcc/reload.c	(revision 123014)
+++ gcc-4_2-branch/gcc/reload.c	(revision 124164)
@@ -1853,7 +1853,12 @@
 		    ||  ! (TEST_HARD_REG_BIT
 			   (reg_class_contents[(int) rld[secondary_out].class],
 			    REGNO (XEXP (note, 0)))))))
-	&& ! fixed_regs[REGNO (XEXP (note, 0))])
+	&& ! fixed_regs[REGNO (XEXP (note, 0))]
+	/* Check that we don't use a hardreg for an uninitialized
+	   pseudo.  See also find_dummy_reload().  */
+	&& (ORIGINAL_REGNO (XEXP (note, 0)) < FIRST_PSEUDO_REGISTER
+	    || ! bitmap_bit_p (ENTRY_BLOCK_PTR->il.rtl->global_live_at_end,
+			       ORIGINAL_REGNO (XEXP (note, 0)))))
       {
 	rld[output_reload].reg_rtx
 	  = gen_rtx_REG (rld[output_reload].outmode,
Index: gcc-4_2-branch/gcc/builtins.c
===================================================================
--- gcc-4_2-branch/gcc/builtins.c	(revision 123014)
+++ gcc-4_2-branch/gcc/builtins.c	(revision 124164)
@@ -5492,14 +5492,19 @@
 			       rtx target, bool ignore)
 {
   rtx val, mem;
+  enum machine_mode old_mode;
 
   /* Expand the operands.  */
   mem = get_builtin_sync_mem (TREE_VALUE (arglist), mode);
 
   arglist = TREE_CHAIN (arglist);
   val = expand_expr (TREE_VALUE (arglist), NULL, mode, EXPAND_NORMAL);
-  /* If VAL is promoted to a wider mode, convert it back to MODE.  */
-  val = convert_to_mode (mode, val, 1);
+  /* If VAL is promoted to a wider mode, convert it back to MODE.  Take care
+     of CONST_INTs, where we know the old_mode only from the call argument.  */
+  old_mode = GET_MODE (val);
+  if (old_mode == VOIDmode)
+    old_mode = TYPE_MODE (TREE_TYPE (TREE_VALUE (arglist)));
+  val = convert_modes (mode, old_mode, val, 1);
 
   if (ignore)
     return expand_sync_operation (mem, val, code);
@@ -5517,19 +5522,28 @@
 				 bool is_bool, rtx target)
 {
   rtx old_val, new_val, mem;
+  enum machine_mode old_mode;
 
   /* Expand the operands.  */
   mem = get_builtin_sync_mem (TREE_VALUE (arglist), mode);
 
   arglist = TREE_CHAIN (arglist);
   old_val = expand_expr (TREE_VALUE (arglist), NULL, mode, EXPAND_NORMAL);
-  /* If OLD_VAL is promoted to a wider mode, convert it back to MODE.  */
-  old_val = convert_to_mode (mode, old_val, 1);
+  /* If VAL is promoted to a wider mode, convert it back to MODE.  Take care
+     of CONST_INTs, where we know the old_mode only from the call argument.  */
+  old_mode = GET_MODE (old_val);
+  if (old_mode == VOIDmode)
+    old_mode = TYPE_MODE (TREE_TYPE (TREE_VALUE (arglist)));
+  old_val = convert_modes (mode, old_mode, old_val, 1);
 
   arglist = TREE_CHAIN (arglist);
   new_val = expand_expr (TREE_VALUE (arglist), NULL, mode, EXPAND_NORMAL);
-  /* If NEW_VAL is promoted to a wider mode, convert it back to MODE.  */
-  new_val = convert_to_mode (mode, new_val, 1);
+  /* If VAL is promoted to a wider mode, convert it back to MODE.  Take care
+     of CONST_INTs, where we know the old_mode only from the call argument.  */
+  old_mode = GET_MODE (new_val);
+  if (old_mode == VOIDmode)
+    old_mode = TYPE_MODE (TREE_TYPE (TREE_VALUE (arglist)));
+  new_val = convert_modes (mode, old_mode, new_val, 1);
 
   if (is_bool)
     return expand_bool_compare_and_swap (mem, old_val, new_val, target);
@@ -5548,14 +5562,19 @@
 				  rtx target)
 {
   rtx val, mem;
+  enum machine_mode old_mode;
 
   /* Expand the operands.  */
   mem = get_builtin_sync_mem (TREE_VALUE (arglist), mode);
 
   arglist = TREE_CHAIN (arglist);
   val = expand_expr (TREE_VALUE (arglist), NULL, mode, EXPAND_NORMAL);
-  /* If VAL is promoted to a wider mode, convert it back to MODE.  */
-  val = convert_to_mode (mode, val, 1);
+  /* If VAL is promoted to a wider mode, convert it back to MODE.  Take care
+     of CONST_INTs, where we know the old_mode only from the call argument.  */
+  old_mode = GET_MODE (val);
+  if (old_mode == VOIDmode)
+    old_mode = TYPE_MODE (TREE_TYPE (TREE_VALUE (arglist)));
+  val = convert_modes (mode, old_mode, val, 1);
 
   return expand_sync_lock_test_and_set (mem, val, target);
 }
Index: gcc-4_2-branch/gcc/fold-const.c
===================================================================
--- gcc-4_2-branch/gcc/fold-const.c	(revision 123014)
+++ gcc-4_2-branch/gcc/fold-const.c	(revision 124164)
@@ -7052,7 +7052,7 @@
 {
   tree type = TREE_TYPE (expr);
   int total_bytes = GET_MODE_SIZE (TYPE_MODE (type));
-  int byte, offset, word, words;
+  int byte, offset, word, words, bitpos;
   unsigned char value;
 
   /* There are always 32 bits in each long, no matter the size of
@@ -7062,19 +7062,20 @@
 
   if (total_bytes > len)
     return 0;
-  words = total_bytes / UNITS_PER_WORD;
+  words = 32 / UNITS_PER_WORD;
 
   real_to_target (tmp, TREE_REAL_CST_PTR (expr), TYPE_MODE (type));
 
-  for (byte = 0; byte < total_bytes; byte++)
+  for (bitpos = 0; bitpos < total_bytes * BITS_PER_UNIT;
+       bitpos += BITS_PER_UNIT)
     {
-      int bitpos = byte * BITS_PER_UNIT;
+      byte = (bitpos / BITS_PER_UNIT) & 3;
       value = (unsigned char) (tmp[bitpos / 32] >> (bitpos & 31));
 
-      if (total_bytes > UNITS_PER_WORD)
+      if (UNITS_PER_WORD < 4)
 	{
 	  word = byte / UNITS_PER_WORD;
-	  if (FLOAT_WORDS_BIG_ENDIAN)
+	  if (WORDS_BIG_ENDIAN)
 	    word = (words - 1) - word;
 	  offset = word * UNITS_PER_WORD;
 	  if (BYTES_BIG_ENDIAN)
@@ -7083,8 +7084,8 @@
 	    offset += byte % UNITS_PER_WORD;
 	}
       else
-	offset = BYTES_BIG_ENDIAN ? (total_bytes - 1) - byte : byte;
-      ptr[offset] = value;
+	offset = BYTES_BIG_ENDIAN ? 3 - byte : byte;
+      ptr[offset + ((bitpos / BITS_PER_UNIT) & ~3)] = value;
     }
   return total_bytes;
 }
@@ -7241,7 +7242,7 @@
 {
   enum machine_mode mode = TYPE_MODE (type);
   int total_bytes = GET_MODE_SIZE (mode);
-  int byte, offset, word, words;
+  int byte, offset, word, words, bitpos;
   unsigned char value;
   /* There are always 32 bits in each long, no matter the size of
      the hosts long.  We handle floating point representations with
@@ -7252,16 +7253,17 @@
   total_bytes = GET_MODE_SIZE (TYPE_MODE (type));
   if (total_bytes > len || total_bytes > 24)
     return NULL_TREE;
-  words = total_bytes / UNITS_PER_WORD;
+  words = 32 / UNITS_PER_WORD;
 
   memset (tmp, 0, sizeof (tmp));
-  for (byte = 0; byte < total_bytes; byte++)
+  for (bitpos = 0; bitpos < total_bytes * BITS_PER_UNIT;
+       bitpos += BITS_PER_UNIT)
     {
-      int bitpos = byte * BITS_PER_UNIT;
-      if (total_bytes > UNITS_PER_WORD)
+      byte = (bitpos / BITS_PER_UNIT) & 3;
+      if (UNITS_PER_WORD < 4)
 	{
 	  word = byte / UNITS_PER_WORD;
-	  if (FLOAT_WORDS_BIG_ENDIAN)
+	  if (WORDS_BIG_ENDIAN)
 	    word = (words - 1) - word;
 	  offset = word * UNITS_PER_WORD;
 	  if (BYTES_BIG_ENDIAN)
@@ -7270,8 +7272,8 @@
 	    offset += byte % UNITS_PER_WORD;
 	}
       else
-	offset = BYTES_BIG_ENDIAN ? (total_bytes - 1) - byte : byte;
-      value = ptr[offset];
+	offset = BYTES_BIG_ENDIAN ? 3 - byte : byte;
+      value = ptr[offset + ((bitpos / BITS_PER_UNIT) & ~3)];
 
       tmp[bitpos / 32] |= (unsigned long)value << (bitpos & 31);
     }
@@ -7732,7 +7734,7 @@
 	    return fold_build1 (BIT_NOT_EXPR, type, fold_convert (type, tem));
 	}
 
-      tem = fold_convert_const (code, type, arg0);
+      tem = fold_convert_const (code, type, op0);
       return tem ? tem : NULL_TREE;
 
     case VIEW_CONVERT_EXPR:
@@ -11126,13 +11128,13 @@
 		  return omit_one_operand (type, integer_zero_node, arg0);
 
 		case GE_EXPR:
-		  return fold_build2 (EQ_EXPR, type, arg0, arg1);
+		  return fold_build2 (EQ_EXPR, type, op0, op1);
 
 		case LE_EXPR:
 		  return omit_one_operand (type, integer_one_node, arg0);
 
 		case LT_EXPR:
-		  return fold_build2 (NE_EXPR, type, arg0, arg1);
+		  return fold_build2 (NE_EXPR, type, op0, op1);
 
 		/* The GE_EXPR and LT_EXPR cases above are not normally
 		   reached because of previous transformations.  */
@@ -11147,10 +11149,14 @@
 		{
 		case GT_EXPR:
 		  arg1 = const_binop (PLUS_EXPR, arg1, integer_one_node, 0);
-		  return fold_build2 (EQ_EXPR, type, arg0, arg1);
+		  return fold_build2 (EQ_EXPR, type,
+				      fold_convert (TREE_TYPE (arg1), arg0),
+				      arg1);
 		case LE_EXPR:
 		  arg1 = const_binop (PLUS_EXPR, arg1, integer_one_node, 0);
-		  return fold_build2 (NE_EXPR, type, arg0, arg1);
+		  return fold_build2 (NE_EXPR, type,
+				      fold_convert (TREE_TYPE (arg1), arg0),
+				      arg1);
 		default:
 		  break;
 		}
@@ -11163,7 +11169,7 @@
 		  return omit_one_operand (type, integer_zero_node, arg0);
 
 		case LE_EXPR:
-		  return fold_build2 (EQ_EXPR, type, arg0, arg1);
+		  return fold_build2 (EQ_EXPR, type, op0, op1);
 
 		case GE_EXPR:
 		  return omit_one_operand (type, integer_one_node, arg0);
@@ -11181,10 +11187,14 @@
 		{
 		case GE_EXPR:
 		  arg1 = const_binop (MINUS_EXPR, arg1, integer_one_node, 0);
-		  return fold_build2 (NE_EXPR, type, arg0, arg1);
+		  return fold_build2 (NE_EXPR, type,
+				      fold_convert (TREE_TYPE (arg1), arg0),
+				      arg1);
 		case LT_EXPR:
 		  arg1 = const_binop (MINUS_EXPR, arg1, integer_one_node, 0);
-		  return fold_build2 (EQ_EXPR, type, arg0, arg1);
+		  return fold_build2 (EQ_EXPR, type,
+				      fold_convert (TREE_TYPE (arg1), arg0),
+				      arg1);
 		default:
 		  break;
 		}
@@ -11200,12 +11210,11 @@
 		   and X >= signed_max+1 because previous transformations.  */
 		if (code == LE_EXPR || code == GT_EXPR)
 		  {
-		    tree st0, st1;
-		    st0 = lang_hooks.types.signed_type (TREE_TYPE (arg0));
-		    st1 = lang_hooks.types.signed_type (TREE_TYPE (arg1));
-		    return fold_build2 (code == LE_EXPR ? GE_EXPR: LT_EXPR,
-			       		type, fold_convert (st0, arg0),
-			       		build_int_cst (st1, 0));
+		    tree st;
+		    st = lang_hooks.types.signed_type (TREE_TYPE (arg1));
+		    return fold_build2 (code == LE_EXPR ? GE_EXPR : LT_EXPR,
+					type, fold_convert (st, arg0),
+					build_int_cst (st, 0));
 		  }
 	      }
 	  }
Index: gcc-4_2-branch/gcc/omp-low.c
===================================================================
--- gcc-4_2-branch/gcc/omp-low.c	(revision 123014)
+++ gcc-4_2-branch/gcc/omp-low.c	(revision 124164)
@@ -2421,6 +2421,7 @@
   block_stmt_iterator si;
   tree entry_stmt;
   edge e;
+  bool do_cleanup_cfg = false;
 
   entry_stmt = last_stmt (region->entry);
   child_fn = OMP_PARALLEL_FN (entry_stmt);
@@ -2456,6 +2457,7 @@
 	  exit_succ_e = single_succ_edge (exit_bb);
 	  make_edge (new_bb, exit_succ_e->dest, EDGE_FALLTHRU);
 	}
+      do_cleanup_cfg = true;
     }
   else
     {
@@ -2546,6 +2548,14 @@
 
   /* Emit a library call to launch the children threads.  */
   expand_parallel_call (region, new_bb, entry_stmt, ws_args);
+
+  if (do_cleanup_cfg)
+    {
+      /* Clean up the unreachable sub-graph we created above.  */
+      free_dominance_info (CDI_DOMINATORS);
+      free_dominance_info (CDI_POST_DOMINATORS);
+      cleanup_tree_cfg ();
+    }
 }
 
 
Index: gcc-4_2-branch/gcc/objc/objc-act.c
===================================================================
--- gcc-4_2-branch/gcc/objc/objc-act.c	(revision 123014)
+++ gcc-4_2-branch/gcc/objc/objc-act.c	(revision 124164)
@@ -3632,7 +3632,7 @@
 
 	{
 	  struct _objc_exception_data _stack;
-	  id volatile _rethrow = 0;
+	  id _rethrow = 0;
 	  try
 	    {
 	      objc_exception_try_enter (&_stack);
@@ -3676,7 +3676,6 @@
 
   rethrow_decl = objc_create_temporary_var (objc_object_type);
   cur_try_context->rethrow_decl = rethrow_decl;
-  TREE_THIS_VOLATILE (rethrow_decl) = 1;
   TREE_CHAIN (rethrow_decl) = stack_decl;
 
   /* Build the outermost variable binding level.  */
Index: gcc-4_2-branch/gcc/ChangeLog
===================================================================
--- gcc-4_2-branch/gcc/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/gcc/ChangeLog	(revision 124164)
@@ -1,3 +1,334 @@
+2007-04-25  Anatoly Sokolov <aesok@post.ru>
+
+	PR target/18989
+ 	* config/avr/avr.h (ASM_OUTPUT_ALIGN): Redefine.
+
+2007-04-24  Andrew Pinski  <andrew_pinski@playstation.sony.com>
+            Roger Sayle  <roger@eyesopen.com>
+
+	PR middle-end/30222
+	* expmed.c (make_tree): Use the correct type, i.e. the inner
+	type, when constructing the individual elements of a CONST_VECTOR.
+
+2007-04-24  Ian Lance Taylor  <iant@google.com>
+
+	PR tree-optimization/31605
+	* tree-vrp.c (set_value_range): Check that min and max are not
+	both overflow infinities.
+	(set_value_range_to_value): New static function.
+	(extract_range_from_binary_expr): Call set_value_range_to_value.
+	(extract_range_from_expr): Likewise.
+	(extract_range_from_unary_expr): Likewise.  Don't create a range
+	which overflows on both sides.
+	(vrp_meet): Check for a useless range.
+	(vrp_visit_phi_node): If we see a constant which looks like an
+	overflow infinity, turn off the TREE_OVERFLOW flag.
+
+2007-04-24  Ian Lance Taylor  <iant@google.com>
+
+	PR tree-optimization/31602
+	* tree-ssa-loop-ch.c (copy_loop_headers): Set TREE_NO_WARNING for
+	conditionals in the copied loop header.
+	* tree-cfg.c (fold_cond_expr_cond): Don't issue undefined overflow
+	warnings if TREE_NO_WARNING is set.
+	* doc/invoke.texi (Warning Options): Clarify that
+	-Wstrict-overflow does not warn about loops.
+
+2007-04-24  Andreas Krebbel  <krebbel1@de.ibm.com>
+
+	PR target/31641
+	* config/s390/s390.c (s390_expand_setmem): Don't ICE for constant length
+	argument of 0 for memset.
+	(s390_expand_movmem, s390_expand_setmem, s390_expand_cmpmem): Use
+	unsigned shift instead of the signed variant.
+
+2007-04-24  Daniel Franke  <franke.daniel@gmail.com>
+
+	* doc/invoke.texi: Removed leading '-' from option index entries.
+
+2007-04-22  Andrew Pinski  <andrew_pinski@playstation.sony.com>
+
+	PR middle-end/31448
+	* expr.c (reduce_to_bit_field_precision): Handle
+	CONST_INT rtx's.
+
+2007-04-20  Richard Henderson  <rth@redhat.com>
+
+	PR target/28623
+	* config/alpha/alpha.c (get_unaligned_address): Remove extra_offset
+	argument; update all callers.
+	(get_unaligned_offset): New.
+	* config/alpha/alpha.md (extendqidi2, extendhidi2): Don't use
+	get_unaligned_address, just pass on the address directly.
+	(unaligned_extendqidi): Use gen_lowpart instead of open-coding
+	the subreg in the helper patterns.
+	(unaligned_extendqidi_le): Use get_unaligned_offset.
+	(unaligned_extendqidi_be, unaligned_extendhidi_le): Likewise.
+	(unaligned_extendhidi_be): Likewise.
+	(unaligned_extendhidi): Tidy.
+	* config/alpha/alpha-protos.h: Update.
+
+2007-04-21  Richard Guenther  <rguenther@suse.de>
+
+	PR middle-end/31136
+	* fold-const.c (fold_unary): Call fold_convert_const on the
+	original tree.
+
+2007-04-20  Richard Henderson  <rth@redhat.com>
+
+	* config/alpha/linux.h (CPP_SPEC): Undef before redefine.
+
+2007-04-20  Bernd Schmidt  <bernd.schmidt@analog.com>
+
+	* reload.c (combine_reloads): When trying to use a dying register,
+	check whether it's uninitialized and don't use if so.
+
+2007-04-20  Jakub Jelinek  <jakub@redhat.com>
+
+	* config/i386/i386.c (bdesc_2arg): Use ORDERED rather than UNORDERED
+	for __builtin_ia32_cmpordss.
+
+	PR tree-optimization/31632
+	* fold-const.c (fold_binary): Use op0 and op1 instead of arg0
+	and arg1 for optimizations of comparison against min/max values.
+	Fold arg0 to arg1's type for optimizations of comparison against
+	min+1 and max-1 values.
+
+2007-04-19  Eric Botcazou  <ebotcazou@libertysurf.fr>
+
+	PR rtl-optimization/29841
+	* cfgbuild.c (control_flow_insn_p): Return TRUE for unconditional
+	trap instructions.
+	* sched-deps.c (sched_analyze_insn): Prevent all non-jump instructions
+	that may cause control flow transfer from being moved.
+
+2007-04-18  Anatoly Sokolov <aesok@post.ru>
+
+	* config/avr/avr.c (ptrreg_to_str): Replace error() with
+	output_operand_lossage().
+
+2007-04-17  Anatoly Sokolov <aesok@post.ru>
+
+	PR target/30483
+	* config/avr/avr.c (ptrreg_to_str): Replace gcc_unreachable() with
+	error().
+
+2007-04-17  Jan Hubicka  <jh@suse.cz>
+
+	PR middle-end/30700
+	* dwarf2out.c (reference_to_unused): Ask cgraph for functions
+	availablility; add more sanity checking; ask varpool only about
+	VAR_DECL.
+
+2007-04-17  H.J. Lu  <hongjiu.lu@intel.com>
+
+	* Backport from mainline:
+	2007-04-17  H.J. Lu  <hongjiu.lu@intel.com>
+
+	* config/i386/sse.md (sse_vmaddv4sf3): Use register_operand
+	on "0".
+	(sse_vmmulv4sf3): Likewise.
+	(sse2_vmaddv2df3): Likewise.
+	(sse2_vmmulv2df3): Likewise.
+
+2007-04-16  Matthias Klose  <doko@debian.org>
+
+	* config/alpha/linux.h (CPP_SPEC): Define.
+	* config/arm/linux-gas.h (SUBTARGET_CPP_SPEC): Extend.
+
+2007-04-16  Anatoly Sokolov <aesok@post.ru>
+
+	* config/avr/avr.c (avr_arch_types): Rearranging  array.
+	(enum avr_arch): Add.
+	(avr_mcu_types): Use avr_arch enumeration constants instead of 
+	numbers.
+	* config/avr/avr.h (LINK_SPEC): Simplify.
+
+2007-04-16  Jan Hubicka  <jh@suse.cz>
+
+	PR target/27869
+	* config/i386/sse.md
+	(sse_vmaddv4sf3, sse_vmmulv4sf3): Remove '%' modifier.
+	(sse_vmsmaxv4sf3_finite, sse_vmsminv4sf3_finite): Remove.
+	(sse2_vmaddv2df3, sse2_vmmulv2df3): Remove '%' modifier.
+	(sse2_vmsmaxv2df3_finite, sse2_vmsminv2df3_finite): Remove.
+
+2007-04-16  H.J. Lu  <hongjiu.lu@intel.com>
+
+	* Backport from mainline:
+	2007-04-16  H.J. Lu  <hongjiu.lu@intel.com>
+
+	PR target/31582
+	* config/i386/i386.c (ix86_expand_vec_set_builtin): Make a
+	copy of source, pass it to ix86_expand_vector_set and return
+	it as target.
+
+2007-04-14  Andrew Pinski  <andrew_pinski@playstation.sony.com>
+
+	PR c/31520
+	* c-decl.c (finish_decl): Grab the type of the decl after the call
+	to store_init_value.
+
+2007-04-14  Jakub Jelinek  <jakub@redhat.com>
+
+	PR c++/25874
+	* omp-low.c (expand_omp_parallel): If child_cfun->cfg, free dominators,
+	post dominators and cleanup cfg before returning.
+
+2007-04-11  John David Anglin  <dave.anglin@nrc-cnrc.gc.ca>
+
+	* pa.c (pa_som_asm_init_sections): Ensure that cfun->machine is not
+	null before emitting a .nsubspa directive.
+
+2007-04-08  Anatoly Sokolov <aesok@post.ru>
+
+	PR target/29932
+	* config/avr/predicates.md (io_address_operand): Delete predicate.
+	(low_io_address_operand): Don't use 'mode' argument.
+	(higth_io_address_operand): Rename ...
+	(high_io_address_operand): ... to this. Don't use 'mode' argument.
+	* config/avr/avr.md (*sbix_branch_tmp, *sbix_branch_tmp_bit7): Adjust
+	for above change.
+
+2007-04-07  Anatoly Sokolov <aesok@post.ru>
+
+	PR target/30289
+	* config/avr/avr.md (*clrmemqi, *clrmemhi): Mark operand 4 as 
+	earlyclobber.
+
+2007-04-05  Anatoly Sokolov <aesok@post.ru>
+
+	PR target/25448
+	* config/avr/avr.c (avr_handle_fndecl_attribute): Use the 
+	DECL_ASSEMBLER_NAME, not the DECL_NAME.
+
+2007-04-04  Richard Henderson  <rth@redhat.com>
+
+	PR target/31361
+	* config/i386/i386.c (ix86_init_mmx_sse_builtins): Remove
+	v8hi_ftype_v8hi_v2di, v4si_ftype_v4si_v2di.  Use like-types for
+	the variable shift builtins.
+	(ix86_expand_builtin): Properly expand the variable shift builtins.
+	* config/i386/sse.md (ashr<mode>3, lshr<mode>3, ashl<mode>3): Make
+	operand 2 be TImode.
+	* config/i386/emmintrin.h (_mm_slli_epi16, _mm_slli_epi32,
+	_mm_slli_epi64, _mm_srai_epi16, _mm_srai_epi32, _mm_srli_epi16,
+	_mm_srli_epi32, _mm_srli_epi64): Turn into macros.
+	(_mm_srli_si128, _mm_srli_si128): Fix disabled inline versions.
+	(_mm_sll_epi16, _mm_sll_epi32, _mm_sll_epi64, _mm_sra_epi16,
+	_mm_sra_epi32, _mm_srl_epi16, _mm_srl_epi32, _mm_srl_epi64): Use
+	two-vector shift builtins.
+
+2007-04-04  Chen liqin  <liqin@sunnorth.com.cn>
+
+	* config/score/crti.asm: Change _bss_start to __bss_start.
+	* config/score/score.h (CONDITIONAL_REGISTER_USAGE): Added.
+	(OUTGOING_REG_PARM_STACK_SPACE) update.
+	* config/score/score.opt: add options to make backend support
+	score5, score5u, score7 and score7d.
+	* config/score/score.md: Likewise.
+	* config/score/misc.md: Likewise.
+	* config/score/mac.md: Likewise.
+	* doc/invoke.texi: Likewise.
+	* doc/md.texi: update constraints define.
+
+2007-04-03  Stuart Hastings  <stuart@apple.com>
+
+	PR 31281
+	* objc/objc-act.c (next_sjlj_build_catch_list): Delete volatile from rethrow decl.
+	* cse.c (record_jump_equiv): Bail out on CCmode comparisons.
+
+2007-04-03  Jakub Jelinek  <jakub@redhat.com>
+
+	PR middle-end/30704
+	* fold-const.c (native_encode_real): Encode real.c provided longs
+	as a series of 32-bit native integers.
+	(native_interpret_real): Interpret buffer as a series of 32-bit
+	native integers.
+
+2007-04-02  Eric Christopher  <echristo@apple.com>
+
+	* doc/invoke.texi (i386 and x86-64 Options): Document -m64
+	limitations on darwin.
+
+2007-04-02  Anatoly Sokolov <aesok@post.ru>
+
+	PR target/31137
+	* config/avr/avr.c (avr_rtx_costs): Add missing 'break' statements.
+
+2007-04-02  H.J. Lu  <hongjiu.lu@intel.com>
+
+	* Backport from mainline:
+	2007-03-28  Grigory Zagorodnev <grigory_zagorodnev@linux.intel.com>
+
+	PR target/31380
+	* config/i386/sse.md (uminv16qi3): Use UMIN instead of UMAX.
+
+2007-03-30  Anatoly Sokolov <aesok@post.ru>
+
+	* config/avr/avr.c (avr_override_options): Clear
+	'flag_delete_null_pointer_checks'.
+
+2007-03-29  Michael Matz  <matz@suse.de>
+
+	* builtins.c (expand_builtin_sync_operation,
+	expand_builtin_compare_and_swap,
+	expand_builtin_lock_test_and_set): Care for extending CONST_INTs
+	correctly.
+
+	* config/i386/sync.md (sync_double_compare_and_swapdi_pic,
+	sync_double_compare_and_swap_ccdi_pic): Use "SD" as constraint
+	for operand 3.
+
+2007-03-28  Mike Stump  <mrs@apple.com>
+
+	* config/darwin9.h (ASM_OUTPUT_ALIGNED_COMMON): Add.
+	* config/darwin.h (MAX_OFILE_ALIGNMENT): Fix.
+	* config/rs6000/darwin.h (ASM_OUTPUT_ALIGNED_COMMON): Removed #undef.
+
+2007-03-27  Anatoly Sokolov <aesok@post.ru>
+
+	* config/avr/avr.c (avr_mcu_types): Move at90usb82 device to 'avr4'
+	architecture.
+
+2007-03-26  Ian Lance Taylor  <iant@google.com>
+
+	PR tree-optimization/31345
+	* tree-vrp.c (extract_range_from_binary_expr): Turn ranges like
+	[+INF, +INF(OVF)] into VARYING.
+
+2007-03-23  Martin Michlmayr  <tbm@cyrius.com>
+
+	* doc/invoke.texi (-fforce-mem): Update documentation to reflect
+	that this option will be removed in 4.3 rather than 4.2.
+	* opts.c (common_handle_option): Likewise.
+
+2007-03-21  Mike Stump  <mrs@apple.com>
+
+	* c.opt: Fixup for Objective-C/C++.
+
+2007-03-21  Richard Henderson  <rth@redhat.com>
+
+	PR target/31245
+	* config/i386/emmintrin.h (__m128i, __m128d): Mark may_alias.
+	* config/i386/mmintrin.h (__m64): Likewise.
+	* config/i386/xmmintrin.h (__m128): Likewise.
+
+2007-03-20  Jakub Jelinek  <jakub@redhat.com>
+
+	PR c/30762
+	* c-typeck.c (convert_for_assignment): Call comptypes for
+	RECORD_TYPE or UNION_TYPE.
+
+	PR inline-asm/30505
+	* reload1.c (reload): Do invalid ASM checking after
+	cleanup_subreg_operands.
+
+2007-03-19  Jeff Law  <law@redhat.com>
+
+	* tree-cfg.c (find_taken_edge): Tighten conditions for
+	optimizing computed gotos.
+
 2007-03-16  John David Anglin  <dave.anglin@nrc-cnrc.gc.ca>
 
 	* pa.c (attr_length_call): Partially revert change of 2007-03-09.
@@ -24,7 +355,7 @@
 	PR target/31123
 	* pa.md (vdepi_ior): Don't allow zero length deposit.  Likewise for
 	two unamed patterns.
-	
+
 2007-03-12  Brooks Moses  <brooks.moses@codesourcery.com>
 
 	* doc/extend.texi: Edit "gnu_inline" documentation.
@@ -37,7 +368,7 @@
 	* doc/passes.texi: Fix gcc.info cross-reference.
 
 2007-03-12  Daniel Berlin  <dberlin@dberlin.org>
-	
+
 	Fix PR tree-optimization/28544
 	* tree-ssa-operands.c (add_virtual_operand):
 	Move assert triggering on aliasing violations into
@@ -119,7 +450,7 @@
 	(thread_across_edge): Likewise.
 	* tree-flow.h (vrp_evaluate_conditional): Update declaration.
 	(thread_across_edge): Likewise.
-	* gcc/Makefile.in (tree-vrp.o): Depend upon toplev.h and intl.h.
+	* Makefile.in (tree-vrp.o): Depend upon toplev.h and intl.h.
 
 	2007-03-05  Ian Lance Taylor  <iant@google.com>
 
@@ -415,7 +746,7 @@
 2007-03-09  Andrew Pinski  <andrew_pinski@playstation.sony.com>
 
 	PR tree-opt/28624
-	* tree-ssa-dom.c (eliminate_degenerate_phis): Use a temporary 
+	* tree-ssa-dom.c (eliminate_degenerate_phis): Use a temporary
 	bitmap for EXECUTE_IF_SET_IN_BITMAP.
 
 2006-03-09  Mark Shinwell  <shinwell@codesourcery.com>
@@ -436,7 +767,7 @@
 	* builtins.def (lceil, lceilf, lceill, lfloor, lfloorf, lfloorl,
 	llceil, llceilf, llceill, llfloor, llfloorf, llfloorl): Mark with
 	ATTR_CONST_NOTHROW_LIST.
-	
+
 	* fold-const.c (tree_expr_nonnegative_p): Handle FIX_TRUNC_EXPR.
 
 2007-03-08 Andrew Pinski <andrew_pinski@playstation.sony.com>
@@ -484,11 +815,11 @@
 	* doc/invoke.texi (Warning Options): Replace -Werror- with
 	-Werror=.
 	* opts.c (common_handle_option): Likewise.
-	
+
 2007-03-06  Anatoly Sokolov <aesok@post.ru>
 
 	* config/avr/avr.c (avr_mcu_types): Add support for ATmega325P,
-	ATmega3250P, ATmega329P, ATmega3290P, AT90USB82 and AT90USB162 
+	ATmega3250P, ATmega329P, ATmega3290P, AT90USB82 and AT90USB162
 	devices.
 	* config/avr/avr.h (LINK_SPEC, CRT_BINUTILS_SPECS): (Ditto.).
 	* config/avr/t-avr (MULTILIB_MATCHES): (Ditto.).
@@ -509,7 +840,7 @@
 	in soft-float DFmode pattern.
 	(movdf): Fail if operand1 is a CONST_DOUBLE and operand0 is a hard
 	floating register.
-	(movsf): Likewise. 
+	(movsf): Likewise.
 
 2007-03-05  Kaveh R. Ghazi  <ghazi@caip.rutgers.edu>
 
@@ -618,7 +949,7 @@
 2007-03-01  Manuel Lopez-Ibanez  <manu@gcc.gnu.org>
 
 	* doc/invoke.texi (Wextra): Delete outdated paragraph.
-	
+
 2007-02-27  John David Anglin  <dave.anglin@nrc-cnrc.gc.ca>
 
 	* pa/predicates.md (move_src_operand): Allow zero for mode.
@@ -706,7 +1037,7 @@
 2007-02-18 Ira Rosen  <irar@il.ibm.com>
 
 	* tree-ssa-alias.c (may_aliases_intersect): New function.
-	* tree-data-ref.c (ptr_ptr_may_alias_p): Call may_aliases_intersect 
+	* tree-data-ref.c (ptr_ptr_may_alias_p): Call may_aliases_intersect
 	for different tags.
 	* tree-flow.h (may_aliases_intersect): Add function declaration.
 
@@ -764,7 +1095,7 @@
 
 2007-02-06  Rask Ingemann Lamberisen  <rask@sygehus.dk>
 
-	PR 30370 
+	PR 30370
 	* config/rs6000/t-ppccomm: Correct Makefile typo.
 
 2007-02-06  Roger Sayle  <roger@eyesopen.com>
@@ -788,7 +1119,7 @@
 2007-02-05  Bob Wilson  <bob.wilson@acm.org>
 
 	* config/xtensa/xtensa.c (constantpool_mem_p): Skip over SUBREGs.
-	
+
 2007-02-02  Maxim Kuvyrkov  <mkuvyrkov@ispras.ru>
 
 	PR target/29682
@@ -817,7 +1148,7 @@
 
 	Revert for x86 darwin:
 	2005-06-19  Uros Bizjak  <uros@kss-loka.si>
-	
+
 	* config/i386/i386.c (ix86_function_arg_regno_p): Put back the
 	code before the following patch under TARGET_MACHO.
 	(ix86_function_value_regno_p): Likewise.
Index: gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/pr31448.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/pr31448.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/pr31448.c	(revision 124164)
@@ -0,0 +1,36 @@
+/* PR middle-end/31448, this used to ICE during expand because
+   reduce_to_bit_field_precision was not ready to handle constants. */
+
+typedef struct _st {
+    int iIndex : 24;
+    int iIndex1 : 24;
+} st;
+st *next;
+void g(void)
+{
+    st *next = 0;
+    int nIndx;
+    const static int constreg[] = { 0,};
+    nIndx = 0;
+    next->iIndex = constreg[nIndx];
+}
+void f(void)
+{
+    int nIndx;
+    const static int constreg[] = { 0xFEFEFEFE,};
+    nIndx = 0;
+    next->iIndex = constreg[nIndx];
+    next->iIndex1 = constreg[nIndx];
+}
+int main(void)
+{
+  st a;
+  next = &a;
+  f();
+  if (next->iIndex != 0xFFFEFEFE)
+    __builtin_abort ();
+  if (next->iIndex1 != 0xFFFEFEFE)
+    __builtin_abort ();
+  return 0;
+}
+
Index: gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/pr31136.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/pr31136.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/pr31136.c	(revision 124164)
@@ -0,0 +1,17 @@
+extern void abort (void);
+
+struct S {
+  unsigned b4:4;
+  unsigned b6:6;
+} s;
+
+int main()
+{
+  s.b6 = 31;
+  s.b4 = s.b6;
+  s.b6 = s.b4;
+  if (s.b6 != 15)
+    abort ();
+  return 0;
+}
+
Index: gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/ieee/pr30704.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/ieee/pr30704.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/ieee/pr30704.c	(revision 124164)
@@ -0,0 +1,57 @@
+/* PR middle-end/30704 */
+
+typedef __SIZE_TYPE__ size_t;
+extern void abort (void);
+extern int memcmp (const void *, const void *, size_t);
+extern void *memcpy (void *, const void *, size_t);
+
+long long
+__attribute__((noinline))
+f1 (void)
+{
+  long long t;
+  double d = 0x0.fffffffffffff000p-1022;
+  memcpy (&t, &d, sizeof (long long));
+  return t;
+}
+
+double
+__attribute__((noinline))
+f2 (void)
+{
+  long long t = 0x000fedcba9876543LL;
+  double d;
+  memcpy (&d, &t, sizeof (long long));
+  return d;
+}
+
+int
+main ()
+{
+  union
+  {
+    long long ll;
+    double d;
+  } u;
+
+  if (sizeof (long long) != sizeof (double) || __DBL_MIN_EXP__ != -1021)
+    return 0;
+
+  u.ll = f1 ();
+  if (u.d != 0x0.fffffffffffff000p-1022)
+    abort ();
+
+  u.d = f2 ();
+  if (u.ll != 0x000fedcba9876543LL)
+    abort ();
+
+  double b = 234.0;
+  long long c;
+  double d = b;
+  memcpy (&c, &b, sizeof (double));
+  long long e = c;
+  if (memcmp (&e, &d, sizeof (double)) != 0)
+    abort ();
+
+  return 0;
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/pr31605.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/pr31605.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/pr31605.c	(revision 124164)
@@ -0,0 +1,13 @@
+void put_field (unsigned int start, unsigned int len)
+{
+  int cur_bitshift = ((start + len) % 8) - 8;
+  if (cur_bitshift > -8)
+    exit (0);
+}
+
+int
+main ()
+{
+  put_field (0, 1);
+  abort ();
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/mayalias-2.x
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/mayalias-2.x	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.c-torture/execute/mayalias-2.x	(revision 124164)
@@ -0,0 +1,10 @@
+set torture_eval_before_compile {
+    set compiler_conditional_xfail_data {
+        "PR 28834" \
+        { "*-*-*" } \
+        { "-O3 -g" } \
+        { "" }
+    }
+}
+
+return 0
Index: gcc-4_2-branch/gcc/testsuite/gcc.c-torture/compile/pr31345-1.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.c-torture/compile/pr31345-1.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.c-torture/compile/pr31345-1.c	(revision 124164)
@@ -0,0 +1,24 @@
+/* PR tree-optimization/31345
+   This caused a crash in VRP when dealing with overflow infinities.  */
+
+void
+dpsnaffle (const char *kbuf)
+{
+  int hash, thash, head[2], off;
+    {
+      int _DP_i;
+      (hash) = 19780211;
+        {
+          (hash) = (hash) + (kbuf)[_DP_i];
+        }
+      (hash) = ((hash) * 43321879) & 0x7FFFFFFF;
+    }
+  while (off != 0)
+    {
+      if (hash > thash) {}
+      else if (hash < thash)
+        {
+          off = head[2];
+        }
+    }
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.c-torture/compile/pr30984.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.c-torture/compile/pr30984.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.c-torture/compile/pr30984.c	(revision 124164)
@@ -0,0 +1,7 @@
+int fs_exec(int ino)
+{
+ void *src = 0;
+ if (ino)
+   src = (void*)0xe000;
+ goto *src;
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.c-torture/compile/20070419-1.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.c-torture/compile/20070419-1.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.c-torture/compile/20070419-1.c	(revision 124164)
@@ -0,0 +1,17 @@
+/* PR tree-optimization/31632 */
+
+struct S
+{
+  long int l;
+  void *m;
+};
+
+int
+foo (struct S *x)
+{
+  unsigned long a;
+  a = x->l;
+  if (a <= ((void *) 0))
+    x->m = 0;
+  return 0;
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.target/arm/register-variables.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.target/arm/register-variables.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.target/arm/register-variables.c	(revision 124164)
@@ -0,0 +1,21 @@
+/* { dg-do run } */
+/* { dg-options "-O" } */
+
+#include <stdlib.h>
+
+void __attribute__((noinline)) 
+bar(int a, int b)
+{
+  if (a != 43 || b != 42)
+    abort();
+}
+
+int main(void)
+{
+    register int r0 asm("r0") = 42;
+    register int r1 asm("r1") = 43;
+    asm volatile("": "+r" (r0), "+r" (r1));
+    bar(r1, r0);
+    return 0;
+}
+
Index: gcc-4_2-branch/gcc/testsuite/gcc.target/i386/ordcmp-1.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.target/i386/ordcmp-1.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.target/i386/ordcmp-1.c	(revision 124164)
@@ -0,0 +1,36 @@
+/* { dg-do compile { target i?86-*-* x86_64-*-* } } */
+/* { dg-options "-O2 -msse2" } */
+/* { dg-final { scan-assembler "cmpordss" } } */
+/* { dg-final { scan-assembler "cmpordps" } } */
+/* { dg-final { scan-assembler "cmpordsd" } } */
+/* { dg-final { scan-assembler "cmpordpd" } } */
+/* { dg-final { scan-assembler-not "cmpunordss" } } */
+/* { dg-final { scan-assembler-not "cmpunordps" } } */
+/* { dg-final { scan-assembler-not "cmpunordsd" } } */
+/* { dg-final { scan-assembler-not "cmpunordpd" } } */
+
+#include <emmintrin.h>
+
+__m128
+f1 (__m128 x, __m128 y)
+{
+  return _mm_cmpord_ss (x, y);
+}
+
+__m128
+f2 (__m128 x, __m128 y)
+{
+  return _mm_cmpord_ps (x, y);
+}
+
+__m128d
+f3 (__m128d x, __m128d y)
+{
+  return _mm_cmpord_sd (x, y);
+}
+
+__m128d
+f4 (__m128d x, __m128d y)
+{
+  return _mm_cmpord_pd (x, y);
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.target/i386/unordcmp-1.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.target/i386/unordcmp-1.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.target/i386/unordcmp-1.c	(revision 124164)
@@ -0,0 +1,36 @@
+/* { dg-do compile { target i?86-*-* x86_64-*-* } } */
+/* { dg-options "-O2 -msse2" } */
+/* { dg-final { scan-assembler "cmpunordss" } } */
+/* { dg-final { scan-assembler "cmpunordps" } } */
+/* { dg-final { scan-assembler "cmpunordsd" } } */
+/* { dg-final { scan-assembler "cmpunordpd" } } */
+/* { dg-final { scan-assembler-not "cmpordss" } } */
+/* { dg-final { scan-assembler-not "cmpordps" } } */
+/* { dg-final { scan-assembler-not "cmpordsd" } } */
+/* { dg-final { scan-assembler-not "cmpordpd" } } */
+
+#include <emmintrin.h>
+
+__m128
+f1 (__m128 x, __m128 y)
+{
+  return _mm_cmpunord_ss (x, y);
+}
+
+__m128
+f2 (__m128 x, __m128 y)
+{
+  return _mm_cmpunord_ps (x, y);
+}
+
+__m128d
+f3 (__m128d x, __m128d y)
+{
+  return _mm_cmpunord_sd (x, y);
+}
+
+__m128d
+f4 (__m128d x, __m128d y)
+{
+  return _mm_cmpunord_pd (x, y);
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.target/i386/pr30505.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.target/i386/pr30505.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.target/i386/pr30505.c	(revision 124164)
@@ -0,0 +1,19 @@
+/* PR inline-asm/30505 */
+/* { dg-do compile { target ilp32 } } */
+/* { dg-options "-O2" } */
+
+unsigned long long a, c;
+unsigned int b, d;
+
+void
+test ()
+{
+  unsigned int e, f;
+
+  __asm__ ("divl %5;movl %1, %0;movl %4, %1;divl %5"
+	   : "=&rm" (e), "=a" (f), "=d" (d)
+	   : "1" ((unsigned int) (a >> 32)), "g" ((unsigned int) a),
+	     "rm" (b), "2" (0)
+	   : "cc");
+  c = (unsigned long long) e << 32 | f;
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.dg/gomp/pr25874.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.dg/gomp/pr25874.c	(revision 123014)
+++ gcc-4_2-branch/gcc/testsuite/gcc.dg/gomp/pr25874.c	(revision 124164)
@@ -1,3 +1,5 @@
+/* { dg-options "-O -fopenmp" } */
+
 void foo();
 
 inline void bar()
Index: gcc-4_2-branch/gcc/testsuite/gcc.dg/pr30762-2.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.dg/pr30762-2.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.dg/pr30762-2.c	(revision 124164)
@@ -0,0 +1,9 @@
+/* PR c/30762 */
+/* { dg-do compile } */
+
+typedef struct { int i; } D;
+
+void
+foo (D x)
+{
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.dg/tree-ssa/loadpre1.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.dg/tree-ssa/loadpre1.c	(revision 123014)
+++ gcc-4_2-branch/gcc/testsuite/gcc.dg/tree-ssa/loadpre1.c	(revision 124164)
@@ -14,5 +14,5 @@
   e = *a;
   return d + e;
 }
-/* { dg-final { scan-tree-dump-times "Eliminated: 1" 1 "pre"} } */
+/* { dg-final { scan-tree-dump-times "Eliminated: 1" 1 "pre" { xfail *-*-* } } } */
 /* { dg-final { cleanup-tree-dump "pre" } } */
Index: gcc-4_2-branch/gcc/testsuite/gcc.dg/tree-ssa/loadpre14.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.dg/tree-ssa/loadpre14.c	(revision 123014)
+++ gcc-4_2-branch/gcc/testsuite/gcc.dg/tree-ssa/loadpre14.c	(revision 124164)
@@ -15,5 +15,5 @@
   e = (*a)[0];
   return d + e;
 }
-/* { dg-final { scan-tree-dump-times "Eliminated: 1" 1 "pre"} } */
+/* { dg-final { scan-tree-dump-times "Eliminated: 1" 1 "pre" { xfail *-*-* } } } */
 /* { dg-final { cleanup-tree-dump "pre" } } */
Index: gcc-4_2-branch/gcc/testsuite/gcc.dg/tree-ssa/loadpre15.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.dg/tree-ssa/loadpre15.c	(revision 123014)
+++ gcc-4_2-branch/gcc/testsuite/gcc.dg/tree-ssa/loadpre15.c	(revision 124164)
@@ -15,5 +15,5 @@
   e = (*a)[t];
   return d + e;
 }
-/* { dg-final { scan-tree-dump-times "Eliminated: 1" 1 "pre"} } */
+/* { dg-final { scan-tree-dump-times "Eliminated: 1" 1 "pre" { xfail *-*-* } } } */
 /* { dg-final { cleanup-tree-dump "pre" } } */
Index: gcc-4_2-branch/gcc/testsuite/gcc.dg/invalid-call-1.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.dg/invalid-call-1.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.dg/invalid-call-1.c	(revision 124164)
@@ -0,0 +1,17 @@
+/* PR rtl-optimization/29841 */
+/* Testcase by Khem Raj <raj.khem@gmail.com> */
+
+/* { dg-do compile } */
+/* { dg-options "-O2" } */
+/* { dg-options "-O2 -mtune=i586" { target i?86-*-* } } */
+
+typedef void (*fp)(void);
+extern char* bar(void* a1, int a2);
+extern char* mar(int n);
+char* cptr;
+
+void foo()
+{
+  cptr = mar(6);
+  ((char *(*)(void *,int (*)(void *,unsigned char **),char**))((fp)bar))(0,0,(void*)(0)); /* { dg-warning "" "non-compatible type" } */
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.dg/gnu89-init-4.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.dg/gnu89-init-4.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.dg/gnu89-init-4.c	(revision 124164)
@@ -0,0 +1,12 @@
+/* Test for GNU extensions to compound literals are giving the correct array bounds */
+/* { dg-do compile } */
+/* { dg-options "-std=gnu89 -W -Wall -O2" } */
+
+int a[] = (int[4]){1, 1, 2};
+int f(void)
+{
+  int sum = 0; int i;
+  for(i = 0;i<4;i++)
+    sum = a[i];
+  return sum;
+}
Index: gcc-4_2-branch/gcc/testsuite/gcc.dg/darwin-comm.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.dg/darwin-comm.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.dg/darwin-comm.c	(revision 124164)
@@ -0,0 +1,4 @@
+/* { dg-do compile { target *-*-darwin9* } } */
+/* { dg-final { scan-assembler ".comm _foo,1,15" } } */
+
+char foo __attribute__ ((aligned(32768)));
Index: gcc-4_2-branch/gcc/testsuite/gcc.dg/pr30762-1.c
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gcc.dg/pr30762-1.c	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gcc.dg/pr30762-1.c	(revision 124164)
@@ -0,0 +1,15 @@
+/* PR c/30762 */
+/* { dg-do compile } */
+/* { dg-options "--combine -O3" } */
+/* { dg-additional-sources pr30762-2.c } */
+
+typedef struct { int i; } D;
+extern void foo (D);
+
+void
+bar (void)
+{
+  D d;
+  d.i = 1;
+  foo (d);
+}
Index: gcc-4_2-branch/gcc/testsuite/ChangeLog
===================================================================
--- gcc-4_2-branch/gcc/testsuite/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/gcc/testsuite/ChangeLog	(revision 124164)
@@ -1,3 +1,164 @@
+2007-04-24  Paolo Carlini  <pcarlini@suse.de>
+
+	PR c++/30500
+	* g++.dg/warn/pragma-system_header3.C: New test.
+	* g++.dg/warn/pragma-system_header3.h. New.
+
+2007-04-24  Ian Lance Taylor  <iant@google.com>
+
+	PR tree-optimization/31605
+	* gcc.c-torture/execute/pr31605.c: New test.
+
+2007-04-24  Andreas Krebbel  <krebbel1@de.ibm.com>
+
+	PR target/31641
+	* gcc.c-torture/compile/pr31641.c: New testcase.
+
+2007-04-22  Andrew Pinski  <andrew_pinski@playstation.sony.com>
+
+	PR middle-end/31448
+	* gcc.c-torture/execute/pr31448.c: New testcase.
+
+2007-04-21  Richard Guenther  <rguenther@suse.de>
+
+	PR middle-end/31136
+	* gcc.c-torture/execute/pr31136.c: New testcase.
+
+2007-04-20  Jakub Jelinek  <jakub@redhat.com>
+
+	* gcc.target/i386/ordcmp-1.c: New test.
+	* gcc.target/i386/unordcmp-1.c: New test.
+
+	PR tree-optimization/31632
+	* gcc.c-torture/compile/20070419-1.c: New test.
+
+2007-04-19  Eric Botcazou  <ebotcazou@libertysurf.fr>
+
+	* gcc.dg/invalid-call-1.c: New test.
+
+2007-04-17  Jerry DeLisle  <jvdelisle@gcc.gnu.org>
+
+	PR libgfortran/31366
+	* gfortran.dg/direct_io_6.f90: New test.
+
+2007-04-17  Simon Martin  <simartin@users.sourceforge.net>
+
+	PR c++/31517
+	* g++.dg/template/init7.C: New test.
+
+2007-04-16  Mark Mitchell  <mark@codesourcery.com>
+
+	PR c++/31513
+	* g++.dg/expr/bitfield8.C: New test.
+
+2007-04-14  Andrew Pinski  <andrew_pinski@playstation.sony.com>
+
+	PR testsuite/31578
+	* gcc.dg/gnu89-init-4.c: Change to a compile only test.
+
+2007-04-14  Andrew Pinski  <andrew_pinski@playstation.sony.com>
+
+	PR C/31520
+	* gcc.dg/gnu89-init-4.c: New testcase.
+
+2007-04-14  Jakub Jelinek  <jakub@redhat.com>
+
+	PR c++/25874
+	* gcc.dg/gomp/pr25874.c: Add dg-options.
+	* g++.dg/gomp/pr25874.C: Add dg-options.
+
+2007-04-13  Jason Merrill  <jason@redhat.com>
+
+	PR c++/31074
+	* conv3.C: New test.
+
+2007-04-13  Joseph Myers  <joseph@codesourcery.com>
+
+	PR tree-optimization/29598
+	* gcc.dg/tree-ssa/loadpre1.c, gcc.dg/tree-ssa/loadpre14.c,
+	gcc.dg/tree-ssa/loadpre15.c: XFAIL.
+
+2007-04-10  Mike Stump  <mrs@apple.com>
+
+	* g++.dg/tree-ssa/pr29585.C: Don't die on an expected warning.
+
+2007-04-09  Mark Mitchell  <mark@codesourcery.com>
+
+	PR c++/31449
+	* g++.dg/init/const5.C: New test.
+
+2007-04-03  Eric Christopher  <echristo@apple.com>
+
+	* g++.dg/tree-ssa/pr29902.C: Require ilp32.
+
+2007-04-03  Stuart Hastings  <stuart@apple.com>
+
+	PR 31281
+	* testsuite/objc/execute/exceptions/pr31281.m: New.
+
+2007-04-03  Jakub Jelinek  <jakub@redhat.com>
+
+	PR c++/30847
+	* g++.dg/parse/cond3.C: New test.
+
+	PR middle-end/30704
+	* gcc.c-torture/execute/ieee/pr30704.c: New test.
+
+2007-04-02  Jason Merrill  <jason@redhat.com>
+
+	PR c++/31187
+	* g++.dg/ext/visibility/anon3.C: New test.
+
+2007-03-31  Diego Novillo  <dnovillo@redhat.com>
+
+	PR 29585
+	* g++.dg/tree-ssa/pr29585.C: New test.
+
+2007-03-30  Kazu Hirata  <kazu@codesourcery.com>
+
+	* gcc.c-torture/execute/mayalias-2.x: New.
+
+2007-03-28  Mike Stump  <mrs@apple.com>
+
+	* gcc.dg/darwin-comm.c: Add.
+
+2007-03-26  Ian Lance Taylor  <iant@google.com>
+
+	PR tree-optimization/31345
+	* gcc.c-torture/compile/pr31345-1.c: New test.
+
+2007-03-22  Mark Mitchell  <mark@codesourcery.com>
+
+	PR c++/30863
+	* g++.dg/template/error24.C: New test.
+	* g++.dg/parse/tmpl-outside1.C: Tweak error markers.
+
+	PR c++/31273
+	* g++.dg/expr/bitfield7.C: New test.
+
+2007-03-20  Seongbae Park <seongbae.park@gmail.com>
+
+	PR tree-optimization/30590
+	* g++.dg/opt/pr30590.C: New testcase.
+
+2007-03-20  Jakub Jelinek  <jakub@redhat.com>
+
+	PR c/30762
+	* gcc.dg/pr30762-1.c: New test.
+	* gcc.dg/pr30762-2.c: New test.
+
+	PR inline-asm/30505
+	* gcc.target/i386/pr30505.c: New test.
+
+2007-03-19  Mark Shinwell  <shinwell@codesourcery.com>
+
+	* gcc.target/arm/register-variables.c: New.
+
+2007-03-19  Jeff Law  <law@redhat.com>
+
+	* PR tree-optimization/30984
+	* gcc.c-torture/pr30984.c: New test.
+
 2007-03-16  Alexandre Oliva  <aoliva@redhat.com>
 
 	PR debug/29906
@@ -123,12 +284,12 @@
 	PR rtl-optimization/30643
 	* gcc.dg/pr30643.c: New.
 
-2007-03-09  Andrew Pinski  <andrew_pinski@playstation.sony.com> 
+2007-03-09  Andrew Pinski  <andrew_pinski@playstation.sony.com>
 
 	PR tree-opt/30045
 	* gcc.dg/pr30045.c: New test.
 
-2007-03-09  Andrew Pinski  <andrew_pinski@playstation.sony.com> 
+2007-03-09  Andrew Pinski  <andrew_pinski@playstation.sony.com>
 
 	PR middle-end/30729
 	* gcc.dg/Wunused-value-2.c: New testcase.
@@ -163,7 +324,7 @@
 2007-03-08  Brooks Moses  <brooks.moses@codesourcery.com>
 
 	Backport from trunk.
-	* gfortran.dg/gomp/reduction1.f90: Add -fmax-errors=100 to 
+	* gfortran.dg/gomp/reduction1.f90: Add -fmax-errors=100 to
 	dg-options.
 
 2007-03-08  Paul Thomas  <pault@gcc.gnu.org>
@@ -216,7 +377,7 @@
 	* gcc.dg/Wstring-literal-comparison-4.c: Likewise.
 	* g++.dg/warn/Wstring-literal-comparison-1.C: Likewise.
 	* g++.dg/warn/Wstring-literal-comparison-4.c: Likewise.
-	
+
 2007-03-06  Roger Sayle  <roger@eyesopen.com>
 
 	PR middle-end/30744
@@ -315,7 +476,7 @@
 
 2007-02-23  Jerry DeLisle  <jvdelisle@gcc.gnu.org>
 
-	PR libgfortran/30910	
+	PR libgfortran/30910
 	* gfortran.dg/fmt_zero_precision.f90: Update test.
 
 2007-02-23  Tobias Burnus  <burnus@net-b.de>
@@ -404,7 +565,7 @@
 2007-02-16  Francois-Xavier Coudert  <coudert@clipper.ens.fr>
 
 	PR fortran/30611
-	* gcc/testsuite/gfortran.dg/repeat_1.f90: New test.
+	* gfortran.dg/repeat_1.f90: New test.
 
 2007-02-16  Thomas Koenig  <Thomas.Koenig@online.de>
 
@@ -480,7 +641,7 @@
 
 2007-02-07  Hans-Peter Nilsson  <hp@axis.com>
 
-	* lib/target-supports.exp (check_effective_target_simulator): New. 
+	* lib/target-supports.exp (check_effective_target_simulator): New.
 
 2007-02-05  Alexandre Oliva  <aoliva@redhat.com>
 
@@ -614,7 +775,7 @@
 
 	PR fortran/30532
 	* gfortran.dg/ctrl-z.f90:  New test.
-	
+
 2007-01-26  Jerry DeLisle  <jvdelisle@gcc.gnu.org>
 
 	PR fortran/30481
@@ -1319,7 +1480,7 @@
 2006-11-13  Francois-Xavier Coudert  <coudert@clipper.ens.fr>
 
 	PR libfortran/27895
-	* gcc/testsuite/gfortran.dg/zero_sized_1.f90: Uncomment checks
+	* gfortran.dg/zero_sized_1.f90: Uncomment checks
 	for RESHAPE.
 
 2006-11-13  Mark Mitchell  <mark@codesourcery.com>
@@ -1753,16 +1914,16 @@
 2006-10-13  Francois-Xavier Coudert  <coudert@clipper.ens.fr>
 
 	PR fortran/21435
-	* gcc/testsuite/gfortran.dg/io_constraints_3.f90: New test.
-	* gcc/testsuite/gfortran.dg/open_access_append_1.f90: Add checks
+	* gfortran.dg/io_constraints_3.f90: New test.
+	* gfortran.dg/open_access_append_1.f90: Add checks
 	for compile-time warnings.
-	* gcc/testsuite/gfortran.dg/pr20163-2.f: Likewise.
-	* gcc/testsuite/gfortran.dg/iostat_2.f90: Likewise.
-	* gcc/testsuite/gfortran.dg/label_4.f90: Delete the temporary
+	* gfortran.dg/pr20163-2.f: Likewise.
+	* gfortran.dg/iostat_2.f90: Likewise.
+	* gfortran.dg/label_4.f90: Delete the temporary
 	file.
-	* gcc/testsuite/gfortran.dg/direct_io_2.f90: Add a FILE=
+	* gfortran.dg/direct_io_2.f90: Add a FILE=
 	specifier.
-	* gcc/testsuite/gfortran.dg/iomsg_1.f90: Add check for
+	* gfortran.dg/iomsg_1.f90: Add check for
 	compile-time warning.
 
 2006-10-12  Jan Hubicka  <jh@suse.cz>
@@ -1899,12 +2060,12 @@
 
 	PR fortran/16580
 	PR fortran/29288
-	* gcc/testsuite/gfortran.fortran-torture/execute/specifics.f90:
+	* gfortran.fortran-torture/execute/specifics.f90:
 	Add tests for using all possible intrinsics as actual arguments.
-	* gcc/testsuite/gfortran.dg/specifics_1.f90: Add tests for using
+	* gfortran.dg/specifics_1.f90: Add tests for using
 	all possible intrinsics as actual arguments.
-	* gcc/testsuite/gfortran.dg/specifics_2.f90: New file.
-	* gcc/testsuite/gfortran.dg/specifics_3.f90: New file.
+	* gfortran.dg/specifics_2.f90: New file.
+	* gfortran.dg/specifics_3.f90: New file.
 
 2006-10-07  Richard Sandiford  <richard@codesourcery.com>
 
@@ -4158,7 +4319,7 @@
 2006-06-08  Francois-Xavier Coudert  <coudert@clipper.ens.fr>
 
 	PR fortran/27958
-	* gcc/testsuite/gfortran.dg/substr_2.f: New test.
+	* gfortran.dg/substr_2.f: New test.
 
 2006-06-08  Asher Langton  <langton2@llnl.gov>
 
@@ -6195,7 +6356,7 @@
 
 2006-03-03  Paul Brook  <paul@codesourcery.com>
 
-	* gcc/testsuite/lib/target-supports.exp (check_profiling_available):
+	* lib/target-supports.exp (check_profiling_available):
 	Add m68k-*-elf.
 
 2006-03-03  Thomas Koenig  <Thomas.Koenig@online.de>
@@ -9951,11 +10112,11 @@
 2005-11-04  Francois-Xavier Coudert  <coudert@clipper.ens.fr>
 
 	PR libfortran/22298
-	* gcc/testsuite/lib/target-supports.exp
+	* lib/target-supports.exp
 	(check_effective_target_static_libgfortran): New
 	static_libgfortran effective target.
-	* gcc/testsuite/gfortran.dg/static_linking_1.f: New test.
-	* gcc/testsuite/gfortran.dg/static_linking_1.c: New file.
+	* gfortran.dg/static_linking_1.f: New test.
+	* gfortran.dg/static_linking_1.c: New file.
 
 2005-11-04  Hans-Peter Nilsson  <hp@axis.com>
 
@@ -17467,7 +17628,7 @@
 2005-02-11  Jakub Jelinek  <jakub@redhat.com>
 
 	PR c++/19666
-	* gcc/testsuite/g++.dg/other/ptrmem6.C: New test.
+	* g++.dg/other/ptrmem6.C: New test.
 
 	PR middle-end/19858
 	* gcc.c-torture/compile/20050210-1.c: New test.
@@ -33085,33 +33246,33 @@
 
 2003-01-16  Mark Mitchell  <mark@codesourcery.com>
 
-	* gcc/testsuite/g++.dg/ext/typename1.C: Add typename keyword.
-	* gcc/testsuite/g++.dg/template/crash1.C: Update error messages.
-	* gcc/testsuite/g++.dg/template/crash2.C: Remove error message.
-	* gcc/testsuite/g++.dg/parse/typename2.C: New test.
-	* gcc/testsuite/g++.dg/template/typename2.C: Change implicit
+	* g++.dg/ext/typename1.C: Add typename keyword.
+	* g++.dg/template/crash1.C: Update error messages.
+	* g++.dg/template/crash2.C: Remove error message.
+	* g++.dg/parse/typename2.C: New test.
+	* g++.dg/template/typename2.C: Change implicit
 	typename warning into error.
-	* gcc/testsuite/g++.old-deja/g++.benjamin/tem03.C: Issue more
+	* g++.old-deja/g++.benjamin/tem03.C: Issue more
 	error messages.
-	* gcc/testsuite/g++.old-deja/g++.benjamin/tem04.C: Fix typos.
-	* gcc/testsuite/g++.old-deja/g++.brendan/crash56.C: Add this->.
-	* gcc/testsuite/g++.old-deja/g++.law/visibility13.C: Remove error
+	* g++.old-deja/g++.benjamin/tem04.C: Fix typos.
+	* g++.old-deja/g++.brendan/crash56.C: Add this->.
+	* g++.old-deja/g++.law/visibility13.C: Remove error
 	messages.
-	* gcc/testsuite/g++.old-deja/g++.ns/template17.C: Reorder code to
+	* g++.old-deja/g++.ns/template17.C: Reorder code to
 	make declaration visible in template.
-	* gcc/testsuite/g++.old-deja/g++.pt/crash3.C: Fix typos.
-	* gcc/testsuite/g++.old-deja/g++.pt/crash36.C: Issue more error
+	* g++.old-deja/g++.pt/crash3.C: Fix typos.
+	* g++.old-deja/g++.pt/crash36.C: Issue more error
 	messages.
-	* gcc/testsuite/g++.old-deja/g++.pt/crash5.C: Improve error
+	* g++.old-deja/g++.pt/crash5.C: Improve error
 	message.
-	* gcc/testsuite/g++.old-deja/g++.pt/crash67.C: Remove warning.
-	* gcc/testsuite/g++.old-deja/g++.pt/inherit1.C: Add this->.
-	* gcc/testsuite/g++.old-deja/g++.pt/niklas01a.C: Add error message.
-	* gcc/testsuite/g++.old-deja/g++.pt/typename16.C: Replace implicit
+	* g++.old-deja/g++.pt/crash67.C: Remove warning.
+	* g++.old-deja/g++.pt/inherit1.C: Add this->.
+	* g++.old-deja/g++.pt/niklas01a.C: Add error message.
+	* g++.old-deja/g++.pt/typename16.C: Replace implicit
 	typename warning with error message.
-	* gcc/testsuite/g++.old-deja/g++.pt/typename19.C: Remove warning.
-	* gcc/testsuite/g++.old-deja/g++.robertl/eb112.C: Fix typo.
-	* gcc/testsuite/g++.old-deja/g++.robertl/eb24.C: Use this->.
+	* g++.old-deja/g++.pt/typename19.C: Remove warning.
+	* g++.old-deja/g++.robertl/eb112.C: Fix typo.
+	* g++.old-deja/g++.robertl/eb24.C: Use this->.
 
 2003-01-16  Nathan Sidwell  <nathan@codesourcery.com>
 
@@ -34702,9 +34863,9 @@
 
 2002-09-25  Mark Mitchell  <mark@codesourcery.com>
 
-	* gcc/testsuite/g++.dg/abi/empty5.C: New test.
-	* gcc/testsuite/g++.dg/abi/empty6.C: New test.
-	* gcc/testsuite/g++.dg/abi/vbase12.C: New test.
+	* g++.dg/abi/empty5.C: New test.
+	* g++.dg/abi/empty6.C: New test.
+	* g++.dg/abi/vbase12.C: New test.
 
 2002-09-25  Richard Henderson  <rth@redhat.com>
 
@@ -35726,7 +35887,7 @@
 
 2002-05-23  Mark Mitchell  <mark@codesourcery.com>
 
-	* gcc/testsuite/gcc.dg/weak-8.c: New test.
+	* gcc.dg/weak-8.c: New test.
 
 2002-05-23  J"orn Rennecke <joern.rennecke@superh.com>
 
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/tree-ssa/pr29585.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/tree-ssa/pr29585.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/tree-ssa/pr29585.C	(revision 124164)
@@ -0,0 +1,15 @@
+/* { dg-do compile } */
+/* { dg-options "-O2 -w" } */
+
+class ios_base{};
+struct basic_ostream : virtual ios_base{};
+namespace
+{
+  struct Nullostream : basic_ostream{};
+}
+class  In
+{
+  In ();
+  Nullostream  nullout;
+};
+In::In (){}
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/tree-ssa/pr29902.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/tree-ssa/pr29902.C	(revision 123014)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/tree-ssa/pr29902.C	(revision 124164)
@@ -1,5 +1,6 @@
 /* { dg-do compile { target i?86-*-* } } */
 /* { dg-options "-O1 -fprefetch-loop-arrays -march=athlon" } */
+/* { dg-require-effective-target ilp32 } */
 
 int length1();
 int g(int);
@@ -16,4 +17,3 @@
       for (int i = 1; i < capacity_; i++){old_storage[i] = 0;}
   }
 }
-
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/ext/visibility/anon3.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/ext/visibility/anon3.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/ext/visibility/anon3.C	(revision 124164)
@@ -0,0 +1,16 @@
+// PR c++/31187
+// Bug: the repeated declaration was confusing the compiler into
+// thinking that foo1 had language internal linkage.
+
+class foo { };
+
+namespace
+{
+  extern foo foo1;
+  foo foo1;
+}
+
+template< foo * >
+class bar { };
+
+bar< &foo1 > bar1;
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/inherit/conv3.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/inherit/conv3.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/inherit/conv3.C	(revision 124164)
@@ -0,0 +1,31 @@
+// PR 31074
+// Bug: The reference cast wasn't finding the desired static_cast followed by
+// const_cast interpretation.
+
+struct Shape
+{
+  Shape() {}
+  virtual ~Shape() {}
+};
+
+struct Loop
+{
+  Loop() {}
+  virtual ~Loop() {}
+  virtual void func() {}
+};
+
+struct Rect :
+  public Shape,
+  public Loop
+{
+  Rect() {}
+  virtual ~Rect() {}
+};
+
+int main ()
+{
+  const Rect* rect = new Rect();
+  Loop &l = ((Loop&)(*rect));
+  return (&l != (const Loop *)rect);
+}
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/gomp/pr25874.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/gomp/pr25874.C	(revision 123014)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/gomp/pr25874.C	(revision 124164)
@@ -1,3 +1,5 @@
+// { dg-options "-O -fopenmp" }
+
 int foo();
 
 struct wigner_d
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/opt/pr30590.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/opt/pr30590.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/opt/pr30590.C	(revision 124164)
@@ -0,0 +1,40 @@
+/* { dg-do run } */
+/* { dg-options "-O" } */
+struct test
+{
+  int type;
+  char buffer[4242]; /* should trigger pass-by-reference */
+};
+
+int flag = 0;
+
+struct test
+reset (void)
+{
+  struct test retval;
+  retval.type = 1;
+  return retval;
+}
+
+struct test
+test (void)
+{
+  struct test result;
+  result.type = 0;
+
+  for (int i = 0; i < 2; ++i)
+    {
+      struct test candidate = reset ();
+      if (flag)
+        result = candidate;
+    }
+
+  return result;
+}
+
+int
+main (void)
+{
+  struct test result = test ();
+  return result.type;
+}
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/init/const5.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/init/const5.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/init/const5.C	(revision 124164)
@@ -0,0 +1,11 @@
+// PR c++/31449
+
+class Foo {};
+class Bar : public Foo {};
+static const Foo *foo = 0;
+
+static Bar *bar = static_cast<const Bar*>(foo); // { dg-error "conversion" }
+
+void func(const Foo *foo) {
+  Bar *bar = static_cast<const Bar*>(foo);  // { dg-error "conversion" }
+}
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/warn/pragma-system_header3.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/warn/pragma-system_header3.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/warn/pragma-system_header3.C	(revision 124164)
@@ -0,0 +1,10 @@
+// PR c++/30500
+// { dg-options "-Wcast-align" }
+
+#include "pragma-system_header3.h"
+
+void f()
+{
+  g<int>();
+  h<int>();
+}
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/warn/pragma-system_header3.h
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/warn/pragma-system_header3.h	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/warn/pragma-system_header3.h	(revision 124164)
@@ -0,0 +1,7 @@
+#pragma GCC system_header
+
+template <typename T>
+  int* g() { static char c; return reinterpret_cast<int*>(&c); }
+
+template <typename T>
+  T* h() { static char c; return reinterpret_cast<T*>(&c); }
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/parse/cond3.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/parse/cond3.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/parse/cond3.C	(revision 124164)
@@ -0,0 +1,15 @@
+// PR c++/30847
+// { dg-do compile }
+// { dg-options "" }
+
+int j, k, l;
+extern void baz ();
+
+void
+foo (int i)
+{
+  (i ? j : k) = ({ l++; (void) l; });	// { dg-error "void value not ignored" }
+  (i ? j : k) += ({ l++; (void) l; });	// { dg-error "void value not ignored" }
+  (i ? j : k) = baz ();			// { dg-error "void value not ignored" }
+  (i ? j : k) *= baz ();		// { dg-error "void value not ignored" }
+}
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/parse/tmpl-outside1.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/parse/tmpl-outside1.C	(revision 123014)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/parse/tmpl-outside1.C	(revision 124164)
@@ -7,5 +7,4 @@
    template <int i> struct Y {};
 };
 
-typedef X::template Y<0> y; // { dg-error "template" }
-// { dg-bogus "with no type" "" { xfail *-*-* } 10 }
+typedef X::template Y<0> y; // { dg-error "template|invalid" }
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/template/error24.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/template/error24.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/template/error24.C	(revision 124164)
@@ -0,0 +1,8 @@
+// PR c++/30863
+
+template <typename T>
+struct s {};
+
+void f() {
+  unsigned s<int> x; // { dg-error "invalid" }
+}
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/template/init7.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/template/init7.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/template/init7.C	(revision 124164)
@@ -0,0 +1,9 @@
+/* PR c++/31517. This used to ICE.  */
+/* { dg-do "compile" } */
+
+template<typename> struct A
+{
+  static const int i=0;
+};
+
+template<typename T> const int A<T>::i = 0=0; /* { dg-error "duplicate initialization" } */
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/expr/bitfield7.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/expr/bitfield7.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/expr/bitfield7.C	(revision 124164)
@@ -0,0 +1,8 @@
+// PR c++/31273
+
+enum E { e };
+struct S {
+  E v:5;
+};
+S s;
+int main() { if (!s.v) return 0; }
Index: gcc-4_2-branch/gcc/testsuite/g++.dg/expr/bitfield8.C
===================================================================
--- gcc-4_2-branch/gcc/testsuite/g++.dg/expr/bitfield8.C	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/g++.dg/expr/bitfield8.C	(revision 124164)
@@ -0,0 +1,24 @@
+// PR c++/31513
+// { dg-do run }
+
+extern "C" void abort();
+
+struct tree_type {
+  unsigned int precision : 9;
+};
+
+void bork(unsigned int i) {
+  if (i != 7)
+    abort();
+}
+
+void foo(struct tree_type *t)
+{
+  bork(t->precision);
+}
+
+int main() {
+  tree_type t;
+  t.precision = 7;
+  foo(&t);
+}
Index: gcc-4_2-branch/gcc/testsuite/gfortran.dg/direct_io_6.f90
===================================================================
--- gcc-4_2-branch/gcc/testsuite/gfortran.dg/direct_io_6.f90	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/gfortran.dg/direct_io_6.f90	(revision 124164)
@@ -0,0 +1,16 @@
+! { dg-do run }
+! pr31366 last record truncated for read after short write, direct access file.
+! test case derived from pr, submitted by jerry delisle  <jvdelisle@gcc.gnu.org
+      program test
+      character(len=8) :: as_written, as_read
+      character(1) :: byte
+      as_written = "12345678"
+      open (76, access="direct", recl=12, status="scratch")
+      write(76, rec=1) as_written
+      write(76, rec=2) as_written
+      read(76, rec=1) as_read, byte, byte, byte, byte
+      read(76, rec=2, err=3) as_read, byte, byte, byte, byte
+      stop
+  3   call abort()
+      end program test
+
Index: gcc-4_2-branch/gcc/testsuite/objc/execute/exceptions/pr31281.m
===================================================================
--- gcc-4_2-branch/gcc/testsuite/objc/execute/exceptions/pr31281.m	(revision 0)
+++ gcc-4_2-branch/gcc/testsuite/objc/execute/exceptions/pr31281.m	(revision 124164)
@@ -0,0 +1,27 @@
+/* From PR31281.  */
+extern void abort (void);
+int __attribute__((noinline))
+f(unsigned int i)
+{
+  int j, k;
+  @try { } @catch(id) { return 13; }
+  for (j=0; j<i; j++)
+    for (k=0; k<i; k++)
+      {
+        @try {
+          if (i)
+            break;
+        } @catch(id) { }
+        return 9;
+      }
+  return 0;
+}
+
+
+int
+main()
+{
+  if (f(1))
+    abort ();
+  return 0 ;
+}
Index: gcc-4_2-branch/gcc/cp/typeck.c
===================================================================
--- gcc-4_2-branch/gcc/cp/typeck.c	(revision 123014)
+++ gcc-4_2-branch/gcc/cp/typeck.c	(revision 124164)
@@ -5614,6 +5614,12 @@
 	tree cond;
 	tree preeval = NULL_TREE;
 
+	if (VOID_TYPE_P (TREE_TYPE (rhs)))
+	  {
+	    error ("void value not ignored as it ought to be");
+	    return error_mark_node;
+	  }
+
 	rhs = stabilize_expr (rhs, &preeval);
 
 	/* Check this here to avoid odd errors when trying to convert
@@ -6795,6 +6801,16 @@
   return TYPE_QUALS (type);
 }
 
+/* Returns nonzero if the TYPE is const from a C++ perspective: look inside
+   arrays.  */
+
+bool
+cp_type_readonly (tree type)
+{
+  type = strip_array_types (type);
+  return TYPE_READONLY (type);
+}
+
 /* Returns nonzero if the TYPE contains a mutable member.  */
 
 bool
Index: gcc-4_2-branch/gcc/cp/class.c
===================================================================
--- gcc-4_2-branch/gcc/cp/class.c	(revision 123014)
+++ gcc-4_2-branch/gcc/cp/class.c	(revision 124164)
@@ -302,7 +302,18 @@
 	 field, because other parts of the compiler know that such
 	 expressions are always non-NULL.  */
       if (!virtual_access && integer_zerop (offset))
-	return build_nop (build_pointer_type (target_type), expr);
+	{
+	  tree class_type;
+	  /* TARGET_TYPE has been extracted from BINFO, and, is
+	     therefore always cv-unqualified.  Extract the
+	     cv-qualifiers from EXPR so that the expression returned
+	     matches the input.  */
+	  class_type = TREE_TYPE (TREE_TYPE (expr));
+	  target_type
+	    = cp_build_qualified_type (target_type,
+				       cp_type_quals (class_type));
+	  return build_nop (build_pointer_type (target_type), expr);
+	}
       null_test = error_mark_node;
     }
 
@@ -7101,7 +7112,13 @@
 
       /* Figure out the position to which the VPTR should point.  */
       vtbl = TREE_PURPOSE (l);
-      vtbl = build1 (ADDR_EXPR, vtbl_ptr_type_node, vtbl);
+      vtbl = build_address (vtbl);
+      /* ??? We should call fold_convert to convert the address to
+	 vtbl_ptr_type_node, which is the type of elements in the
+	 vtable.  However, the resulting NOP_EXPRs confuse other parts
+	 of the C++ front end.  */
+      gcc_assert (TREE_CODE (vtbl) == ADDR_EXPR);
+      TREE_TYPE (vtbl) = vtbl_ptr_type_node;
       index = size_binop (PLUS_EXPR,
 			  size_int (non_fn_entries),
 			  size_int (list_length (TREE_VALUE (l))));
Index: gcc-4_2-branch/gcc/cp/decl.c
===================================================================
--- gcc-4_2-branch/gcc/cp/decl.c	(revision 123014)
+++ gcc-4_2-branch/gcc/cp/decl.c	(revision 124164)
@@ -3815,6 +3815,7 @@
   tree decl;
   tree type, tem;
   tree context;
+  bool was_public;
 
   *pushed_scope_p = NULL_TREE;
 
@@ -3969,6 +3970,8 @@
 		 decl);
     }
 
+  was_public = TREE_PUBLIC (decl);
+
   /* Enter this declaration into the symbol table.  */
   tem = maybe_push_decl (decl);
 
@@ -3989,6 +3992,17 @@
       && !have_global_bss_p ())
     DECL_COMMON (tem) = 1;
 
+  if (TREE_CODE (tem) == VAR_DECL
+      && DECL_NAMESPACE_SCOPE_P (tem) && !TREE_PUBLIC (tem) && !was_public
+      && !DECL_THIS_STATIC (tem) && !DECL_ARTIFICIAL (tem))
+    {
+      /* This is a const variable with implicit 'static'.  Set
+	 DECL_THIS_STATIC so we can tell it from variables that are
+	 !TREE_PUBLIC because of the anonymous namespace.  */
+      gcc_assert (cp_type_readonly (TREE_TYPE (tem)));
+      DECL_THIS_STATIC (tem) = 1;
+    }
+
   if (!processing_template_decl && TREE_CODE (tem) == VAR_DECL)
     start_decl_1 (tem, initialized);
 
@@ -5301,14 +5315,6 @@
 	{
 	  layout_var_decl (decl);
 	  maybe_commonize_var (decl);
-	  if (DECL_NAMESPACE_SCOPE_P (decl) && !TREE_PUBLIC (decl)
-	      && !DECL_THIS_STATIC (decl) && !DECL_ARTIFICIAL (decl))
-	    {
-	      /* This is a const variable with implicit 'static'.  Set
-		 DECL_THIS_STATIC so we can tell it from variables that are
-		 !TREE_PUBLIC because of the anonymous namespace.  */
-	      DECL_THIS_STATIC (decl) = 1;
-	    }
 	}
 
       make_rtl_for_nonlocal_decl (decl, init, asmspec);
Index: gcc-4_2-branch/gcc/cp/call.c
===================================================================
--- gcc-4_2-branch/gcc/cp/call.c	(revision 123014)
+++ gcc-4_2-branch/gcc/cp/call.c	(revision 124164)
@@ -171,7 +171,7 @@
 	(struct z_candidate **, tree, tree, tree, tree, tree, int);
 static conversion *implicit_conversion (tree, tree, tree, bool, int);
 static conversion *standard_conversion (tree, tree, tree, bool, int);
-static conversion *reference_binding (tree, tree, tree, int);
+static conversion *reference_binding (tree, tree, tree, bool, int);
 static conversion *build_conv (conversion_kind, tree, conversion *);
 static bool is_subseq (conversion *, conversion *);
 static tree maybe_handle_ref_bind (conversion **);
@@ -613,18 +613,12 @@
   tcode = TREE_CODE (to);
 
   conv = build_identity_conv (from, expr);
-  if (fcode == FUNCTION_TYPE)
+  if (fcode == FUNCTION_TYPE || fcode == ARRAY_TYPE)
     {
-      from = build_pointer_type (from);
+      from = type_decays_to (from);
       fcode = TREE_CODE (from);
       conv = build_conv (ck_lvalue, from, conv);
     }
-  else if (fcode == ARRAY_TYPE)
-    {
-      from = build_pointer_type (TREE_TYPE (from));
-      fcode = TREE_CODE (from);
-      conv = build_conv (ck_lvalue, from, conv);
-    }
   else if (fromref || (expr && lvalue_p (expr)))
     {
       if (expr)
@@ -632,7 +626,10 @@
 	  tree bitfield_type;
 	  bitfield_type = is_bitfield_expr_with_lowered_type (expr);
 	  if (bitfield_type)
-	    from = strip_top_quals (bitfield_type);
+	    {
+	      from = strip_top_quals (bitfield_type);
+	      fcode = TREE_CODE (from);
+	    }
 	}
       conv = build_conv (ck_rvalue, from, conv);
     }
@@ -1085,10 +1082,11 @@
    purposes of reference binding.  For lvalue binding, either pass a
    reference type to FROM or an lvalue expression to EXPR.  If the
    reference will be bound to a temporary, NEED_TEMPORARY_P is set for
-   the conversion returned.  */
+   the conversion returned.  If C_CAST_P is true, this
+   conversion is coming from a C-style cast.  */
 
 static conversion *
-reference_binding (tree rto, tree rfrom, tree expr, int flags)
+reference_binding (tree rto, tree rfrom, tree expr, bool c_cast_p, int flags)
 {
   conversion *conv = NULL;
   tree to = TREE_TYPE (rto);
@@ -1118,6 +1116,11 @@
      reference compatible.  We have do do this after stripping
      references from FROM.  */
   related_p = reference_related_p (to, from);
+  /* If this is a C cast, first convert to an appropriately qualified
+     type, so that we can later do a const_cast to the desired type.  */
+  if (related_p && c_cast_p
+      && !at_least_as_qualified_p (to, from))
+    to = build_qualified_type (to, cp_type_quals (from));
   compatible_p = reference_compatible_p (to, from);
 
   if (lvalue_p && compatible_p)
@@ -1227,7 +1230,7 @@
   if (related_p && !at_least_as_qualified_p (to, from))
     return NULL;
 
-  conv = implicit_conversion (to, from, expr, /*c_cast_p=*/false,
+  conv = implicit_conversion (to, from, expr, c_cast_p,
 			      flags);
   if (!conv)
     return NULL;
@@ -1257,7 +1260,7 @@
     return NULL;
 
   if (TREE_CODE (to) == REFERENCE_TYPE)
-    conv = reference_binding (to, from, expr, flags);
+    conv = reference_binding (to, from, expr, c_cast_p, flags);
   else
     conv = standard_conversion (to, from, expr, c_cast_p, flags);
 
@@ -4655,6 +4658,7 @@
 tree
 convert_for_arg_passing (tree type, tree val)
 {
+  val = convert_bitfield_to_declared_type (val);
   if (val == error_mark_node)
     ;
   /* Pass classes with copy ctors by invisible reference.  */
@@ -6564,7 +6568,8 @@
   /* Get the high-water mark for the CONVERSION_OBSTACK.  */
   p = conversion_obstack_alloc (0);
 
-  conv = reference_binding (type, TREE_TYPE (expr), expr, LOOKUP_NORMAL);
+  conv = reference_binding (type, TREE_TYPE (expr), expr, /*c_cast_p=*/false,
+			    LOOKUP_NORMAL);
   if (!conv || conv->bad_p)
     {
       if (!(TYPE_QUALS (TREE_TYPE (type)) & TYPE_QUAL_CONST)
Index: gcc-4_2-branch/gcc/cp/cp-tree.h
===================================================================
--- gcc-4_2-branch/gcc/cp/cp-tree.h	(revision 123014)
+++ gcc-4_2-branch/gcc/cp/cp-tree.h	(revision 124164)
@@ -4471,6 +4471,7 @@
 extern int ptr_reasonably_similar		(tree, tree);
 extern tree build_ptrmemfunc			(tree, tree, int, bool);
 extern int cp_type_quals			(tree);
+extern bool cp_type_readonly			(tree);
 extern bool cp_has_mutable_p			(tree);
 extern bool at_least_as_qualified_p		(tree, tree);
 extern void cp_apply_type_quals_to_decl		(int, tree);
Index: gcc-4_2-branch/gcc/cp/ChangeLog
===================================================================
--- gcc-4_2-branch/gcc/cp/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/gcc/cp/ChangeLog	(revision 124164)
@@ -1,3 +1,70 @@
+2007-04-24  Paolo Carlini  <pcarlini@suse.de>
+
+	PR c++/30500
+	* pt.c (instantiate_decl): Set in_system_header.
+
+2007-04-17  Simon Martin  <simartin@users.sourceforge.net>
+
+	PR c++/31517
+	* pt.c (value_dependent_expression_p): Handle MODOP_EXPRs.
+
+2007-04-16  Mark Mitchell  <mark@codesourcery.com>
+
+	PR c++/31513
+	* call.c (convert_for_arg_passing): Convert bitfields to their
+	declared types.
+
+2007-04-13  Jason Merrill  <jason@redhat.com>
+
+	PR c++/31074
+	* call.c (reference_binding): Add c_cast_p parm.  If true,
+	add quals to TO as needed to make it reference-compatible.
+
+2007-04-10  Mike Stump  <mrs@apple.com>
+
+	* class.c (dfs_accumulate_vtbl_inits): Slam the vtbl type back to
+	vtbl_ptr_type_node to ensure the mode is correct.
+
+2007-04-09  Mark Mitchell  <mark@codesourcery.com>
+
+	PR c++/31449
+	* class.c (build_base_path): Ensure that the converted pointer has
+	the same cv-qualification as the input.
+
+2007-04-03  Jakub Jelinek  <jakub@redhat.com>
+
+	PR c++/30847
+	* typeck.c (build_modify_expr): For COND_EXPR on LHS, if RHS has void
+	type issue error and return early.
+
+2007-03-30  Jason Merrill  <jason@redhat.com>
+
+	PR c++/31187
+	* typeck.c (cp_type_readonly): New fn.
+	* cp-tree.h: Declare it.
+	* decl.c (start_decl): Set implicit DECL_THIS_STATIC here.
+	(cp_finish_decl): Not here.
+
+2007-03-31  Diego Novillo  <dnovillo@redhat.com>
+	    Mark Mitchell  <mark@codesourcery.com>
+
+	PR 29585
+	* class.c (dfs_accumulate_vtbl_inits): Use build_address
+	to build the vtbl entry.
+
+2007-03-22  Mark Mitchell  <mark@codesourcery.com>
+
+	PR c++/30863
+	* parser.c (cp_parser_parse_and_diagnose_invalid_type_name): Do
+	not consume tokens when failing.
+
+2007-03-22  Jim Wilson  <wilson@specifix.com>
+	    Mark Mitchell  <mark@codesourcery.com>
+
+	PR c++/31273
+	* call.c (standard_conversion): Use type_decays_to.  Keep FCODE
+	consistent with FROM.
+
 2007-03-14  Andrew Pinski  <andrew_pinski@playstation.sony.com>
 
 	PR c++/31165
Index: gcc-4_2-branch/gcc/cp/pt.c
===================================================================
--- gcc-4_2-branch/gcc/cp/pt.c	(revision 123014)
+++ gcc-4_2-branch/gcc/cp/pt.c	(revision 124164)
@@ -12034,6 +12034,7 @@
   bool pattern_defined;
   int need_push;
   location_t saved_loc = input_location;
+  int saved_in_system_header = in_system_header;
   bool external_p;
 
   /* This function should only be used to instantiate templates for
@@ -12116,6 +12117,7 @@
     mark_definable (d);
 
   input_location = DECL_SOURCE_LOCATION (d);
+  in_system_header = DECL_IN_SYSTEM_HEADER (d);
 
   /* If D is a member of an explicitly instantiated class template,
      and no definition is available, treat it like an implicit
@@ -12349,6 +12351,7 @@
 
 out:
   input_location = saved_loc;
+  in_system_header = saved_in_system_header;
   pop_deferring_access_checks ();
   pop_tinst_level ();
 
@@ -12924,6 +12927,10 @@
 	 such calls are value-dependent.  */
       return true;
 
+    case MODOP_EXPR:
+      return ((value_dependent_expression_p (TREE_OPERAND (expression, 0)))
+	      || (value_dependent_expression_p (TREE_OPERAND (expression, 2))));
+
     default:
       /* A constant expression is value-dependent if any subexpression is
 	 value-dependent.  */
Index: gcc-4_2-branch/gcc/cp/parser.c
===================================================================
--- gcc-4_2-branch/gcc/cp/parser.c	(revision 123014)
+++ gcc-4_2-branch/gcc/cp/parser.c	(revision 124164)
@@ -2281,12 +2281,13 @@
      the scope is dependent, we cannot do much.  */
   if (!cp_lexer_next_token_is (parser->lexer, CPP_NAME)
       || (parser->scope && TYPE_P (parser->scope)
-	  && dependent_type_p (parser->scope)))
+	  && dependent_type_p (parser->scope))
+      || TREE_CODE (id) == TYPE_DECL)
     {
       cp_parser_abort_tentative_parse (parser);
       return false;
     }
-  if (!cp_parser_parse_definitely (parser) || TREE_CODE (id) == TYPE_DECL)
+  if (!cp_parser_parse_definitely (parser))
     return false;
 
   /* Emit a diagnostic for the invalid type.  */
Index: gcc-4_2-branch/gcc/cse.c
===================================================================
--- gcc-4_2-branch/gcc/cse.c	(revision 123014)
+++ gcc-4_2-branch/gcc/cse.c	(revision 124164)
@@ -4542,6 +4542,14 @@
   op1 = fold_rtx (XEXP (XEXP (SET_SRC (set), 0), 1), insn);
 
   code = find_comparison_args (code, &op0, &op1, &mode0, &mode1);
+
+  /* If the mode is a MODE_CC mode, we don't know what kinds of things
+     are being compared, so we can't do anything with this
+     comparison.  */
+
+  if (GET_MODE_CLASS (mode0) == MODE_CC)
+    return;
+
   if (! cond_known_true)
     {
       code = reversed_comparison_code_parts (code, op0, op1, insn);
Index: gcc-4_2-branch/gcc/dwarf2out.c
===================================================================
--- gcc-4_2-branch/gcc/dwarf2out.c	(revision 123014)
+++ gcc-4_2-branch/gcc/dwarf2out.c	(revision 124164)
@@ -10003,12 +10003,24 @@
   if (DECL_P (*tp) && ! TREE_PUBLIC (*tp) && ! TREE_USED (*tp)
       && ! TREE_ASM_WRITTEN (*tp))
     return *tp;
-  else if (DECL_P (*tp) && TREE_CODE (*tp) != FUNCTION_DECL)
+  else if (!flag_unit_at_a_time)
+    return NULL_TREE;
+  else if (!cgraph_global_info_ready
+	   && (TREE_CODE (*tp) == VAR_DECL || TREE_CODE (*tp) == FUNCTION_DECL))
+    gcc_unreachable ();
+  else if (DECL_P (*tp) && TREE_CODE (*tp) == VAR_DECL)
     {
       struct cgraph_varpool_node *node = cgraph_varpool_node (*tp);
       if (!node->needed)
 	return *tp;
     }
+   else if (DECL_P (*tp) && TREE_CODE (*tp) == FUNCTION_DECL
+	    && (!DECL_EXTERNAL (*tp) || DECL_DECLARED_INLINE_P (*tp)))
+    {
+      struct cgraph_node *node = cgraph_node (*tp);
+      if (!node->output)
+        return *tp;
+    }
 
   return NULL_TREE;
 }
Index: gcc-4_2-branch/gcc/expr.c
===================================================================
--- gcc-4_2-branch/gcc/expr.c	(revision 123014)
+++ gcc-4_2-branch/gcc/expr.c	(revision 124164)
@@ -8786,8 +8786,15 @@
   HOST_WIDE_INT prec = TYPE_PRECISION (type);
   if (target && GET_MODE (target) != GET_MODE (exp))
     target = 0;
-  if (TYPE_UNSIGNED (type))
+  /* For constant values, reduce using build_int_cst_type. */
+  if (GET_CODE (exp) == CONST_INT)
     {
+      HOST_WIDE_INT value = INTVAL (exp);
+      tree t = build_int_cst_type (type, value);
+      return expand_expr (t, target, VOIDmode, EXPAND_NORMAL);
+    }
+  else if (TYPE_UNSIGNED (type))
+    {
       rtx mask;
       if (prec < HOST_BITS_PER_WIDE_INT)
 	mask = immed_double_const (((unsigned HOST_WIDE_INT) 1 << prec) - 1, 0,
Index: gcc-4_2-branch/gcc/cfgbuild.c
===================================================================
--- gcc-4_2-branch/gcc/cfgbuild.c	(revision 123014)
+++ gcc-4_2-branch/gcc/cfgbuild.c	(revision 124164)
@@ -120,6 +120,11 @@
 	      || can_throw_internal (insn));
 
     case INSN:
+      /* Treat trap instructions like noreturn calls (same provision).  */
+      if (GET_CODE (PATTERN (insn)) == TRAP_IF
+	  && XEXP (PATTERN (insn), 0) == const1_rtx)
+	return true;
+
       return (flag_non_call_exceptions && can_throw_internal (insn));
 
     case BARRIER:
Index: gcc-4_2-branch/gcc/opts.c
===================================================================
--- gcc-4_2-branch/gcc/opts.c	(revision 123014)
+++ gcc-4_2-branch/gcc/opts.c	(revision 124164)
@@ -1010,7 +1010,7 @@
       break;
 
     case OPT_fforce_mem:
-      warning (0, "-f[no-]force-mem is nop and option will be removed in 4.2");
+      warning (0, "-f[no-]force-mem is nop and option will be removed in 4.3");
       break;
 
     case OPT_floop_optimize:
Index: gcc-4_2-branch/gcc/c-decl.c
===================================================================
--- gcc-4_2-branch/gcc/c-decl.c	(revision 123014)
+++ gcc-4_2-branch/gcc/c-decl.c	(revision 124164)
@@ -3337,7 +3337,7 @@
 void
 finish_decl (tree decl, tree init, tree asmspec_tree)
 {
-  tree type = TREE_TYPE (decl);
+  tree type;
   int was_incomplete = (DECL_SIZE (decl) == 0);
   const char *asmspec = 0;
 
@@ -3364,6 +3364,8 @@
 			    || TREE_CODE (decl) == FIELD_DECL))
     objc_check_decl (decl);
 
+  type = TREE_TYPE (decl);
+
   /* Deduce size of array from initialization, if not already known.  */
   if (TREE_CODE (type) == ARRAY_TYPE
       && TYPE_DOMAIN (type) == 0
Index: gcc-4_2-branch/gcc/fortran/ChangeLog
===================================================================
--- gcc-4_2-branch/gcc/fortran/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/gcc/fortran/ChangeLog	(revision 124164)
@@ -1,3 +1,20 @@
+2007-04-12  Daniel Franke  <franke.daniel@gmail.com>
+
+	PR fortran/31234
+	* intrinsic.texi (RANDOM_SEED, RANDOM_NUMBER): New.
+
+2007-03-23  Brooks Moses  <brooks.moses@codesourcery.com>
+
+	* invoke.texi: Misc. small typo fixes.
+	(-Wcharacter-truncation): Add.
+	(-Wnonstd-intrinsics): Correct spelling.
+	(-std=): Edit.
+
+2007-03-17  Francois-Xavier Coudert  <coudert@clipper.ens.fr>
+
+	PR fortran/31184
+	* invoke.texi: Fix typo.
+
 2007-03-14  Jakub Jelinek  <jakub@redhat.com>
 
 	* module.c (mio_typespec): Don't look at ts->cl if not BT_CHARACTER.
Index: gcc-4_2-branch/gcc/fortran/invoke.texi
===================================================================
--- gcc-4_2-branch/gcc/fortran/invoke.texi	(revision 123014)
+++ gcc-4_2-branch/gcc/fortran/invoke.texi	(revision 124164)
@@ -128,9 +128,9 @@
 and Warnings}.
 @gccoptlist{-fmax-errors=@var{n} @gol
 -fsyntax-only  -pedantic  -pedantic-errors @gol
--w  -Wall  -Waliasing  -Wampersand  -Wconversion  -Wimplicit-interface @gol
--Wtabs -Wnonstd-intrinsics -Wsurprising -Wunderflow @gol
--Wline-truncation -W}
+-w  -Wall  -Waliasing  -Wampersand  -Wcharacter-truncation  -Wconversion @gol
+-Wimplicit-interface  -Wline-truncation  -Wnonstd-intrinsics  -Wsurprising @gol
+-Wno-tabs  -Wunderflow  -W}
 
 @item Debugging Options
 @xref{Debugging Options,,Options for Debugging Your Program or GCC}.
@@ -138,11 +138,12 @@
 
 @item Directory Options
 @xref{Directory Options,,Options for Directory Search}.
-@gccoptlist{-I@var{dir}  -M@var{dir}}
+@gccoptlist{-I@var{dir}  -J@var{dir}  -M@var{dir}}
 
 @item Runtime Options
 @xref{Runtime Options,,Options for influencing runtime behavior}.
-@gccoptlist{-fconvert=@var{conversion} -frecord-marker=@var{length}}
+@gccoptlist{-fconvert=@var{conversion}  -frecord-marker=@var{length} @gol
+-fmax-subrecord-length=@var{length}}
 
 @item Code Generation Options
 @xref{Code Gen Options,,Options for Code Generation Conventions}.
@@ -198,7 +199,7 @@
 @command{gfortran} will ignore @option{-Wnonstd-intrinsics}.
 
 @item -fd-lines-as-code
-@item -fd-lines-as-comment
+@item -fd-lines-as-comments
 @cindex @code{-fd-lines-as-code}, option
 @cindex option, @code{-fd-lines-as-code}
 @cindex @code{-fd-lines-as-comments}, option
@@ -325,12 +326,19 @@
 @item -std=@var{std}
 @cindex @code{-std=}@var{std} option
 @cindex option, @code{-std=}@var{std}
-Conform to the specified standard.  The default value for @var{std} is
-@samp{gnu}; a superset of the Fortran 95 standard which includes all
-of the GNU extensions recommended for use in new code.  The @samp{legacy}
-value also includes obsolete extensions that may be required for old 
-non-standard programs.  Strict conformance to the Fortran 95 and Fortran 2003
-standards is specified by @samp{f95} and @samp{f2003}, respectively.
+Specify the standard to which the program is expected to conform, which
+may be one of @samp{f95}, @samp{f2003}, @samp{gnu}, or @samp{legacy}.
+The default value for @var{std} is @samp{gnu}, which specifies a
+superset of the Fortran 95 standard that includes all of the extensions
+supported by GNU Fortran, although warnings will be given for obsolete
+extensions not recommended for use in new code.  The @samp{legacy} value
+is equivalent but without the warnings for obsolete extensions, and may
+be useful for old non-standard programs.  The @samp{f95} and
+@samp{f2003} values specify strict conformance to the Fortran 95 and
+Fortran 2003 standards, respectively; errors are given for all
+extensions beyond the relevant language standard, and warnings are given
+for the Fortran 77 features that are permitted but obsolescent in later
+standards.
 
 @end table
 
@@ -420,7 +428,7 @@
 Enables commonly used warning options pertaining to usage that
 we recommend avoiding and that we believe are easy to avoid.
 This currently includes @option{-Waliasing},
-@option{-Wampersand}, @option{-Wsurprising}, @option{-Wnonstd-intrinsic},
+@option{-Wampersand}, @option{-Wsurprising}, @option{-Wnonstd-intrinsics},
 @option{-Wno-tabs}, and @option{-Wline-truncation}.
 
 @item -Waliasing
@@ -455,6 +463,11 @@
 constant, GNU Fortran assumes continuation at the first non-comment,
 non-whitespace character after the ampersand that initiated the continuation.
 
+@item -Wcharacter-truncation
+@cindex @code{-Wcharacter-truncation} option
+@cindex option, @code{-Wcharacter-truncation}
+Warn when a character assignment will truncate the assigned string.
+
 @item -Wconversion
 @cindex @code{-Wconversion} option
 @cindex option, @code{-Wconversion}
@@ -468,11 +481,11 @@
 Note this only checks that an explicit interface is present.  It does not
 check that the declared interfaces are consistent across program units.
 
-@item -Wnonstd-intrinsic
-@cindex @code{-Wnonstd-intrinsic} option
-@cindex option, @code{-Wnonstd-intrinsic}
+@item -Wnonstd-intrinsics
+@cindex @code{-Wnonstd-intrinsics} option
+@cindex option, @code{-Wnonstd-intrinsics}
 Warn if the user tries to use an intrinsic that does not belong to the 
-standard the user has chosen via the -std option.
+standard the user has chosen via the @option{-std} option.
 
 @item -Wsurprising
 @cindex @code{-Wsurprising} option
@@ -608,9 +621,11 @@
 @item -M@var{dir}
 @item -J@var{dir}
 @cindex @code{-M}@var{dir} option
-@cindex option, -@code{-M}@var{dir}
+@cindex option, @code{-M}@var{dir}
 @cindex @code{-J}@var{dir} option
-@cindex option, -@code{-J}@var{dir}
+@cindex option, @code{-J}@var{dir}
+@cindex paths, search
+@cindex module search path
 This option specifies where to put @file{.mod} files for compiled modules.
 It is also added to the list of directories to searched by an @code{USE}
 statement.
Index: gcc-4_2-branch/gcc/fortran/intrinsic.texi
===================================================================
--- gcc-4_2-branch/gcc/fortran/intrinsic.texi	(revision 123014)
+++ gcc-4_2-branch/gcc/fortran/intrinsic.texi	(revision 124164)
@@ -7614,10 +7614,11 @@
 @cindex @code{RANDOM_NUMBER} intrinsic
 @cindex random numbers
 
-Intrinsic implemented, documentation pending.
-
 @table @asis
 @item @emph{Description}:
+Returns a single pseudorandom number or an array of pseudorandom numbers
+from the uniform distribution over the range @math{ 0 \leq x < 1}.
+
 @item @emph{Standard}:
 F95 and later
 
@@ -7625,9 +7626,31 @@
 Elemental subroutine
 
 @item @emph{Syntax}:
+@code{RANDOM_NUMBER(HARVEST)}
+
 @item @emph{Arguments}:
-@item @emph{Return value}:
+@multitable @columnfractions .15 .70
+@item @var{HARVEST} @tab Shall be a scalar or an array of type @code{REAL(*)}.
+@end multitable
+
 @item @emph{Example}:
+@smallexample
+program test_random_number
+  REAL :: r(5,5)
+  CALL init_random_seed()         ! see example of RANDOM_SEED
+  CALL RANDOM_NUMBER(r)
+end program
+@end smallexample
+
+@item @emph{Note}:
+The implemented random number generator is thread safe if used within
+OpenMP directives, i. e. its state will be consistent while called from
+multiple threads. Please note that the currently implemented KISS generator 
+does not create random numbers in parallel from multiple sources, but in
+sequence from a single source. If your OpenMP-enabled application heavily
+relies on random numbers, you should consider employing a dedicated parallel
+random number generator instead.
+
 @item @emph{See also}:
 @ref{RANDOM_SEED}
 @end table
@@ -7639,10 +7662,15 @@
 @cindex @code{RANDOM_SEED} intrinsic
 @cindex random numbers
 
-Intrinsic implemented, documentation pending.
-
 @table @asis
 @item @emph{Description}:
+Restarts or queries the state of the pseudorandom number generator used by 
+@code{RANDOM_NUMBER}.
+
+If @code{RANDOM_SEED} is called without arguments, it is initialized to
+a default state. The example below shows how to initialize the random 
+seed based on the system's time.
+
 @item @emph{Standard}:
 F95 and later
 
@@ -7650,9 +7678,41 @@
 Subroutine
 
 @item @emph{Syntax}:
+@code{CALL RANDOM_SEED(SIZE, PUT, GET)}
+
 @item @emph{Arguments}:
-@item @emph{Return value}:
+@multitable @columnfractions .15 .70
+@item @var{SIZE} @tab (Optional) Shall be a scalar and of type default 
+@code{INTEGER}, with @code{INTENT(OUT)}. It specifies the minimum size 
+of the arrays used with the @var{PUT} and @var{GET} arguments.
+@item @var{PUT}  @tab (Optional) Shall be an array of type default 
+@code{INTEGER} and rank one. It is @code{INTENT(IN)} and the size of 
+the array must be larger than or equal to the number returned by the 
+@var{SIZE} argument.
+@item @var{GET}  @tab (Optional) Shall be an array of type default 
+@code{INTEGER} and rank one. It is @code{INTENT(OUT)} and the size 
+of the array must be larger than or equal to the number returned by 
+the @var{SIZE} argument.
+@end multitable
+
 @item @emph{Example}:
+@smallexample
+SUBROUTINE init_random_seed()
+  INTEGER :: i, n, clock
+  INTEGER, DIMENSION(:), ALLOCATABLE :: seed
+
+  CALL RANDOM_SEED(size = n)
+  ALLOCATE(seed(n))
+
+  CALL SYSTEM_CLOCK(COUNT=clock)
+
+  seed = clock + 37 * (/ (i - 1, i = 1, n) /)
+  CALL RANDOM_SEED(PUT = seed)
+
+  DEALLOCATE(seed)
+END SUBROUTINE
+@end smallexample
+
 @item @emph{See also}:
 @ref{RANDOM_NUMBER}
 @end table
Index: gcc-4_2-branch/gcc/c.opt
===================================================================
--- gcc-4_2-branch/gcc/c.opt	(revision 123014)
+++ gcc-4_2-branch/gcc/c.opt	(revision 124164)
@@ -133,7 +133,7 @@
 Warn about casting functions to incompatible types
 
 Wc++-compat
-C Var(warn_cxx_compat)
+C ObjC Var(warn_cxx_compat)
 Warn about C constructs that are not in the common subset of C and C++
 
 
@@ -170,7 +170,7 @@
 Warn about deprecated compiler features
 
 Wdiv-by-zero
-C ObjC C++ Var(warn_div_by_zero) Init(1)
+C ObjC C++ ObjC++ Var(warn_div_by_zero) Init(1)
 Warn about compile-time integer division by zero
 
 Weffc++
@@ -532,7 +532,7 @@
 Generate code for GNU runtime environment
 
 fgnu89-inline
-C Var(flag_gnu89_inline) Init(-1)
+C ObjC Var(flag_gnu89_inline) Init(-1)
 Use traditional GNU semantics for inline functions
 
 fguiding-decls
@@ -565,7 +565,7 @@
 Emit implicit instantiations of templates
 
 ffriend-injection
-C++ Var(flag_friend_injection)
+C++ ObjC++ Var(flag_friend_injection)
 Inject friend functions into enclosing namespace
 
 flabels-ok
Index: gcc-4_2-branch/gcc/c-typeck.c
===================================================================
--- gcc-4_2-branch/gcc/c-typeck.c	(revision 123014)
+++ gcc-4_2-branch/gcc/c-typeck.c	(revision 124164)
@@ -3940,10 +3940,16 @@
 	       || coder == BOOLEAN_TYPE))
     return convert_and_check (type, rhs);
 
+  /* Aggregates in different TUs might need conversion.  */
+  if ((codel == RECORD_TYPE || codel == UNION_TYPE)
+      && codel == coder
+      && comptypes (type, rhstype))
+    return convert_and_check (type, rhs);
+
   /* Conversion to a transparent union from its member types.
      This applies only to function arguments.  */
-  else if (codel == UNION_TYPE && TYPE_TRANSPARENT_UNION (type)
-	   && (errtype == ic_argpass || errtype == ic_argpass_nonproto))
+  if (codel == UNION_TYPE && TYPE_TRANSPARENT_UNION (type)
+      && (errtype == ic_argpass || errtype == ic_argpass_nonproto))
     {
       tree memb, marginal_memb = NULL_TREE;
 
Index: gcc-4_2-branch/gcc/expmed.c
===================================================================
--- gcc-4_2-branch/gcc/expmed.c	(revision 123014)
+++ gcc-4_2-branch/gcc/expmed.c	(revision 124164)
@@ -4976,17 +4976,17 @@
 
     case CONST_VECTOR:
       {
-	int i, units;
-	rtx elt;
+	int units = CONST_VECTOR_NUNITS (x);
+	tree itype = TREE_TYPE (type);
 	tree t = NULL_TREE;
+	int i;
 
-	units = CONST_VECTOR_NUNITS (x);
 
 	/* Build a tree with vector elements.  */
 	for (i = units - 1; i >= 0; --i)
 	  {
-	    elt = CONST_VECTOR_ELT (x, i);
-	    t = tree_cons (NULL_TREE, make_tree (type, elt), t);
+	    rtx elt = CONST_VECTOR_ELT (x, i);
+	    t = tree_cons (NULL_TREE, make_tree (itype, elt), t);
 	  }
 
 	return build_vector (type, t);
Index: gcc-4_2-branch/gcc/po/ChangeLog
===================================================================
--- gcc-4_2-branch/gcc/po/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/gcc/po/ChangeLog	(revision 124164)
@@ -1,3 +1,7 @@
+2007-04-21  Joseph S. Myers  <joseph@codesourcery.com>
+
+	* sv.po: Update.
+
 2007-03-08  Joseph S. Myers  <joseph@codesourcery.com>
 
 	* sr.po: New.
Index: gcc-4_2-branch/gcc/po/sv.po
===================================================================
--- gcc-4_2-branch/gcc/po/sv.po	(revision 123014)
+++ gcc-4_2-branch/gcc/po/sv.po	(revision 124164)
@@ -1,7 +1,7 @@
 # Swedish messages for GCC.
-# Copyright  2000, 2005, 2006 Free Software Foundation, Inc.
+# Copyright  2000, 2005, 2006, 2007 Free Software Foundation, Inc.
 # Dennis Bjrklund <db@zigo.dhs.org>, 2000, 2001, 2002.
-# Gran Uddeborg <goeran@uddeborg.se>, 2005, 2006.
+# Gran Uddeborg <goeran@uddeborg.se>, 2005, 2006, 2007.
 #
 # Remember: GCC team does not want RCS keywords in the header!
 #
@@ -10,7 +10,7 @@
 "Project-Id-Version: gcc 4.1.1\n"
 "Report-Msgid-Bugs-To: http://gcc.gnu.org/bugs.html\n"
 "POT-Creation-Date: 2006-05-24 16:19-0700\n"
-"PO-Revision-Date: 2006-12-13 22:05+0100\n"
+"PO-Revision-Date: 2007-04-03 09:58+0200\n"
 "Last-Translator: Gran Uddeborg <goeran@uddeborg.se>\n"
 "Language-Team: Swedish <tp-sv@listor.tp-sv.se>\n"
 "MIME-Version: 1.0\n"
@@ -364,7 +364,7 @@
 
 #: c-typeck.c:5209
 msgid "braces around scalar initializer"
-msgstr "klamrar funt skalr initierare"
+msgstr "klamrar runt skalr initierare"
 
 #: c-typeck.c:5266
 msgid "initialization of flexible array member in a nested context"
@@ -9266,19 +9266,19 @@
 
 #: java/lang.opt:66
 msgid "Warn if a deprecated compiler feature, class, method, or field is used"
-msgstr "Varna om en kompilatorfunktion, klass, metod eller flt som avrdes ifrn anvnds"
+msgstr "Varna fr en kompilatorfunktion, klass, metod eller flt som br undvikas anvnds"
 
 #: java/lang.opt:70
 msgid "Warn if deprecated empty statements are found"
-msgstr "Varna om frldrade tomma satser finns"
+msgstr "Varna fr tomma satser som br undvikas finns"
 
 #: java/lang.opt:74
 msgid "Warn if .class files are out of date"
-msgstr "Varna om .class-filer r inaktuella"
+msgstr "Varna fr .class-filer r inaktuella"
 
 #: java/lang.opt:78
 msgid "Warn if modifiers are specified when not necessary"
-msgstr "Varna om modifierare anges nr de inte behvs"
+msgstr "Varna fr modifierare anges nr de inte behvs"
 
 #: java/lang.opt:82
 msgid "Deprecated; use --classpath instead"
@@ -9370,23 +9370,23 @@
 
 #: fortran/lang.opt:42
 msgid "Warn about possible aliasing of dummy arguments"
-msgstr "Varna om eventuell aliasning av atrappargument"
+msgstr "Varna fr eventuell aliasning av atrappargument"
 
 #: fortran/lang.opt:46
 msgid "Warn about missing ampersand in continued character literals"
-msgstr "Varna om saknade ampersander i fortsatta teckenliteraler"
+msgstr "Varna fr saknade ampersander i fortsatta teckenliteraler"
 
 #: fortran/lang.opt:50
 msgid "Warn about implicit conversion"
-msgstr "Varna om implicita konverteringar"
+msgstr "Varna fr implicita konverteringar"
 
 #: fortran/lang.opt:54
 msgid "Warn about calls with implicit interface"
-msgstr "Varna om anrop med implicit grnssnitt"
+msgstr "Varna fr anrop med implicit grnssnitt"
 
 #: fortran/lang.opt:58
 msgid "Warn about truncated source lines"
-msgstr "Varna om avhuggna kllkodsrader"
+msgstr "Varna fr avhuggna kllkodsrader"
 
 #: fortran/lang.opt:62
 msgid "Warn about usage of non-standard intrinsics"
@@ -9394,11 +9394,11 @@
 
 #: fortran/lang.opt:66
 msgid "Warn about \"suspicious\" constructs"
-msgstr "Varna om \"misstnkta\" konstruktioner"
+msgstr "Varna fr \"misstnkta\" konstruktioner"
 
 #: fortran/lang.opt:70
 msgid "Warn about underflow of numerical constant expressions"
-msgstr "Varna om underspill i numeriska konstantuttryck"
+msgstr "Varna fr underspill i numeriska konstantuttryck"
 
 #: fortran/lang.opt:74 common.opt:162
 msgid "Warn when a label is unused"
@@ -9936,11 +9936,11 @@
 
 #: config/s390/s390.opt:92
 msgid "Warn if a function uses alloca or creates an array with dynamic size"
-msgstr "Varna om en funktion anvnder alloca eller skapar en vektor med dynamisk storlek"
+msgstr "Varna fr en funktion anvnder alloca eller skapar en vektor med dynamisk storlek"
 
 #: config/s390/s390.opt:96
 msgid "Warn if a single function's framesize exceeds the given framesize"
-msgstr "Varna om en enskild funktions ramstorlek verskrider den angivna ramstorleken"
+msgstr "Varna fr en enskild funktions ramstorlek verskrider den angivna ramstorleken"
 
 #: config/s390/s390.opt:100
 msgid "z/Architecture"
@@ -10690,7 +10690,7 @@
 
 #: config/rs6000/rs6000.opt:215
 msgid "Warn about deprecated 'vector long ...' AltiVec type usage"
-msgstr "Varna fr anvndning av AltiVec-typen \"vector long ...\" som avrdes frn"
+msgstr "Varna fr anvndning av AltiVec-typen \"vector long ...\" som br undvikas"
 
 #: config/rs6000/rs6000.opt:219
 msgid "Select GPR floating point method"
@@ -12214,7 +12214,7 @@
 
 #: c.opt:117
 msgid "Warn about things that will change when compiling with an ABI-compliant compiler"
-msgstr "Varna om saker som skulle ndras vid kompilering med en kompilator som fljer ABI"
+msgstr "Varna fr saker som skulle ndras vid kompilering med en kompilator som fljer ABI"
 
 #: c.opt:121
 msgid "Enable most warning messages"
@@ -12226,23 +12226,23 @@
 
 #: c.opt:129
 msgid "Warn about casting functions to incompatible types"
-msgstr "Varna om typkonvertering av funktioner till inkompatibla typer"
+msgstr "Varna fr typkonvertering av funktioner till inkompatibla typer"
 
 #: c.opt:133
 msgid "Warn about C constructs that are not in the common subset of C and C++"
-msgstr "Varna om C-konstruktioner som inte r i den gemensamma delmngden av C och C++"
+msgstr "Varna fr C-konstruktioner som inte r i den gemensamma delmngden av C och C++"
 
 #: c.opt:138
 msgid "Warn about casts which discard qualifiers"
-msgstr "Varna om typkonvertering som slnger kvalificerare"
+msgstr "Varna fr typkonvertering som slnger kvalificerare"
 
 #: c.opt:142
 msgid "Warn about subscripts whose type is \"char\""
-msgstr "Varna om index vars typ r \"char\""
+msgstr "Varna fr index vars typ r \"char\""
 
 #: c.opt:146
 msgid "Warn about possibly nested block comments, and C++ comments spanning more than one physical line"
-msgstr "Varna om mjliga nstade blockkommentarer, och C++-kommentarer som spnner ver mer n en fysisk rad"
+msgstr "Varna fr mjliga nstade blockkommentarer, och C++-kommentarer som spnner ver mer n en fysisk rad"
 
 #: c.opt:150
 msgid "Synonym for -Wcomment"
@@ -12250,7 +12250,7 @@
 
 #: c.opt:154
 msgid "Warn about possibly confusing type conversions"
-msgstr "Varna om eventuellt frvirrande typkonverteringar"
+msgstr "Varna fr eventuellt frvirrande typkonverteringar"
 
 #: c.opt:158
 msgid "Warn when all constructors and destructors are private"
@@ -12262,19 +12262,19 @@
 
 #: c.opt:166
 msgid "Warn about deprecated compiler features"
-msgstr "Varna om kompilatorfunktioner som undanbedes"
+msgstr "Varna fr kompilatorfunktioner br undvikas"
 
 #: c.opt:170
 msgid "Warn about compile-time integer division by zero"
-msgstr "Varna om heltalsdivision med noll vid kompileringstillfllet"
+msgstr "Varna fr heltalsdivision med noll vid kompileringstillfllet"
 
 #: c.opt:174
 msgid "Warn about violations of Effective C++ style rules"
-msgstr "Varna om brott mot Effective C++ stilregler"
+msgstr "Varna fr brott mot stilreglerna i Effective C++"
 
 #: c.opt:178
 msgid "Warn about stray tokens after #elif and #endif"
-msgstr "Varna om vilsekomna symboler efter #elif och #endif"
+msgstr "Varna fr vilsekomna symboler efter #elif och #endif"
 
 #: c.opt:186
 msgid "Make implicit function declarations an error"
@@ -12286,35 +12286,35 @@
 
 #: c.opt:194
 msgid "Warn about printf/scanf/strftime/strfmon format string anomalies"
-msgstr "Varna om anomalier i formatstrngar till printf/scanf/strftime/strfmon"
+msgstr "Varna fr anomalier i formatstrngar till printf/scanf/strftime/strfmon"
 
 #: c.opt:198
 msgid "Warn if passing too many arguments to a function for its format string"
-msgstr "Varna om fr mnga argument argument till en funktion fr dess formatstrng"
+msgstr "Varna fr fr mnga argument argument till en funktion fr dess formatstrng"
 
 #: c.opt:202
 msgid "Warn about format strings that are not literals"
-msgstr "Varna om formatstrngar som inte r literaler"
+msgstr "Varna fr formatstrngar som inte r literaler"
 
 #: c.opt:206
 msgid "Warn about possible security problems with format functions"
-msgstr "Varna om mjliga skerhetsproblem med formatfunktioner"
+msgstr "Varna fr mjliga skerhetsproblem med formatfunktioner"
 
 #: c.opt:210
 msgid "Warn about strftime formats yielding 2-digit years"
-msgstr "Varna om format till strftime som ger 2-siffrigt rtal"
+msgstr "Varna fr format till strftime som ger 2-siffrigt rtal"
 
 #: c.opt:214
 msgid "Warn about zero-length formats"
-msgstr "Varna om format med lngden noll"
+msgstr "Varna fr format med lngden noll"
 
 #: c.opt:221
 msgid "Warn about variables which are initialized to themselves"
-msgstr "Varna om variabler som intieras till sig sjlva"
+msgstr "Varna fr variabler som intieras till sig sjlva"
 
 #: c.opt:228
 msgid "Warn about implicit function declarations"
-msgstr "Varna om implicita funktionsdeklarationer"
+msgstr "Varna fr implicita funktionsdeklarationer"
 
 #: c.opt:232
 msgid "Warn when a declaration does not specify a type"
@@ -12326,15 +12326,15 @@
 
 #: c.opt:240
 msgid "Warn when there is a cast to a pointer from an integer of a different size"
-msgstr "Varna om typkonverteringar till pekare frn ett heltal med annan storlek"
+msgstr "Varna fr typkonverteringar till pekare frn ett heltal med annan storlek"
 
 #: c.opt:244
 msgid "Warn about invalid uses of the \"offsetof\" macro"
-msgstr "Varna om ogiltiga anvndningar av makrot \"offsetof\""
+msgstr "Varna fr ogiltiga anvndningar av makrot \"offsetof\""
 
 #: c.opt:248
 msgid "Warn about PCH files that are found but not used"
-msgstr "Varna om PCH-filer som hittas men inte anvnds"
+msgstr "Varna fr PCH-filer som hittas men inte anvnds"
 
 #: c.opt:252
 msgid "Do not warn about using \"long long\" when -pedantic"
@@ -12342,31 +12342,31 @@
 
 #: c.opt:256
 msgid "Warn about suspicious declarations of \"main\""
-msgstr "Varna om tveksamma deklarationer av \"main\""
+msgstr "Varna fr tveksamma deklarationer av \"main\""
 
 #: c.opt:260
 msgid "Warn about possibly missing braces around initializers"
-msgstr "Varna om eventuellt saknade klamrar runt initierare"
+msgstr "Varna fr eventuellt saknade klamrar runt initierare"
 
 #: c.opt:264
 msgid "Warn about global functions without previous declarations"
-msgstr "Varna om globala globala funktioner utan tidigare deklaration"
+msgstr "Varna fr globala globala funktioner utan tidigare deklaration"
 
 #: c.opt:268
 msgid "Warn about missing fields in struct initializers"
-msgstr "Varna om saknade flt i postinitierare"
+msgstr "Varna fr saknade flt i postinitierare"
 
 #: c.opt:272
 msgid "Warn about functions which might be candidates for format attributes"
-msgstr "Varna om funktioner som kan vara kandidater fr formatattribut"
+msgstr "Varna fr funktioner som kan vara kandidater fr formatattribut"
 
 #: c.opt:276
 msgid "Warn about user-specified include directories that do not exist"
-msgstr "Varna om anvndarangivna inkluderingskataloger som inte finns"
+msgstr "Varna fr anvndarangivna inkluderingskataloger som inte finns"
 
 #: c.opt:280
 msgid "Warn about global functions without prototypes"
-msgstr "Varna om globala funktioner utan prototyper"
+msgstr "Varna fr globala funktioner utan prototyper"
 
 #: c.opt:284
 msgid "Warn about use of multi-character character constants"
@@ -12374,7 +12374,7 @@
 
 #: c.opt:288
 msgid "Warn about \"extern\" declarations not at file scope"
-msgstr "Varna om \"extern\"-deklaration som inte r p filniv"
+msgstr "Varna fr \"extern\"-deklaration som inte r p filniv"
 
 #: c.opt:292
 msgid "Warn when non-templatized friend functions are declared within a template"
@@ -12382,31 +12382,31 @@
 
 #: c.opt:296
 msgid "Warn about non-virtual destructors"
-msgstr "Varna om ickevirtuella destruerare"
+msgstr "Varna fr ickevirtuella destruerare"
 
 #: c.opt:300
 msgid "Warn about NULL being passed to argument slots marked as requiring non-NULL"
-msgstr "Varna om NULL skickas som argument till fack markerde att de krver icke-NULL"
+msgstr "Varna om NULL skickas som argument som r markerade att de krver icke-NULL"
 
 #: c.opt:304
 msgid "Warn about non-normalised Unicode strings"
-msgstr "Varna om icke normaliserade Unicodestrngar"
+msgstr "Varna fr icke normaliserade Unicodestrngar"
 
 #: c.opt:308
 msgid "Warn if a C-style cast is used in a program"
-msgstr "Varna om en typkonvertering i C-stil anvnds i ett program"
+msgstr "Varna fr en typkonvertering i C-stil anvnds i ett program"
 
 #: c.opt:312
 msgid "Warn if an old-style parameter definition is used"
-msgstr "Varna om en gammaldags parameterdefinition anvnds"
+msgstr "Varna fr en gammaldags parameterdefinition anvnds"
 
 #: c.opt:316
 msgid "Warn about overloaded virtual function names"
-msgstr "Varna om verlastade virtuella funktionsnamn"
+msgstr "Varna fr verlagrade virtuella funktionsnamn"
 
 #: c.opt:320
 msgid "Warn about possibly missing parentheses"
-msgstr "Varna om eventuellt saknade parenteser"
+msgstr "Varna fr eventuellt saknade parenteser"
 
 #: c.opt:324
 msgid "Warn when converting the type of pointers to member functions"
@@ -12414,7 +12414,7 @@
 
 #: c.opt:328
 msgid "Warn about function pointer arithmetic"
-msgstr "Varna om aritmetik med funktionspekare"
+msgstr "Varna fr aritmetik med funktionspekare"
 
 #: c.opt:332
 msgid "Warn when a pointer is cast to an integer of a different size"
@@ -12422,15 +12422,15 @@
 
 #: c.opt:336
 msgid "Warn about misuses of pragmas"
-msgstr "Varna om missbruk av pragman"
+msgstr "Varna fr missbruk av pragman"
 
 #: c.opt:340
 msgid "Warn if inherited methods are unimplemented"
-msgstr "Varna om rvda metoder r oimplementerade"
+msgstr "Varna fr rvda metoder r oimplementerade"
 
 #: c.opt:344
 msgid "Warn about multiple declarations of the same object"
-msgstr "Varna om multipla deklarationer av samma objekt"
+msgstr "Varna fr multipla deklarationer av samma objekt"
 
 #: c.opt:348
 msgid "Warn when the compiler reorders code"
@@ -12442,31 +12442,31 @@
 
 #: c.opt:356
 msgid "Warn if a selector has multiple methods"
-msgstr "Varna om en vljare har multipla metoder"
+msgstr "Varna fr en vljare har multipla metoder"
 
 #: c.opt:360
 msgid "Warn about possible violations of sequence point rules"
-msgstr "Varna om mjliga brott mot sekvenspunktregler"
+msgstr "Varna fr mjliga brott mot sekvenspunktregler"
 
 #: c.opt:364
 msgid "Warn about signed-unsigned comparisons"
-msgstr "Varna om jmfrelser mellan signed/unsigned"
+msgstr "Varna fr jmfrelser mellan signed/unsigned"
 
 #: c.opt:368
 msgid "Warn when overload promotes from unsigned to signed"
-msgstr "Varna nr verlastning anpassar frn teckenlst till med tecken"
+msgstr "Varna nr verlagring anpassar frn teckenlst till med tecken"
 
 #: c.opt:372
 msgid "Warn about uncasted NULL used as sentinel"
-msgstr "Varna om ej typkonverterad NULL anvnds som vaktpost"
+msgstr "Varna fr ej typkonverterad NULL anvnds som vaktpost"
 
 #: c.opt:376
 msgid "Warn about unprototyped function declarations"
-msgstr "Varna om funktionsdeklarationer utan prototyp"
+msgstr "Varna fr funktionsdeklarationer utan prototyp"
 
 #: c.opt:380
 msgid "Warn if type signatures of candidate methods do not match exactly"
-msgstr "Varna om typsignaturer till kandidatmetoder inte stmmer exakt"
+msgstr "Varna fr typsignaturer till kandidatmetoder inte stmmer exakt"
 
 #: c.opt:384
 msgid "Warn when synthesis behavior differs from Cfront"
@@ -12478,27 +12478,27 @@
 
 #: c.opt:392
 msgid "Warn about features not present in traditional C"
-msgstr "Varna om funktioner som inte finns i traditionell C"
+msgstr "Varna fr funktioner som inte finns i traditionell C"
 
 #: c.opt:396
 msgid "Warn if trigraphs are encountered that might affect the meaning of the program"
-msgstr "Varna om trigrafer upptcks som kan pverka betydelsen av programmet"
+msgstr "Varna fr trigrafer upptcks som kan pverka betydelsen av programmet"
 
 #: c.opt:400
 msgid "Warn about @selector()s without previously declared methods"
-msgstr "Varna om @selector()er utan tidigare deklarerade metoder"
+msgstr "Varna fr @selector()er utan tidigare deklarerade metoder"
 
 #: c.opt:404
 msgid "Warn if an undefined macro is used in an #if directive"
-msgstr "Varna om ett odefinierat makro anvnds i ett #if-direktiv"
+msgstr "Varna fr ett odefinierat makro anvnds i ett #if-direktiv"
 
 #: c.opt:408
 msgid "Warn about unrecognized pragmas"
-msgstr "Varna om oknda pragman"
+msgstr "Varna fr oknda pragman"
 
 #: c.opt:412
 msgid "Warn about macros defined in the main file that are not used"
-msgstr "Varna om makron definierade i huvudfilen som inte anvnds"
+msgstr "Varna fr makron definierade i huvudfilen som inte anvnds"
 
 #: c.opt:416
 msgid "Do not warn about using variadic macros when -pedantic"
@@ -12886,23 +12886,23 @@
 
 #: common.opt:54
 msgid "This switch is deprecated; use -Wextra instead"
-msgstr "Denna flagga avrdes ifrn, anvnd -Wextra istllet"
+msgstr "Denna flagga br undvikas, anvnd -Wextra istllet"
 
 #: common.opt:58
 msgid "Warn about returning structures, unions or arrays"
-msgstr "Varna om retur av poster, unioner eller vektorer"
+msgstr "Varna fr retur av poster, unioner eller vektorer"
 
 #: common.opt:62
 msgid "Warn about inappropriate attribute usage"
-msgstr "Varna om felaktig anvndning av attribut"
+msgstr "Varna fr felaktig anvndning av attribut"
 
 #: common.opt:66
 msgid "Warn about pointer casts which increase alignment"
-msgstr "Varna om typkonvertering av pekare som kar justeringen"
+msgstr "Varna fr typkonvertering av pekare som kar justeringen"
 
 #: common.opt:70
 msgid "Warn about uses of __attribute__((deprecated)) declarations"
-msgstr "Varna om anvndning av __attribute__((deprecated))-deklarationer"
+msgstr "Varna fr anvndning av __attribute__((deprecated))-deklarationer"
 
 #: common.opt:74
 msgid "Warn when an optimization pass is disabled"
@@ -12926,15 +12926,15 @@
 
 #: common.opt:94
 msgid "Warn if an object is larger than <number> bytes"
-msgstr "Varna om ett objekt r strre n <antal> byte"
+msgstr "Varna fr ett objekt r strre n <antal> byte"
 
 #: common.opt:98
 msgid "Warn if the loop cannot be optimized due to nontrivial assumptions."
-msgstr "Varna om slingan inte kan optimeras p grund av icketriviala antaganden."
+msgstr "Varna fr slingan inte kan optimeras p grund av icketriviala antaganden."
 
 #: common.opt:102
 msgid "Warn about functions which might be candidates for __attribute__((noreturn))"
-msgstr "Varna om funktioner som r mjliga kandidater fr __attribute__((noreturn))"
+msgstr "Varna fr funktioner som r mjliga kandidater fr __attribute__((noreturn))"
 
 #: common.opt:106
 msgid "Warn when the packed attribute has no effect on struct layout"
@@ -12950,31 +12950,31 @@
 
 #: common.opt:118
 msgid "Warn when not issuing stack smashing protection for some reason"
-msgstr "Varna nr stacksprngningsskydd inte lggs ut av ngon anledning"
+msgstr "Varna nr stackverskrivningsskydd inte lggs ut av ngon anledning"
 
 #: common.opt:122 common.opt:126
 msgid "Warn about code which might break strict aliasing rules"
-msgstr "Varna om kod som kan bryta strikta aliasregler"
+msgstr "Varna fr kod som kan bryta strikta aliasregler"
 
 #: common.opt:130
 msgid "Warn about enumerated switches, with no default, missing a case"
-msgstr "Varna om upprkningshopptabeller, utan standardfall, saknar ett fall"
+msgstr "Varna nr hopptabeller fr upprkningstyper inte har standardfall och saknar ett fall"
 
 #: common.opt:134
 msgid "Warn about enumerated switches missing a \"default:\" statement"
-msgstr "Varna om upprkningshopptabeller saknar en \"default:\"-sats"
+msgstr "Varna fr upprkningshopptabeller saknar en \"default:\"-sats"
 
 #: common.opt:138
 msgid "Warn about all enumerated switches missing a specific case"
-msgstr "Varna om alla upprkningshopptabeller som saknar ett specifikt fall"
+msgstr "Varna fr alla upprkningshopptabeller som saknar ett specifikt fall"
 
 #: common.opt:146
 msgid "Warn about uninitialized automatic variables"
-msgstr "Varna om oinitierade automatiska variabler"
+msgstr "Varna fr oinitierade automatiska variabler"
 
 #: common.opt:150
 msgid "Warn about code that will never be executed"
-msgstr "Varna om kod som aldrig kommer kras"
+msgstr "Varna fr kod som aldrig kommer kras"
 
 #: common.opt:154
 msgid "Enable all -Wunused- warnings"
@@ -13106,7 +13106,7 @@
 
 #: common.opt:334
 msgid "Place data items into their own section"
-msgstr "Placera datafreml i sin egen sektion"
+msgstr "Placera dataobjekt i sin egen sektion"
 
 #: common.opt:340
 msgid "Defer popping functions args from stack until later"
@@ -13118,7 +13118,7 @@
 
 #: common.opt:348
 msgid "Delete useless null pointer checks"
-msgstr "Tag bort oanvndbara nollpekarkontroller"
+msgstr "Tag bort ondiga nollpekarkontroller"
 
 #: common.opt:352
 msgid "How often to emit source location at the beginning of line-wrapped diagnostics"
@@ -13214,7 +13214,7 @@
 
 #: common.opt:464
 msgid "Perform conversion of conditional jumps to branchless equivalents"
-msgstr "Utvr konvertering av villkorliga hopp till grenlsa motsvarigheter"
+msgstr "Utfr konvertering av villkorliga hopp till grenlsa motsvarigheter"
 
 #: common.opt:468
 msgid "Perform conversion of conditional jumps to conditional execution"
@@ -13730,15 +13730,15 @@
 
 #: common.opt:1034
 msgid "Construct webs and split unrelated uses of single variable"
-msgstr "Kostruera nt och dela orelaterade anvndningar av en enskild variabel"
+msgstr "Konstruera nt och dela orelaterade anvndningar av en enskild variabel"
 
 #: common.opt:1038
 msgid "Perform whole program optimizations"
-msgstr "Utfr optimeringav hela program"
+msgstr "Utfr optimering av hela program"
 
 #: common.opt:1042
 msgid "Assume signed arithmetic overflow wraps around"
-msgstr "Anta spill vid teckenaritmetik slr runt"
+msgstr "Anta att spill vid teckenaritmetik slr runt"
 
 #: common.opt:1046
 msgid "Put zero initialized data in the bss section"
@@ -14044,7 +14044,7 @@
 #: c-common.c:975
 #, gcc-internal-format
 msgid "type-punning to incomplete type might break strict-aliasing rules"
-msgstr "typstampning till ofullstndiga typ kan bryta strikta aliasregler"
+msgstr "typstampning till ofullstndig typ kan bryta strikta aliasregler"
 
 #: c-common.c:983
 #, gcc-internal-format
@@ -14059,7 +14059,7 @@
 #: c-common.c:1049
 #, gcc-internal-format
 msgid "overflow in implicit constant conversion"
-msgstr "spill i implicit constant konvertering"
+msgstr "spill i implicit konstant konvertering"
 
 #: c-common.c:1185
 #, gcc-internal-format
@@ -14129,12 +14129,12 @@
 #: c-common.c:2288
 #, gcc-internal-format
 msgid "pointer to a function used in arithmetic"
-msgstr "pekare till funktion anvnd med aritmetik"
+msgstr "pekare till funktion anvnd i aritmetik"
 
 #: c-common.c:2294
 #, gcc-internal-format
 msgid "pointer to member function used in arithmetic"
-msgstr "pekare till medlemsfunktion anvnd med aritmetik"
+msgstr "pekare till medlemsfunktion anvnd i aritmetik"
 
 #. Common Ada/Pascal programmer's mistake.  We always warn
 #. about this since it is so bad.
@@ -14196,7 +14196,7 @@
 #: c-common.c:3724
 #, gcc-internal-format
 msgid "duplicate (or overlapping) case value"
-msgstr "dubbla (eller verlappand) case-vrden"
+msgstr "dubbla (eller verlappande) case-vrden"
 
 #: c-common.c:3725
 #, gcc-internal-format
@@ -14236,7 +14236,7 @@
 #: c-common.c:3844
 #, gcc-internal-format
 msgid "%Hswitch missing default case"
-msgstr "%Hswitch saknare default-fall"
+msgstr "%Hswitch saknar default-fall"
 
 #. Warn if there are enumerators that don't correspond to
 #. case expressions.
@@ -14279,7 +14279,7 @@
 #: c-common.c:4540
 #, gcc-internal-format
 msgid "specifying vector types with __attribute__ ((mode)) is deprecated"
-msgstr "det avrdes frn att ange vektortyper med __attribute__ ((stt))"
+msgstr "att ange vektortyper med __attribute__ ((stt)) br unvikas"
 
 #: c-common.c:4543
 #, gcc-internal-format
@@ -14339,7 +14339,7 @@
 #: c-common.c:4708
 #, gcc-internal-format
 msgid "requested alignment is not a power of 2"
-msgstr "efterrgad minnesjustering r inte en potens av 2"
+msgstr "efterfgad minnesjustering r inte en potens av 2"
 
 #: c-common.c:4713
 #, gcc-internal-format
@@ -19077,7 +19077,7 @@
 #: stmt.c:910
 #, gcc-internal-format
 msgid "use of memory input without lvalue in asm operand %d is deprecated"
-msgstr "anvndning av minnesindata utan lvrde i asm-operand %d undanbedes"
+msgstr "anvndning av minnesindata utan lvrde i asm-operand %d br undvikas"
 
 #: stmt.c:1057
 #, gcc-internal-format
@@ -19234,22 +19234,22 @@
 #: toplev.c:892 toplev.c:916
 #, gcc-internal-format
 msgid "%qs is deprecated (declared at %s:%d)"
-msgstr "%qs undanbedes (deklarerad vid %s:%d)"
+msgstr "%qs br undvikas (deklarerad vid %s:%d)"
 
 #: toplev.c:920
 #, gcc-internal-format
 msgid "type is deprecated (declared at %s:%d)"
-msgstr "typen undanbedes (deklarerad vid %s:%d)"
+msgstr "typen br undvikas (deklarerad vid %s:%d)"
 
 #: toplev.c:926
 #, gcc-internal-format
 msgid "%qs is deprecated"
-msgstr "%qs undanbedes"
+msgstr "%qs br undvikas"
 
 #: toplev.c:928
 #, gcc-internal-format
 msgid "type is deprecated"
-msgstr "type undanbedes"
+msgstr "typen br undvikas"
 
 #: toplev.c:1095
 #, gcc-internal-format
@@ -21694,7 +21694,7 @@
 #: config/rs6000/rs6000.c:7259
 #, gcc-internal-format
 msgid "unresolved overload for Altivec builtin %qF"
-msgstr "ej upplst verlastning fr inbyggd Altivec %qF"
+msgstr "ej upplst verlagring fr inbyggd Altivec %qF"
 
 #: config/rs6000/rs6000.c:7341
 #, gcc-internal-format
@@ -21729,7 +21729,7 @@
 #: config/rs6000/rs6000.c:17299
 #, gcc-internal-format
 msgid "use of %<long%> in AltiVec types is deprecated; use %<int%>"
-msgstr "anvndning av %<long%> i AltiVec-typer undanbedes, anvnd %<int%>"
+msgstr "anvndning av %<long%> i AltiVec-typer br undvikas, anvnd %<int%>"
 
 #: config/rs6000/rs6000.c:17303
 #, gcc-internal-format
@@ -22307,7 +22307,7 @@
 #: cp/call.c:2800 cp/call.c:2858
 #, gcc-internal-format
 msgid "call of overloaded %<%D(%A)%> is ambiguous"
-msgstr "anrop av verlastad %<%D(%A)%> r tvetydigt"
+msgstr "anrop av verlagrad %<%D(%A)%> r tvetydigt"
 
 #. It's no good looking for an overloaded operator() on a
 #. pointer-to-member-function.
@@ -22522,7 +22522,7 @@
 #: cp/call.c:5404
 #, gcc-internal-format
 msgid "call of overloaded %<%s(%A)%> is ambiguous"
-msgstr "anrop av verlastad %<%s(%A)%> r tvetydigt"
+msgstr "anrop av verlagrad %<%s(%A)%> r tvetydigt"
 
 #: cp/call.c:5428
 #, gcc-internal-format
@@ -22602,7 +22602,7 @@
 #: cp/class.c:1061
 #, gcc-internal-format
 msgid "%q+#D cannot be overloaded"
-msgstr "%q+#D kan inte verlastas"
+msgstr "%q+#D kan inte verlagras"
 
 #: cp/class.c:1062
 #, gcc-internal-format
@@ -22880,7 +22880,7 @@
 #: cp/class.c:5714
 #, gcc-internal-format
 msgid "cannot resolve overloaded function %qD based on conversion to type %qT"
-msgstr "det gr inte att lsa upp  verlastad funktion %qD baserat p konvertering till typ %qT"
+msgstr "det gr inte att lsa upp verlagrad funktion %qD baserat p konvertering till typ %qT"
 
 #: cp/class.c:5841
 #, gcc-internal-format
@@ -22890,7 +22890,7 @@
 #: cp/class.c:5864
 #, gcc-internal-format
 msgid "converting overloaded function %qD to type %q#T is ambiguous"
-msgstr "konvertering av verlastad funktion %qD till typ %q#T r tvetydig"
+msgstr "konvertering av verlagrad funktion %qD till typ %q#T r tvetydig"
 
 #: cp/class.c:5890
 #, gcc-internal-format
@@ -23022,7 +23022,7 @@
 #: cp/cvt.c:902
 #, gcc-internal-format
 msgid "%s cannot resolve address of overloaded function"
-msgstr "%s kan inte lsa upp adress till verlastad funktion"
+msgstr "%s kan inte lsa upp adress till verlagrad funktion"
 
 #. Only warn when there is no &.
 #: cp/cvt.c:908
@@ -23565,7 +23565,7 @@
 #: cp/decl.c:4387
 #, gcc-internal-format
 msgid "braces around scalar initializer for type %qT"
-msgstr "klamrar funt skalr initierare fr typen %qT"
+msgstr "klamrar runt skalr initierare fr typen %qT"
 
 #: cp/decl.c:4465
 #, gcc-internal-format
@@ -24427,7 +24427,7 @@
 #: cp/decl.c:9012
 #, gcc-internal-format
 msgid "ISO C++ prohibits overloading operator ?:"
-msgstr "ISO C++ frhindrar verlastning av operatorn ?:"
+msgstr "ISO C++ frhindrar verlagring av operatorn ?:"
 
 #: cp/decl.c:9015
 #, gcc-internal-format
@@ -24848,7 +24848,7 @@
 #: cp/except.c:631 cp/init.c:1929
 #, gcc-internal-format
 msgid "%qD should never be overloaded"
-msgstr "%qD skall aldrig verlastas"
+msgstr "%qD skall aldrig verlagras"
 
 #: cp/except.c:698
 #, gcc-internal-format
@@ -25242,7 +25242,7 @@
 #: cp/lex.c:651
 #, gcc-internal-format
 msgid "(if you use %<-fpermissive%>, G++ will accept your code, but allowing the use of an undeclared name is deprecated)"
-msgstr "(om du anvnder %<-fpermissive%>, kommer G++ acceptera din kod, men det avrdes frn att tillta anvndning av ett odeklarerat namn)"
+msgstr "(om du anvnder %<-fpermissive%>, kommer G++ acceptera din kod, men man br undvika att tillta anvndning av ett odeklarerat namn)"
 
 #: cp/mangle.c:2139
 #, gcc-internal-format
@@ -25562,7 +25562,7 @@
 #: cp/parser.c:1875
 #, gcc-internal-format
 msgid "minimum/maximum operators are deprecated"
-msgstr "minimum-/maximumoperatorer undanbedes"
+msgstr "minimum-/maximumoperatorer br undvikas"
 
 #: cp/parser.c:1895
 #, gcc-internal-format
@@ -25905,7 +25905,7 @@
 #: cp/parser.c:12370
 #, gcc-internal-format
 msgid "deprecated use of default argument for parameter of non-function"
-msgstr "undanbedd anvndning av standardargument fr parametrar till annat n funktioner"
+msgstr "anvndning av standardargument fr parametrar till annat n funktioner br undvikas"
 
 #: cp/parser.c:12373
 #, gcc-internal-format
@@ -26728,7 +26728,7 @@
 #: cp/search.c:1847
 #, gcc-internal-format
 msgid "deprecated covariant return type for %q+#D"
-msgstr "undanbedd kovariant returtyp fr %q+#D"
+msgstr "kovariant returtyp fr %q+#D br undvikas"
 
 #: cp/search.c:1849 cp/search.c:1864 cp/search.c:1869
 #, gcc-internal-format
@@ -27013,7 +27013,7 @@
 #: cp/typeck.c:1502
 #, gcc-internal-format
 msgid "deprecated conversion from string constant to %qT'"
-msgstr "undanbedd konvertering frn strngkonstant till %qT'"
+msgstr "konvertering frn strngkonstant till %qT' br undvikas"
 
 #: cp/typeck.c:1613 cp/typeck.c:1961
 #, gcc-internal-format
@@ -27155,7 +27155,7 @@
 #: cp/typeck.c:2885 cp/typeck.c:2895
 #, gcc-internal-format
 msgid "assuming cast to type %qT from overloaded function"
-msgstr "antar typkonvertering till %qT frn verlastad funktion"
+msgstr "antar typkonvertering till %qT frn verlagrad funktion"
 
 #: cp/typeck.c:2963
 #, gcc-internal-format
Index: gcc-4_2-branch/gcc/sched-deps.c
===================================================================
--- gcc-4_2-branch/gcc/sched-deps.c	(revision 123014)
+++ gcc-4_2-branch/gcc/sched-deps.c	(revision 124164)
@@ -1238,8 +1238,12 @@
 
   /* If this instruction can throw an exception, then moving it changes
      where block boundaries fall.  This is mighty confusing elsewhere.
-     Therefore, prevent such an instruction from being moved.  */
-  if (can_throw_internal (insn))
+     Therefore, prevent such an instruction from being moved.  Same for
+     non-jump instructions that define block boundaries.
+     ??? Unclear whether this is still necessary in EBB mode.  If not,
+     add_branch_dependences should be adjusted for RGN mode instead.  */
+  if (((CALL_P (insn) || JUMP_P (insn)) && can_throw_internal (insn))
+      || (NONJUMP_INSN_P (insn) && control_flow_insn_p (insn)))
     reg_pending_barrier = MOVE_BARRIER;
 
   /* Add dependencies if a scheduling barrier was found.  */
Index: gcc-4_2-branch/gcc/tree-cfg.c
===================================================================
--- gcc-4_2-branch/gcc/tree-cfg.c	(revision 123014)
+++ gcc-4_2-branch/gcc/tree-cfg.c	(revision 124164)
@@ -439,7 +439,9 @@
 	  cond = fold (COND_EXPR_COND (stmt));
 	  zerop = integer_zerop (cond);
 	  onep = integer_onep (cond);
-	  fold_undefer_overflow_warnings (zerop || onep, stmt,
+	  fold_undefer_overflow_warnings (((zerop || onep)
+					   && !TREE_NO_WARNING (stmt)),
+					  stmt,
 					  WARN_STRICT_OVERFLOW_CONDITIONAL);
 	  if (zerop)
 	    COND_EXPR_COND (stmt) = boolean_false_node;
@@ -2121,8 +2123,19 @@
     return find_taken_edge_switch_expr (bb, val);
 
   if (computed_goto_p (stmt))
-    return find_taken_edge_computed_goto (bb, TREE_OPERAND( val, 0));
+    {
+      /* Only optimize if the argument is a label, if the argument is
+	 not a label then we can not construct a proper CFG.
 
+         It may be the case that we only need to allow the LABEL_REF to
+         appear inside an ADDR_EXPR, but we also allow the LABEL_REF to
+         appear inside a LABEL_EXPR just to be safe.  */
+      if ((TREE_CODE (val) == ADDR_EXPR || TREE_CODE (val) == LABEL_EXPR)
+	  && TREE_CODE (TREE_OPERAND (val, 0)) == LABEL_DECL)
+	return find_taken_edge_computed_goto (bb, TREE_OPERAND (val, 0));
+      return NULL;
+    }
+
   gcc_unreachable ();
 }
 
Index: gcc-4_2-branch/gcc/config/alpha/linux.h
===================================================================
--- gcc-4_2-branch/gcc/config/alpha/linux.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/alpha/linux.h	(revision 124164)
@@ -44,6 +44,9 @@
    %{shared:-lc} \
    %{!shared: %{profile:-lc_p}%{!profile:-lc}}"
 
+#undef CPP_SPEC
+#define CPP_SPEC "%{posix:-D_POSIX_SOURCE} %{pthread:-D_REENTRANT}"
+
 /* Show that we need a GP when profiling.  */
 #undef TARGET_PROFILING_NEEDS_GP
 #define TARGET_PROFILING_NEEDS_GP 1
Index: gcc-4_2-branch/gcc/config/alpha/alpha.c
===================================================================
--- gcc-4_2-branch/gcc/config/alpha/alpha.c	(revision 123014)
+++ gcc-4_2-branch/gcc/config/alpha/alpha.c	(revision 124164)
@@ -1549,7 +1549,7 @@
    Add EXTRA_OFFSET to the address we return.  */
 
 rtx
-get_unaligned_address (rtx ref, int extra_offset)
+get_unaligned_address (rtx ref)
 {
   rtx base;
   HOST_WIDE_INT offset = 0;
@@ -1569,9 +1569,25 @@
   if (GET_CODE (base) == PLUS)
     offset += INTVAL (XEXP (base, 1)), base = XEXP (base, 0);
 
-  return plus_constant (base, offset + extra_offset);
+  return plus_constant (base, offset);
 }
 
+/* Compute a value X, such that X & 7 == (ADDR + OFS) & 7.
+   X is always returned in a register.  */
+
+rtx
+get_unaligned_offset (rtx addr, HOST_WIDE_INT ofs)
+{
+  if (GET_CODE (addr) == PLUS)
+    {
+      ofs += INTVAL (XEXP (addr, 1));
+      addr = XEXP (addr, 0);
+    }
+
+  return expand_simple_binop (Pmode, PLUS, addr, GEN_INT (ofs & 7),
+			      NULL_RTX, 1, OPTAB_LIB_WIDEN);
+}
+
 /* On the Alpha, all (non-symbolic) constants except zero go into
    a floating-point register via memory.  Note that we cannot
    return anything that is not a subset of CLASS, and that some
@@ -2318,7 +2334,7 @@
 	  seq = ((mode == QImode
 		  ? gen_unaligned_loadqi
 		  : gen_unaligned_loadhi)
-		 (subtarget, get_unaligned_address (operands[1], 0),
+		 (subtarget, get_unaligned_address (operands[1]),
 		  temp1, temp2));
 	  alpha_set_memflags (seq, operands[1]);
 	  emit_insn (seq);
@@ -2357,7 +2373,7 @@
 	  rtx seq = ((mode == QImode
 		      ? gen_unaligned_storeqi
 		      : gen_unaligned_storehi)
-		     (get_unaligned_address (operands[0], 0),
+		     (get_unaligned_address (operands[0]),
 		      operands[1], temp1, temp2, temp3));
 
 	  alpha_set_memflags (seq, operands[0]);
Index: gcc-4_2-branch/gcc/config/alpha/alpha.md
===================================================================
--- gcc-4_2-branch/gcc/config/alpha/alpha.md	(revision 123014)
+++ gcc-4_2-branch/gcc/config/alpha/alpha.md	(revision 124164)
@@ -1607,10 +1607,7 @@
 
   if (unaligned_memory_operand (operands[1], QImode))
     {
-      rtx seq
-	= gen_unaligned_extendqidi (operands[0],
-				    get_unaligned_address (operands[1], 1));
-
+      rtx seq = gen_unaligned_extendqidi (operands[0], XEXP (operands[1], 0));
       alpha_set_memflags (seq, operands[1]);
       emit_insn (seq);
       DONE;
@@ -1670,9 +1667,7 @@
 
   if (unaligned_memory_operand (operands[1], HImode))
     {
-      rtx seq
-	= gen_unaligned_extendhidi (operands[0],
-				    get_unaligned_address (operands[1], 2));
+      rtx seq = gen_unaligned_extendhidi (operands[0], XEXP (operands[1], 0));
 
       alpha_set_memflags (seq, operands[1]);
       emit_insn (seq);
@@ -1687,12 +1682,13 @@
 ;; as a pattern saves one instruction.  The code is similar to that for
 ;; the unaligned loads (see below).
 ;;
-;; Operand 1 is the address + 1 (+2 for HI), operand 0 is the result.
+;; Operand 1 is the address, operand 0 is the result.
 (define_expand "unaligned_extendqidi"
   [(use (match_operand:QI 0 "register_operand" ""))
    (use (match_operand:DI 1 "address_operand" ""))]
   ""
 {
+  operands[0] = gen_lowpart (DImode, operands[0]);
   if (WORDS_BIG_ENDIAN)
     emit_insn (gen_unaligned_extendqidi_be (operands[0], operands[1]));
   else
@@ -1701,48 +1697,40 @@
 })
 
 (define_expand "unaligned_extendqidi_le"
-  [(set (match_dup 2) (match_operand:DI 1 "address_operand" ""))
-   (set (match_dup 3)
-	(mem:DI (and:DI (plus:DI (match_dup 2) (const_int -1))
-			(const_int -8))))
+  [(set (match_dup 3)
+	(mem:DI (and:DI (match_operand:DI 1 "" "") (const_int -8))))
    (set (match_dup 4)
 	(ashift:DI (match_dup 3)
 		   (minus:DI (const_int 64)
 			     (ashift:DI
 			      (and:DI (match_dup 2) (const_int 7))
 			      (const_int 3)))))
-   (set (subreg:DI (match_operand:QI 0 "register_operand" "") 0)
+   (set (match_operand:DI 0 "register_operand" "")
 	(ashiftrt:DI (match_dup 4) (const_int 56)))]
   "! WORDS_BIG_ENDIAN"
 {
-  operands[2] = gen_reg_rtx (DImode);
+  operands[2] = get_unaligned_offset (operands[1], 1);
   operands[3] = gen_reg_rtx (DImode);
   operands[4] = gen_reg_rtx (DImode);
 })
 
 (define_expand "unaligned_extendqidi_be"
-  [(set (match_dup 2) (match_operand:DI 1 "address_operand" ""))
-   (set (match_dup 3) (plus:DI (match_dup 2) (const_int -1)))
+  [(set (match_dup 3)
+	(mem:DI (and:DI (match_operand:DI 1 "" "") (const_int -8))))
    (set (match_dup 4)
-	(mem:DI (and:DI (match_dup 3)
-			(const_int -8))))
-   (set (match_dup 5) (plus:DI (match_dup 2) (const_int -2)))
-   (set (match_dup 6)
-	(ashift:DI (match_dup 4)
+	(ashift:DI (match_dup 3)
 		   (ashift:DI
 		     (and:DI
-		       (plus:DI (match_dup 5) (const_int 1))
+		       (plus:DI (match_dup 2) (const_int 1))
 		       (const_int 7))
 		     (const_int 3))))
-   (set (subreg:DI (match_operand:QI 0 "register_operand" "") 0)
-	(ashiftrt:DI (match_dup 6) (const_int 56)))]
+   (set (match_operand:DI 0 "register_operand" "")
+	(ashiftrt:DI (match_dup 4) (const_int 56)))]
   "WORDS_BIG_ENDIAN"
 {
-  operands[2] = gen_reg_rtx (DImode);
+  operands[2] = get_unaligned_offset (operands[1], -1);
   operands[3] = gen_reg_rtx (DImode);
   operands[4] = gen_reg_rtx (DImode);
-  operands[5] = gen_reg_rtx (DImode);
-  operands[6] = gen_reg_rtx (DImode);
 })
 
 (define_expand "unaligned_extendhidi"
@@ -1751,17 +1739,16 @@
   ""
 {
   operands[0] = gen_lowpart (DImode, operands[0]);
-  emit_insn ((WORDS_BIG_ENDIAN
-	      ? gen_unaligned_extendhidi_be
-	      : gen_unaligned_extendhidi_le) (operands[0], operands[1]));
+  if (WORDS_BIG_ENDIAN)
+    emit_insn (gen_unaligned_extendhidi_be (operands[0], operands[1]));
+  else
+    emit_insn (gen_unaligned_extendhidi_le (operands[0], operands[1]));
   DONE;
 })
 
 (define_expand "unaligned_extendhidi_le"
-  [(set (match_dup 2) (match_operand:DI 1 "address_operand" ""))
-   (set (match_dup 3)
-	(mem:DI (and:DI (plus:DI (match_dup 2) (const_int -2))
-			(const_int -8))))
+  [(set (match_dup 3)
+	(mem:DI (and:DI (match_operand:DI 1 "" "") (const_int -8))))
    (set (match_dup 4)
 	(ashift:DI (match_dup 3)
 		   (minus:DI (const_int 64)
@@ -1772,34 +1759,28 @@
 	(ashiftrt:DI (match_dup 4) (const_int 48)))]
   "! WORDS_BIG_ENDIAN"
 {
-  operands[2] = gen_reg_rtx (DImode);
+  operands[2] = get_unaligned_offset (operands[1], 2);
   operands[3] = gen_reg_rtx (DImode);
   operands[4] = gen_reg_rtx (DImode);
 })
 
 (define_expand "unaligned_extendhidi_be"
-  [(set (match_dup 2) (match_operand:DI 1 "address_operand" ""))
-   (set (match_dup 3) (plus:DI (match_dup 2) (const_int -2)))
+  [(set (match_dup 3)
+	(mem:DI (and:DI (match_operand:DI 1 "" "") (const_int -8))))
    (set (match_dup 4)
-	(mem:DI (and:DI (match_dup 3)
-			(const_int -8))))
-   (set (match_dup 5) (plus:DI (match_dup 2) (const_int -3)))
-   (set (match_dup 6)
-	(ashift:DI (match_dup 4)
+	(ashift:DI (match_dup 3)
 		   (ashift:DI
 		     (and:DI
-		       (plus:DI (match_dup 5) (const_int 1))
+		       (plus:DI (match_dup 2) (const_int 1))
 		       (const_int 7))
 		     (const_int 3))))
    (set (match_operand:DI 0 "register_operand" "")
-	(ashiftrt:DI (match_dup 6) (const_int 48)))]
+	(ashiftrt:DI (match_dup 4) (const_int 48)))]
   "WORDS_BIG_ENDIAN"
 {
-  operands[2] = gen_reg_rtx (DImode);
+  operands[2] = get_unaligned_offset (operands[1], -1);
   operands[3] = gen_reg_rtx (DImode);
   operands[4] = gen_reg_rtx (DImode);
-  operands[5] = gen_reg_rtx (DImode);
-  operands[6] = gen_reg_rtx (DImode);
 })
 
 (define_insn "*extxl_const"
@@ -6065,7 +6046,7 @@
       else
 	scratch = gen_rtx_REG (DImode, REGNO (operands[2]));
 
-      addr = get_unaligned_address (operands[1], 0);
+      addr = get_unaligned_address (operands[1]);
       operands[0] = gen_rtx_REG (DImode, REGNO (operands[0]));
       seq = gen_unaligned_loadqi (operands[0], addr, scratch, operands[0]);
       alpha_set_memflags (seq, operands[1]);
@@ -6099,7 +6080,7 @@
       else
 	scratch = gen_rtx_REG (DImode, REGNO (operands[2]));
 
-      addr = get_unaligned_address (operands[1], 0);
+      addr = get_unaligned_address (operands[1]);
       operands[0] = gen_rtx_REG (DImode, REGNO (operands[0]));
       seq = gen_unaligned_loadhi (operands[0], addr, scratch, operands[0]);
       alpha_set_memflags (seq, operands[1]);
@@ -6123,7 +6104,7 @@
     }
   else
     {
-      rtx addr = get_unaligned_address (operands[0], 0);
+      rtx addr = get_unaligned_address (operands[0]);
       rtx scratch1 = gen_rtx_REG (DImode, REGNO (operands[2]));
       rtx scratch2 = gen_rtx_REG (DImode, REGNO (operands[2]) + 1);
       rtx scratch3 = scratch1;
@@ -6155,7 +6136,7 @@
     }
   else
     {
-      rtx addr = get_unaligned_address (operands[0], 0);
+      rtx addr = get_unaligned_address (operands[0]);
       rtx scratch1 = gen_rtx_REG (DImode, REGNO (operands[2]));
       rtx scratch2 = gen_rtx_REG (DImode, REGNO (operands[2]) + 1);
       rtx scratch3 = scratch1;
Index: gcc-4_2-branch/gcc/config/alpha/alpha-protos.h
===================================================================
--- gcc-4_2-branch/gcc/config/alpha/alpha-protos.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/alpha/alpha-protos.h	(revision 124164)
@@ -51,7 +51,8 @@
 extern rtx split_small_symbolic_operand (rtx);
 
 extern void get_aligned_mem (rtx, rtx *, rtx *);
-extern rtx get_unaligned_address (rtx, int);
+extern rtx get_unaligned_address (rtx);
+extern rtx get_unaligned_offset (rtx, HOST_WIDE_INT);
 extern enum reg_class alpha_preferred_reload_class (rtx, enum reg_class);
 extern enum reg_class alpha_secondary_reload_class (enum reg_class,
 						    enum machine_mode, rtx,
Index: gcc-4_2-branch/gcc/config/s390/s390.c
===================================================================
--- gcc-4_2-branch/gcc/config/s390/s390.c	(revision 123014)
+++ gcc-4_2-branch/gcc/config/s390/s390.c	(revision 124164)
@@ -3555,7 +3555,7 @@
       if (temp != count)
         emit_move_insn (count, temp);
 
-      temp = expand_binop (mode, ashr_optab, count, GEN_INT (8), blocks, 1, 0);
+      temp = expand_binop (mode, lshr_optab, count, GEN_INT (8), blocks, 1, 0);
       if (temp != blocks)
         emit_move_insn (blocks, temp);
 
@@ -3592,10 +3592,12 @@
 void
 s390_expand_setmem (rtx dst, rtx len, rtx val)
 {
-  gcc_assert (GET_CODE (len) != CONST_INT || INTVAL (len) > 0);
+  if (GET_CODE (len) == CONST_INT && INTVAL (len) == 0)
+    return;
+
   gcc_assert (GET_CODE (val) == CONST_INT || GET_MODE (val) == QImode);
   
-  if (GET_CODE (len) == CONST_INT && INTVAL (len) <= 257)
+  if (GET_CODE (len) == CONST_INT && INTVAL (len) > 0 && INTVAL (len) <= 257)
     {
       if (val == const0_rtx && INTVAL (len) <= 256)
         emit_insn (gen_clrmem_short (dst, GEN_INT (INTVAL (len) - 1)));
@@ -3669,7 +3671,7 @@
       if (temp != count)
         emit_move_insn (count, temp);
 
-      temp = expand_binop (mode, ashr_optab, count, GEN_INT (8), blocks, 1, 0);
+      temp = expand_binop (mode, lshr_optab, count, GEN_INT (8), blocks, 1, 0);
       if (temp != blocks)
         emit_move_insn (blocks, temp);
 
@@ -3761,7 +3763,7 @@
       if (temp != count)
         emit_move_insn (count, temp);
 
-      temp = expand_binop (mode, ashr_optab, count, GEN_INT (8), blocks, 1, 0);
+      temp = expand_binop (mode, lshr_optab, count, GEN_INT (8), blocks, 1, 0);
       if (temp != blocks)
         emit_move_insn (blocks, temp);
 
Index: gcc-4_2-branch/gcc/config/i386/mmintrin.h
===================================================================
--- gcc-4_2-branch/gcc/config/i386/mmintrin.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/i386/mmintrin.h	(revision 124164)
@@ -1,4 +1,4 @@
-/* Copyright (C) 2002, 2003, 2004, 2005, 2006
+/* Copyright (C) 2002, 2003, 2004, 2005, 2006, 2007
    Free Software Foundation, Inc.
 
    This file is part of GCC.
@@ -34,8 +34,9 @@
 #ifndef __MMX__
 # error "MMX instruction set not enabled"
 #else
-/* The data type intended for user use.  */
-typedef int __m64 __attribute__ ((__vector_size__ (8)));
+/* The Intel API is flexible enough that we must allow aliasing with other
+   vector types, and their scalar components.  */
+typedef int __m64 __attribute__ ((__vector_size__ (8), __may_alias__));
 
 /* Internal data types for implementing the intrinsics.  */
 typedef int __v2si __attribute__ ((__vector_size__ (8)));
Index: gcc-4_2-branch/gcc/config/i386/xmmintrin.h
===================================================================
--- gcc-4_2-branch/gcc/config/i386/xmmintrin.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/i386/xmmintrin.h	(revision 124164)
@@ -1,4 +1,4 @@
-/* Copyright (C) 2002, 2003, 2004, 2005, 2006
+/* Copyright (C) 2002, 2003, 2004, 2005, 2006, 2007
    Free Software Foundation, Inc.
 
    This file is part of GCC.
@@ -41,8 +41,9 @@
 /* Get _mm_malloc () and _mm_free ().  */
 #include <mm_malloc.h>
 
-/* The data type intended for user use.  */
-typedef float __m128 __attribute__ ((__vector_size__ (16)));
+/* The Intel API is flexible enough that we must allow aliasing with other
+   vector types, and their scalar components.  */
+typedef float __m128 __attribute__ ((__vector_size__ (16), __may_alias__));
 
 /* Internal data types for implementing the intrinsics.  */
 typedef float __v4sf __attribute__ ((__vector_size__ (16)));
Index: gcc-4_2-branch/gcc/config/i386/sse.md
===================================================================
--- gcc-4_2-branch/gcc/config/i386/sse.md	(revision 123014)
+++ gcc-4_2-branch/gcc/config/i386/sse.md	(revision 124164)
@@ -304,7 +304,7 @@
 (define_insn "sse_vmaddv4sf3"
   [(set (match_operand:V4SF 0 "register_operand" "=x")
 	(vec_merge:V4SF
-	  (plus:V4SF (match_operand:V4SF 1 "nonimmediate_operand" "%0")
+	  (plus:V4SF (match_operand:V4SF 1 "register_operand" "0")
 		     (match_operand:V4SF 2 "nonimmediate_operand" "xm"))
 	  (match_dup 1)
 	  (const_int 1)))]
@@ -360,7 +360,7 @@
 (define_insn "sse_vmmulv4sf3"
   [(set (match_operand:V4SF 0 "register_operand" "=x")
 	(vec_merge:V4SF
-	  (mult:V4SF (match_operand:V4SF 1 "nonimmediate_operand" "%0")
+	  (mult:V4SF (match_operand:V4SF 1 "register_operand" "0")
 		     (match_operand:V4SF 2 "nonimmediate_operand" "xm"))
 	  (match_dup 1)
 	  (const_int 1)))]
@@ -492,19 +492,6 @@
   [(set_attr "type" "sse")
    (set_attr "mode" "V4SF")])
 
-(define_insn "*sse_vmsmaxv4sf3_finite"
-  [(set (match_operand:V4SF 0 "register_operand" "=x")
-	(vec_merge:V4SF
-	 (smax:V4SF (match_operand:V4SF 1 "nonimmediate_operand" "%0")
-		    (match_operand:V4SF 2 "nonimmediate_operand" "xm"))
-	 (match_dup 1)
-	 (const_int 1)))]
-  "TARGET_SSE && flag_finite_math_only
-   && ix86_binary_operator_ok (SMAX, V4SFmode, operands)"
-  "maxss\t{%2, %0|%0, %2}"
-  [(set_attr "type" "sse")
-   (set_attr "mode" "SF")])
-
 (define_insn "sse_vmsmaxv4sf3"
   [(set (match_operand:V4SF 0 "register_operand" "=x")
 	(vec_merge:V4SF
@@ -547,19 +534,6 @@
   [(set_attr "type" "sse")
    (set_attr "mode" "V4SF")])
 
-(define_insn "*sse_vmsminv4sf3_finite"
-  [(set (match_operand:V4SF 0 "register_operand" "=x")
-	(vec_merge:V4SF
-	 (smin:V4SF (match_operand:V4SF 1 "nonimmediate_operand" "%0")
-		    (match_operand:V4SF 2 "nonimmediate_operand" "xm"))
-	 (match_dup 1)
-	 (const_int 1)))]
-  "TARGET_SSE && flag_finite_math_only
-   && ix86_binary_operator_ok (SMIN, V4SFmode, operands)"
-  "minss\t{%2, %0|%0, %2}"
-  [(set_attr "type" "sse")
-   (set_attr "mode" "SF")])
-
 (define_insn "sse_vmsminv4sf3"
   [(set (match_operand:V4SF 0 "register_operand" "=x")
 	(vec_merge:V4SF
@@ -1398,7 +1372,7 @@
 (define_insn "sse2_vmaddv2df3"
   [(set (match_operand:V2DF 0 "register_operand" "=x")
 	(vec_merge:V2DF
-	  (plus:V2DF (match_operand:V2DF 1 "nonimmediate_operand" "%0")
+	  (plus:V2DF (match_operand:V2DF 1 "register_operand" "0")
 		     (match_operand:V2DF 2 "nonimmediate_operand" "xm"))
 	  (match_dup 1)
 	  (const_int 1)))]
@@ -1454,7 +1428,7 @@
 (define_insn "sse2_vmmulv2df3"
   [(set (match_operand:V2DF 0 "register_operand" "=x")
 	(vec_merge:V2DF
-	  (mult:V2DF (match_operand:V2DF 1 "nonimmediate_operand" "%0")
+	  (mult:V2DF (match_operand:V2DF 1 "register_operand" "0")
 		     (match_operand:V2DF 2 "nonimmediate_operand" "xm"))
 	  (match_dup 1)
 	  (const_int 1)))]
@@ -1544,19 +1518,6 @@
   [(set_attr "type" "sseadd")
    (set_attr "mode" "V2DF")])
 
-(define_insn "*sse2_vmsmaxv2df3_finite"
-  [(set (match_operand:V2DF 0 "register_operand" "=x")
-	(vec_merge:V2DF
-	  (smax:V2DF (match_operand:V2DF 1 "nonimmediate_operand" "%0")
-		     (match_operand:V2DF 2 "nonimmediate_operand" "xm"))
-	  (match_dup 1)
-	  (const_int 1)))]
-  "TARGET_SSE2 && flag_finite_math_only
-   && ix86_binary_operator_ok (SMAX, V2DFmode, operands)"
-  "maxsd\t{%2, %0|%0, %2}"
-  [(set_attr "type" "sseadd")
-   (set_attr "mode" "DF")])
-
 (define_insn "sse2_vmsmaxv2df3"
   [(set (match_operand:V2DF 0 "register_operand" "=x")
 	(vec_merge:V2DF
@@ -1599,19 +1560,6 @@
   [(set_attr "type" "sseadd")
    (set_attr "mode" "V2DF")])
 
-(define_insn "*sse2_vmsminv2df3_finite"
-  [(set (match_operand:V2DF 0 "register_operand" "=x")
-	(vec_merge:V2DF
-	  (smin:V2DF (match_operand:V2DF 1 "nonimmediate_operand" "%0")
-		     (match_operand:V2DF 2 "nonimmediate_operand" "xm"))
-	  (match_dup 1)
-	  (const_int 1)))]
-  "TARGET_SSE2 && flag_finite_math_only
-   && ix86_binary_operator_ok (SMIN, V2DFmode, operands)"
-  "minsd\t{%2, %0|%0, %2}"
-  [(set_attr "type" "sseadd")
-   (set_attr "mode" "DF")])
-
 (define_insn "sse2_vmsminv2df3"
   [(set (match_operand:V2DF 0 "register_operand" "=x")
 	(vec_merge:V2DF
@@ -2778,7 +2726,7 @@
   [(set (match_operand:SSEMODE24 0 "register_operand" "=x")
 	(ashiftrt:SSEMODE24
 	  (match_operand:SSEMODE24 1 "register_operand" "0")
-	  (match_operand:SI 2 "nonmemory_operand" "xi")))]
+	  (match_operand:TI 2 "nonmemory_operand" "xn")))]
   "TARGET_SSE2"
   "psra<ssevecsize>\t{%2, %0|%0, %2}"
   [(set_attr "type" "sseishft")
@@ -2788,7 +2736,7 @@
   [(set (match_operand:SSEMODE248 0 "register_operand" "=x")
 	(lshiftrt:SSEMODE248
 	  (match_operand:SSEMODE248 1 "register_operand" "0")
-	  (match_operand:SI 2 "nonmemory_operand" "xi")))]
+	  (match_operand:TI 2 "nonmemory_operand" "xn")))]
   "TARGET_SSE2"
   "psrl<ssevecsize>\t{%2, %0|%0, %2}"
   [(set_attr "type" "sseishft")
@@ -2798,7 +2746,7 @@
   [(set (match_operand:SSEMODE248 0 "register_operand" "=x")
 	(ashift:SSEMODE248
 	  (match_operand:SSEMODE248 1 "register_operand" "0")
-	  (match_operand:SI 2 "nonmemory_operand" "xi")))]
+	  (match_operand:TI 2 "nonmemory_operand" "xn")))]
   "TARGET_SSE2"
   "psll<ssevecsize>\t{%2, %0|%0, %2}"
   [(set_attr "type" "sseishft")
@@ -2942,7 +2890,7 @@
 	(umin:V16QI (match_operand:V16QI 1 "nonimmediate_operand" "")
 		    (match_operand:V16QI 2 "nonimmediate_operand" "")))]
   "TARGET_SSE2"
-  "ix86_fixup_binary_operands_no_copy (UMAX, V16QImode, operands);")
+  "ix86_fixup_binary_operands_no_copy (UMIN, V16QImode, operands);")
 
 (define_insn "*uminv16qi3"
   [(set (match_operand:V16QI 0 "register_operand" "=x")
Index: gcc-4_2-branch/gcc/config/i386/emmintrin.h
===================================================================
--- gcc-4_2-branch/gcc/config/i386/emmintrin.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/i386/emmintrin.h	(revision 124164)
@@ -1,4 +1,4 @@
-/* Copyright (C) 2003, 2004, 2005, 2006 Free Software Foundation, Inc.
+/* Copyright (C) 2003, 2004, 2005, 2006, 2007 Free Software Foundation, Inc.
 
    This file is part of GCC.
 
@@ -40,8 +40,10 @@
 typedef short __v8hi __attribute__ ((__vector_size__ (16)));
 typedef char __v16qi __attribute__ ((__vector_size__ (16)));
 
-typedef __v2di __m128i;
-typedef __v2df __m128d;
+/* The Intel API is flexible enough that we must allow aliasing with other
+   vector types, and their scalar components.  */
+typedef long long __m128i __attribute__ ((__vector_size__ (16), __may_alias__));
+typedef double __m128d __attribute__ ((__vector_size__ (16), __may_alias__));
 
 /* Create a selector for use with the SHUFPD instruction.  */
 #define _MM_SHUFFLE2(fp1,fp0) \
@@ -1098,6 +1100,7 @@
   return (__m128i)__builtin_ia32_pmuludq128 ((__v4si)__A, (__v4si)__B);
 }
 
+#if 0
 static __inline __m128i __attribute__((__always_inline__))
 _mm_slli_epi16 (__m128i __A, int __B)
 {
@@ -1115,7 +1118,16 @@
 {
   return (__m128i)__builtin_ia32_psllqi128 ((__v2di)__A, __B);
 }
+#else
+#define _mm_slli_epi16(__A, __B) \
+  ((__m128i)__builtin_ia32_psllwi128 ((__v8hi)(__A), __B))
+#define _mm_slli_epi32(__A, __B) \
+  ((__m128i)__builtin_ia32_pslldi128 ((__v8hi)(__A), __B))
+#define _mm_slli_epi64(__A, __B) \
+  ((__m128i)__builtin_ia32_psllqi128 ((__v8hi)(__A), __B))
+#endif
 
+#if 0
 static __inline __m128i __attribute__((__always_inline__))
 _mm_srai_epi16 (__m128i __A, int __B)
 {
@@ -1127,18 +1139,24 @@
 {
   return (__m128i)__builtin_ia32_psradi128 ((__v4si)__A, __B);
 }
+#else
+#define _mm_srai_epi16(__A, __B) \
+  ((__m128i)__builtin_ia32_psrawi128 ((__v8hi)(__A), __B))
+#define _mm_srai_epi32(__A, __B) \
+  ((__m128i)__builtin_ia32_psradi128 ((__v8hi)(__A), __B))
+#endif
 
 #if 0
 static __m128i __attribute__((__always_inline__))
-_mm_srli_si128 (__m128i __A, const int __B)
+_mm_srli_si128 (__m128i __A, int __B)
 {
-  return ((__m128i)__builtin_ia32_psrldqi128 (__A, __B))
+  return ((__m128i)__builtin_ia32_psrldqi128 (__A, __B * 8));
 }
 
 static __m128i __attribute__((__always_inline__))
-_mm_srli_si128 (__m128i __A, const int __B)
+_mm_srli_si128 (__m128i __A, int __B)
 {
-  return ((__m128i)__builtin_ia32_pslldqi128 (__A, __B))
+  return ((__m128i)__builtin_ia32_pslldqi128 (__A, __B * 8));
 }
 #else
 #define _mm_srli_si128(__A, __B) \
@@ -1147,6 +1165,7 @@
   ((__m128i)__builtin_ia32_pslldqi128 (__A, (__B) * 8))
 #endif
 
+#if 0
 static __inline __m128i __attribute__((__always_inline__))
 _mm_srli_epi16 (__m128i __A, int __B)
 {
@@ -1164,53 +1183,61 @@
 {
   return (__m128i)__builtin_ia32_psrlqi128 ((__v2di)__A, __B);
 }
+#else
+#define _mm_srli_epi16(__A, __B) \
+  ((__m128i)__builtin_ia32_psrlwi128 ((__v8hi)(__A), __B))
+#define _mm_srli_epi32(__A, __B) \
+  ((__m128i)__builtin_ia32_psrldi128 ((__v4si)(__A), __B))
+#define _mm_srli_epi64(__A, __B) \
+  ((__m128i)__builtin_ia32_psrlqi128 ((__v4si)(__A), __B))
+#endif
 
 static __inline __m128i __attribute__((__always_inline__))
 _mm_sll_epi16 (__m128i __A, __m128i __B)
 {
-  return _mm_slli_epi16 (__A, _mm_cvtsi128_si32 (__B));
+  return (__m128i)__builtin_ia32_psllw128((__v8hi)__A, (__v8hi)__B);
 }
 
 static __inline __m128i __attribute__((__always_inline__))
 _mm_sll_epi32 (__m128i __A, __m128i __B)
 {
-  return _mm_slli_epi32 (__A, _mm_cvtsi128_si32 (__B));
+  return (__m128i)__builtin_ia32_pslld128((__v4si)__A, (__v4si)__B);
 }
 
 static __inline __m128i __attribute__((__always_inline__))
 _mm_sll_epi64 (__m128i __A, __m128i __B)
 {
-  return _mm_slli_epi64 (__A, _mm_cvtsi128_si32 (__B));
+  return (__m128i)__builtin_ia32_psllq128((__v2di)__A, (__v2di)__B);
 }
 
 static __inline __m128i __attribute__((__always_inline__))
 _mm_sra_epi16 (__m128i __A, __m128i __B)
 {
-  return _mm_srai_epi16 (__A, _mm_cvtsi128_si32 (__B));
+  return (__m128i)__builtin_ia32_psraw128 ((__v8hi)__A, (__v8hi)__B);
 }
 
 static __inline __m128i __attribute__((__always_inline__))
 _mm_sra_epi32 (__m128i __A, __m128i __B)
 {
-  return _mm_srai_epi32 (__A, _mm_cvtsi128_si32 (__B));
+  return (__m128i)__builtin_ia32_psrad128 ((__v4si)__A, (__v4si)__B);
 }
 
 static __inline __m128i __attribute__((__always_inline__))
 _mm_srl_epi16 (__m128i __A, __m128i __B)
 {
-  return _mm_srli_epi16 (__A, _mm_cvtsi128_si32 (__B));
+  return (__m128i)__builtin_ia32_psrlw128 ((__v8hi)__A, (__v8hi)__B);
 }
 
 static __inline __m128i __attribute__((__always_inline__))
 _mm_srl_epi32 (__m128i __A, __m128i __B)
 {
-  return _mm_srli_epi32 (__A, _mm_cvtsi128_si32 (__B));
+  return (__m128i)__builtin_ia32_psrld128 ((__v4si)__A, (__v4si)__B);
 }
 
 static __inline __m128i __attribute__((__always_inline__))
 _mm_srl_epi64 (__m128i __A, __m128i __B)
 {
-  return _mm_srli_epi64 (__A, _mm_cvtsi128_si32 (__B));
+  return (__m128i)__builtin_ia32_psrlq128 ((__v2di)__A, (__v2di)__B);
 }
 
 static __inline __m128i __attribute__((__always_inline__))
Index: gcc-4_2-branch/gcc/config/i386/sync.md
===================================================================
--- gcc-4_2-branch/gcc/config/i386/sync.md	(revision 123014)
+++ gcc-4_2-branch/gcc/config/i386/sync.md	(revision 124164)
@@ -98,6 +98,15 @@
   ""
   "lock\;cmpxchg<doublemodesuffix>b\t%1")
 
+;; Theoretically we'd like to use constraint "r" (any reg) for operand
+;; 3, but that includes ecx.  If operand 3 and 4 are the same (like when
+;; the input is -1LL) GCC might chose to allocate operand 3 to ecx, like
+;; operand 4.  This breaks, as the xchg will move the PIC register contents
+;; to %ecx then --> boom.  Operands 3 and 4 really need to be different
+;; registers, which in this case means operand 3 must not be ecx.
+;; Instead of playing tricks with fake early clobbers or the like we
+;; just enumerate all regs possible here, which (as this is !TARGET_64BIT)
+;; are just esi and edi.
 (define_insn "*sync_double_compare_and_swapdi_pic"
   [(set (match_operand:DI 0 "register_operand" "=A")
 	(match_operand:DI 1 "memory_operand" "+m"))
@@ -105,7 +114,7 @@
 	(unspec_volatile:DI
 	  [(match_dup 1)
 	   (match_operand:DI 2 "register_operand" "A")
-	   (match_operand:SI 3 "register_operand" "r")
+	   (match_operand:SI 3 "register_operand" "SD")
 	   (match_operand:SI 4 "register_operand" "c")]
 	  UNSPECV_CMPXCHG_1))
    (clobber (reg:CC FLAGS_REG))]
@@ -189,6 +198,8 @@
   ""
   "lock\;cmpxchg<doublemodesuffix>b\t%1")
 
+;; See above for the explanation of using the constraint "SD" for
+;; operand 3.
 (define_insn "*sync_double_compare_and_swap_ccdi_pic"
   [(set (match_operand:DI 0 "register_operand" "=A")
 	(match_operand:DI 1 "memory_operand" "+m"))
@@ -196,7 +207,7 @@
 	(unspec_volatile:DI
 	  [(match_dup 1)
 	   (match_operand:DI 2 "register_operand" "A")
-	   (match_operand:SI 3 "register_operand" "r")
+	   (match_operand:SI 3 "register_operand" "SD")
 	   (match_operand:SI 4 "register_operand" "c")]
 	  UNSPECV_CMPXCHG_1))
    (set (reg:CCZ FLAGS_REG)
Index: gcc-4_2-branch/gcc/config/i386/i386.c
===================================================================
--- gcc-4_2-branch/gcc/config/i386/i386.c	(revision 123014)
+++ gcc-4_2-branch/gcc/config/i386/i386.c	(revision 124164)
@@ -14666,7 +14666,7 @@
     BUILTIN_DESC_SWAP_OPERANDS },
   { MASK_SSE, CODE_FOR_sse_vmmaskcmpv4sf3, "__builtin_ia32_cmpngess", IX86_BUILTIN_CMPNGESS, UNGT,
     BUILTIN_DESC_SWAP_OPERANDS },
-  { MASK_SSE, CODE_FOR_sse_vmmaskcmpv4sf3, "__builtin_ia32_cmpordss", IX86_BUILTIN_CMPORDSS, UNORDERED, 0 },
+  { MASK_SSE, CODE_FOR_sse_vmmaskcmpv4sf3, "__builtin_ia32_cmpordss", IX86_BUILTIN_CMPORDSS, ORDERED, 0 },
 
   { MASK_SSE, CODE_FOR_sminv4sf3, "__builtin_ia32_minps", IX86_BUILTIN_MINPS, 0, 0 },
   { MASK_SSE, CODE_FOR_smaxv4sf3, "__builtin_ia32_maxps", IX86_BUILTIN_MAXPS, 0, 0 },
@@ -15206,12 +15206,6 @@
   tree v8hi_ftype_v8hi_int
     = build_function_type_list (V8HI_type_node,
 				V8HI_type_node, integer_type_node, NULL_TREE);
-  tree v8hi_ftype_v8hi_v2di
-    = build_function_type_list (V8HI_type_node,
-				V8HI_type_node, V2DI_type_node, NULL_TREE);
-  tree v4si_ftype_v4si_v2di
-    = build_function_type_list (V4SI_type_node,
-				V4SI_type_node, V2DI_type_node, NULL_TREE);
   tree v4si_ftype_v8hi_v8hi
     = build_function_type_list (V4SI_type_node,
 				V8HI_type_node, V8HI_type_node, NULL_TREE);
@@ -15479,16 +15473,16 @@
   def_builtin (MASK_SSE2, "__builtin_ia32_pmuludq", di_ftype_v2si_v2si, IX86_BUILTIN_PMULUDQ);
   def_builtin (MASK_SSE2, "__builtin_ia32_pmuludq128", v2di_ftype_v4si_v4si, IX86_BUILTIN_PMULUDQ128);
 
-  def_builtin (MASK_SSE2, "__builtin_ia32_psllw128", v8hi_ftype_v8hi_v2di, IX86_BUILTIN_PSLLW128);
-  def_builtin (MASK_SSE2, "__builtin_ia32_pslld128", v4si_ftype_v4si_v2di, IX86_BUILTIN_PSLLD128);
+  def_builtin (MASK_SSE2, "__builtin_ia32_psllw128", v8hi_ftype_v8hi_v8hi, IX86_BUILTIN_PSLLW128);
+  def_builtin (MASK_SSE2, "__builtin_ia32_pslld128", v4si_ftype_v4si_v4si, IX86_BUILTIN_PSLLD128);
   def_builtin (MASK_SSE2, "__builtin_ia32_psllq128", v2di_ftype_v2di_v2di, IX86_BUILTIN_PSLLQ128);
 
-  def_builtin (MASK_SSE2, "__builtin_ia32_psrlw128", v8hi_ftype_v8hi_v2di, IX86_BUILTIN_PSRLW128);
-  def_builtin (MASK_SSE2, "__builtin_ia32_psrld128", v4si_ftype_v4si_v2di, IX86_BUILTIN_PSRLD128);
+  def_builtin (MASK_SSE2, "__builtin_ia32_psrlw128", v8hi_ftype_v8hi_v8hi, IX86_BUILTIN_PSRLW128);
+  def_builtin (MASK_SSE2, "__builtin_ia32_psrld128", v4si_ftype_v4si_v4si, IX86_BUILTIN_PSRLD128);
   def_builtin (MASK_SSE2, "__builtin_ia32_psrlq128", v2di_ftype_v2di_v2di, IX86_BUILTIN_PSRLQ128);
 
-  def_builtin (MASK_SSE2, "__builtin_ia32_psraw128", v8hi_ftype_v8hi_v2di, IX86_BUILTIN_PSRAW128);
-  def_builtin (MASK_SSE2, "__builtin_ia32_psrad128", v4si_ftype_v4si_v2di, IX86_BUILTIN_PSRAD128);
+  def_builtin (MASK_SSE2, "__builtin_ia32_psraw128", v8hi_ftype_v8hi_v8hi, IX86_BUILTIN_PSRAW128);
+  def_builtin (MASK_SSE2, "__builtin_ia32_psrad128", v4si_ftype_v4si_v4si, IX86_BUILTIN_PSRAD128);
 
   def_builtin (MASK_SSE2, "__builtin_ia32_pslldqi128", v2di_ftype_v2di_int, IX86_BUILTIN_PSLLDQI128);
   def_builtin (MASK_SSE2, "__builtin_ia32_psllwi128", v8hi_ftype_v8hi_int, IX86_BUILTIN_PSLLWI128);
@@ -15968,7 +15962,7 @@
   enum machine_mode tmode, mode1;
   tree arg0, arg1, arg2;
   int elt;
-  rtx op0, op1;
+  rtx op0, op1, target;
 
   arg0 = TREE_VALUE (arglist);
   arg1 = TREE_VALUE (TREE_CHAIN (arglist));
@@ -15988,9 +15982,13 @@
   op0 = force_reg (tmode, op0);
   op1 = force_reg (mode1, op1);
 
-  ix86_expand_vector_set (true, op0, op1, elt);
+  /* OP0 is the source of these builtin functions and shouldn't be
+     modified.  Create a copy, use it and return it as target.  */
+  target = gen_reg_rtx (tmode);
+  emit_move_insn (target, op0);
+  ix86_expand_vector_set (true, target, op1, elt);
 
-  return op0;
+  return target;
 }
 
 /* Expand an expression EXP that calls a built-in function,
@@ -16204,9 +16202,106 @@
       emit_insn (pat);
       return target;
 
+    case IX86_BUILTIN_PSLLWI128:
+      icode = CODE_FOR_ashlv8hi3;
+      goto do_pshifti;
+    case IX86_BUILTIN_PSLLDI128:
+      icode = CODE_FOR_ashlv4si3;
+      goto do_pshifti;
+    case IX86_BUILTIN_PSLLQI128:
+      icode = CODE_FOR_ashlv2di3;
+      goto do_pshifti;
+    case IX86_BUILTIN_PSRAWI128:
+      icode = CODE_FOR_ashrv8hi3;
+      goto do_pshifti;
+    case IX86_BUILTIN_PSRADI128:
+      icode = CODE_FOR_ashrv4si3;
+      goto do_pshifti;
+    case IX86_BUILTIN_PSRLWI128:
+      icode = CODE_FOR_lshrv8hi3;
+      goto do_pshifti;
+    case IX86_BUILTIN_PSRLDI128:
+      icode = CODE_FOR_lshrv4si3;
+      goto do_pshifti;
+    case IX86_BUILTIN_PSRLQI128:
+      icode = CODE_FOR_lshrv2di3;
+      goto do_pshifti;
+    do_pshifti:
+      arg0 = TREE_VALUE (arglist);
+      arg1 = TREE_VALUE (TREE_CHAIN (arglist));
+      op0 = expand_expr (arg0, NULL_RTX, VOIDmode, 0);
+      op1 = expand_expr (arg1, NULL_RTX, VOIDmode, 0);
+
+      if (GET_CODE (op1) != CONST_INT)
+	{
+	  error ("shift must be an immediate");
+	  return const0_rtx;
+	}
+      if (INTVAL (op1) < 0 || INTVAL (op1) > 255)
+	op1 = GEN_INT (255);
+
+      tmode = insn_data[icode].operand[0].mode;
+      mode1 = insn_data[icode].operand[1].mode;
+      if (! (*insn_data[icode].operand[1].predicate) (op0, mode1))
+	op0 = copy_to_reg (op0);
+
+      target = gen_reg_rtx (tmode);
+      pat = GEN_FCN (icode) (target, op0, op1);
+      if (!pat)
+	return 0;
+      emit_insn (pat);
+      return target;
+
+    case IX86_BUILTIN_PSLLW128:
+      icode = CODE_FOR_ashlv8hi3;
+      goto do_pshift;
+    case IX86_BUILTIN_PSLLD128:
+      icode = CODE_FOR_ashlv4si3;
+      goto do_pshift;
+    case IX86_BUILTIN_PSLLQ128:
+      icode = CODE_FOR_ashlv2di3;
+      goto do_pshift;
+    case IX86_BUILTIN_PSRAW128:
+      icode = CODE_FOR_ashrv8hi3;
+      goto do_pshift;
+    case IX86_BUILTIN_PSRAD128:
+      icode = CODE_FOR_ashrv4si3;
+      goto do_pshift;
+    case IX86_BUILTIN_PSRLW128:
+      icode = CODE_FOR_lshrv8hi3;
+      goto do_pshift;
+    case IX86_BUILTIN_PSRLD128:
+      icode = CODE_FOR_lshrv4si3;
+      goto do_pshift;
+    case IX86_BUILTIN_PSRLQ128:
+      icode = CODE_FOR_lshrv2di3;
+      goto do_pshift;
+    do_pshift:
+      arg0 = TREE_VALUE (arglist);
+      arg1 = TREE_VALUE (TREE_CHAIN (arglist));
+      op0 = expand_expr (arg0, NULL_RTX, VOIDmode, 0);
+      op1 = expand_expr (arg1, NULL_RTX, VOIDmode, 0);
+
+      tmode = insn_data[icode].operand[0].mode;
+      mode1 = insn_data[icode].operand[1].mode;
+
+      if (! (*insn_data[icode].operand[1].predicate) (op0, mode1))
+	op0 = copy_to_reg (op0);
+
+      op1 = simplify_gen_subreg (TImode, op1, GET_MODE (op1), 0);
+      if (! (*insn_data[icode].operand[2].predicate) (op1, TImode))
+	op1 = copy_to_reg (op1);
+
+      target = gen_reg_rtx (tmode);
+      pat = GEN_FCN (icode) (target, op0, op1);
+      if (!pat)
+	return 0;
+      emit_insn (pat);
+      return target;
+
     case IX86_BUILTIN_PSLLDQI128:
     case IX86_BUILTIN_PSRLDQI128:
-      icode = (  fcode == IX86_BUILTIN_PSLLDQI128 ? CODE_FOR_sse2_ashlti3
+      icode = (fcode == IX86_BUILTIN_PSLLDQI128 ? CODE_FOR_sse2_ashlti3
 	       : CODE_FOR_sse2_lshrti3);
       arg0 = TREE_VALUE (arglist);
       arg1 = TREE_VALUE (TREE_CHAIN (arglist));
@@ -16227,7 +16322,8 @@
 	  return const0_rtx;
 	}
       target = gen_reg_rtx (V2DImode);
-      pat = GEN_FCN (icode) (simplify_gen_subreg (tmode, target, V2DImode, 0), op0, op1);
+      pat = GEN_FCN (icode) (simplify_gen_subreg (tmode, target, V2DImode, 0),
+			     op0, op1);
       if (! pat)
 	return 0;
       emit_insn (pat);
Index: gcc-4_2-branch/gcc/config/avr/predicates.md
===================================================================
--- gcc-4_2-branch/gcc/config/avr/predicates.md	(revision 123014)
+++ gcc-4_2-branch/gcc/config/avr/predicates.md	(revision 124164)
@@ -1,5 +1,5 @@
 ;; Predicate definitions for ATMEL AVR micro controllers.
-;; Copyright (C) 2006 Free Software Foundation, Inc.
+;; Copyright (C) 2006, 2007 Free Software Foundation, Inc.
 ;;
 ;; This file is part of GCC.
 ;;
@@ -33,23 +33,15 @@
   (and (match_code "reg")
        (match_test "REGNO (op) == REG_SP")))
 
-;; Return true if OP is a valid address for an I/O register.
-(define_predicate "io_address_operand"
-  (and (match_code "const_int")
-       (match_test "INTVAL (op) >= 0x20 
-                    && INTVAL (op) <= 0x60 - GET_MODE_SIZE (mode)")))
-
 ;; Return true if OP is a valid address for lower half of I/O space.
 (define_predicate "low_io_address_operand"
   (and (match_code "const_int")
-       (match_test "INTVAL (op) >= 0x20 
-                    && INTVAL (op) <= 0x40 - GET_MODE_SIZE (mode)")))
-       
-;; Return true if OP is a valid address for higth half of I/O space.
-(define_predicate "higth_io_address_operand"
+       (match_test "IN_RANGE((INTVAL (op)), 0x20, 0x3F)")))
+
+;; Return true if OP is a valid address for high half of I/O space.
+(define_predicate "high_io_address_operand"
   (and (match_code "const_int")
-       (match_test "INTVAL (op) >= 0x40 
-                    && INTVAL (op) <= 0x60 - GET_MODE_SIZE (mode)")))
+       (match_test "IN_RANGE((INTVAL (op)), 0x40, 0x5F)")))
        
 ;; Returns 1 if OP is a SYMBOL_REF.
 (define_predicate "symbol_ref_operand"
Index: gcc-4_2-branch/gcc/config/avr/avr.md
===================================================================
--- gcc-4_2-branch/gcc/config/avr/avr.md	(revision 123014)
+++ gcc-4_2-branch/gcc/config/avr/avr.md	(revision 124164)
@@ -1,7 +1,7 @@
 ;; -*- Mode: Scheme -*-
 ;;   Machine description for GNU compiler,
 ;;   for ATMEL AVR micro controllers.
-;;   Copyright (C) 1998, 1999, 2000, 2001, 2002, 2004, 2005, 2006
+;;   Copyright (C) 1998, 1999, 2000, 2001, 2002, 2004, 2005, 2006, 2007
 ;;   Free Software Foundation, Inc.
 ;;   Contributed by Denis Chertykov (denisc@overta.ru)
 
@@ -463,7 +463,7 @@
    (use (match_operand:QI 1 "register_operand" "r"))
    (use (match_operand:QI 2 "const_int_operand" "n"))
    (clobber (match_scratch:HI 3 "=0"))
-   (clobber (match_scratch:QI 4 "=1"))]
+   (clobber (match_scratch:QI 4 "=&1"))]
   ""
   "st %a0+,__zero_reg__
         dec %1
@@ -477,7 +477,7 @@
    (use (match_operand:HI 1 "register_operand" "!w,d"))
    (use (match_operand:HI 2 "const_int_operand" "n,n"))
    (clobber (match_scratch:HI 3 "=0,0"))
-   (clobber (match_scratch:HI 4 "=1,1"))]
+   (clobber (match_scratch:HI 4 "=&1,&1"))]
   ""
   "*{
      if (which_alternative==0)
@@ -2364,7 +2364,7 @@
 	(if_then_else
 	 (match_operator 0 "eqne_operator"
 			 [(zero_extract
-			   (mem:QI (match_operand 1 "higth_io_address_operand" "n"))
+			   (mem:QI (match_operand 1 "high_io_address_operand" "n"))
 			   (const_int 1)
 			   (match_operand 2 "const_int_operand" "n"))
 			  (const_int 0)])
@@ -2385,7 +2385,7 @@
   [(set (pc)
 	(if_then_else
 	 (match_operator 0 "gelt_operator"
-			 [(mem:QI (match_operand 1 "higth_io_address_operand" "n"))
+			 [(mem:QI (match_operand 1 "high_io_address_operand" "n"))
 			  (const_int 0)])
 	 (label_ref (match_operand 2 "" ""))
 	 (pc)))]
Index: gcc-4_2-branch/gcc/config/avr/avr.c
===================================================================
--- gcc-4_2-branch/gcc/config/avr/avr.c	(revision 123014)
+++ gcc-4_2-branch/gcc/config/avr/avr.c	(revision 124164)
@@ -1,5 +1,5 @@
 /* Subroutines for insn-output.c for ATMEL AVR micro controllers
-   Copyright (C) 1998, 1999, 2000, 2001, 2002, 2004, 2005, 2006
+   Copyright (C) 1998, 1999, 2000, 2001, 2002, 2004, 2005, 2006, 2007
    Free Software Foundation, Inc.
    Contributed by Denis Chertykov (denisc@overta.ru)
 
@@ -141,12 +141,26 @@
   { 1, 0, 0, 0,  NULL },  /* unknown device specified */
   { 1, 0, 0, 0, "__AVR_ARCH__=1" },
   { 0, 0, 0, 0, "__AVR_ARCH__=2" },
+  { 0, 0, 0, 1, "__AVR_ARCH__=25"},
   { 0, 0, 1, 0, "__AVR_ARCH__=3" },
   { 0, 1, 0, 1, "__AVR_ARCH__=4" },
-  { 0, 1, 1, 1, "__AVR_ARCH__=5" },
-  { 0, 0, 0, 1, "__AVR_ARCH__=25"}
+  { 0, 1, 1, 1, "__AVR_ARCH__=5" }
 };
 
+/* These names are used as the index into the avr_arch_types[] table 
+   above.  */
+
+enum avr_arch
+{
+  ARCH_UNKNOWN,
+  ARCH_AVR1,
+  ARCH_AVR2,
+  ARCH_AVR25,
+  ARCH_AVR3,
+  ARCH_AVR4,
+  ARCH_AVR5
+};
+
 struct mcu_type_s {
   const char *const name;
   int arch;  /* index in avr_arch_types[] */
@@ -164,103 +178,103 @@
 
 static const struct mcu_type_s avr_mcu_types[] = {
     /* Classic, <= 8K.  */
-  { "avr2",      2, NULL },
-  { "at90s2313", 2, "__AVR_AT90S2313__" },
-  { "at90s2323", 2, "__AVR_AT90S2323__" },
-  { "at90s2333", 2, "__AVR_AT90S2333__" },
-  { "at90s2343", 2, "__AVR_AT90S2343__" },
-  { "attiny22",  2, "__AVR_ATtiny22__" },
-  { "attiny26",  2, "__AVR_ATtiny26__" },
-  { "at90s4414", 2, "__AVR_AT90S4414__" },
-  { "at90s4433", 2, "__AVR_AT90S4433__" },
-  { "at90s4434", 2, "__AVR_AT90S4434__" },
-  { "at90s8515", 2, "__AVR_AT90S8515__" },
-  { "at90c8534", 2, "__AVR_AT90C8534__" },
-  { "at90s8535", 2, "__AVR_AT90S8535__" },
+  { "avr2",         ARCH_AVR2, NULL },
+  { "at90s2313",    ARCH_AVR2, "__AVR_AT90S2313__" },
+  { "at90s2323",    ARCH_AVR2, "__AVR_AT90S2323__" },
+  { "at90s2333",    ARCH_AVR2, "__AVR_AT90S2333__" },
+  { "at90s2343",    ARCH_AVR2, "__AVR_AT90S2343__" },
+  { "attiny22",     ARCH_AVR2, "__AVR_ATtiny22__" },
+  { "attiny26",     ARCH_AVR2, "__AVR_ATtiny26__" },
+  { "at90s4414",    ARCH_AVR2, "__AVR_AT90S4414__" },
+  { "at90s4433",    ARCH_AVR2, "__AVR_AT90S4433__" },
+  { "at90s4434",    ARCH_AVR2, "__AVR_AT90S4434__" },
+  { "at90s8515",    ARCH_AVR2, "__AVR_AT90S8515__" },
+  { "at90c8534",    ARCH_AVR2, "__AVR_AT90C8534__" },
+  { "at90s8535",    ARCH_AVR2, "__AVR_AT90S8535__" },
     /* Classic + MOVW, <= 8K.  */
-  { "avr25",      6, NULL },
-  { "attiny13",   6, "__AVR_ATtiny13__" },
-  { "attiny2313", 6, "__AVR_ATtiny2313__" },
-  { "attiny24",   6, "__AVR_ATtiny24__" },
-  { "attiny44",   6, "__AVR_ATtiny44__" },
-  { "attiny84",   6, "__AVR_ATtiny84__" },
-  { "attiny25",   6, "__AVR_ATtiny25__" },
-  { "attiny45",   6, "__AVR_ATtiny45__" },
-  { "attiny85",   6, "__AVR_ATtiny85__" },
-  { "attiny261",  6, "__AVR_ATtiny261__" },
-  { "attiny461",  6, "__AVR_ATtiny461__" },
-  { "attiny861",  6, "__AVR_ATtiny861__" },
-  { "at86rf401",  6, "__AVR_AT86RF401__" },
+  { "avr25",        ARCH_AVR25, NULL },
+  { "attiny13",     ARCH_AVR25, "__AVR_ATtiny13__" },
+  { "attiny2313",   ARCH_AVR25, "__AVR_ATtiny2313__" },
+  { "attiny24",     ARCH_AVR25, "__AVR_ATtiny24__" },
+  { "attiny44",     ARCH_AVR25, "__AVR_ATtiny44__" },
+  { "attiny84",     ARCH_AVR25, "__AVR_ATtiny84__" },
+  { "attiny25",     ARCH_AVR25, "__AVR_ATtiny25__" },
+  { "attiny45",     ARCH_AVR25, "__AVR_ATtiny45__" },
+  { "attiny85",     ARCH_AVR25, "__AVR_ATtiny85__" },
+  { "attiny261",    ARCH_AVR25, "__AVR_ATtiny261__" },
+  { "attiny461",    ARCH_AVR25, "__AVR_ATtiny461__" },
+  { "attiny861",    ARCH_AVR25, "__AVR_ATtiny861__" },
+  { "at86rf401",    ARCH_AVR25, "__AVR_AT86RF401__" },
     /* Classic, > 8K.  */
-  { "avr3",      3, NULL },
-  { "atmega103", 3, "__AVR_ATmega103__" },
-  { "atmega603", 3, "__AVR_ATmega603__" },
-  { "at43usb320", 3, "__AVR_AT43USB320__" },
-  { "at43usb355", 3, "__AVR_AT43USB355__" },
-  { "at76c711",  3, "__AVR_AT76C711__" },
+  { "avr3",         ARCH_AVR3, NULL },
+  { "atmega103",    ARCH_AVR3, "__AVR_ATmega103__" },
+  { "atmega603",    ARCH_AVR3, "__AVR_ATmega603__" },
+  { "at43usb320",   ARCH_AVR3, "__AVR_AT43USB320__" },
+  { "at43usb355",   ARCH_AVR3, "__AVR_AT43USB355__" },
+  { "at76c711",     ARCH_AVR3, "__AVR_AT76C711__" },
     /* Enhanced, <= 8K.  */
-  { "avr4",      4, NULL },
-  { "atmega8",   4, "__AVR_ATmega8__" },
-  { "atmega48",   4, "__AVR_ATmega48__" },
-  { "atmega88",   4, "__AVR_ATmega88__" },
-  { "atmega8515", 4, "__AVR_ATmega8515__" },
-  { "atmega8535", 4, "__AVR_ATmega8535__" },
-  { "at90pwm1",  4, "__AVR_AT90PWM1__" },
-  { "at90pwm2",  4, "__AVR_AT90PWM2__" },
-  { "at90pwm3",  4, "__AVR_AT90PWM3__" },
-  { "at90usb82",   5, "__AVR_AT90USB82__" },
+  { "avr4",         ARCH_AVR4, NULL },
+  { "atmega8",      ARCH_AVR4, "__AVR_ATmega8__" },
+  { "atmega48",     ARCH_AVR4, "__AVR_ATmega48__" },
+  { "atmega88",     ARCH_AVR4, "__AVR_ATmega88__" },
+  { "atmega8515",   ARCH_AVR4, "__AVR_ATmega8515__" },
+  { "atmega8535",   ARCH_AVR4, "__AVR_ATmega8535__" },
+  { "at90pwm1",     ARCH_AVR4, "__AVR_AT90PWM1__" },
+  { "at90pwm2",     ARCH_AVR4, "__AVR_AT90PWM2__" },
+  { "at90pwm3",     ARCH_AVR4, "__AVR_AT90PWM3__" },
+  { "at90usb82",    ARCH_AVR4, "__AVR_AT90USB82__" },
     /* Enhanced, > 8K.  */
-  { "avr5",      5, NULL },
-  { "atmega16",  5, "__AVR_ATmega16__" },
-  { "atmega161", 5, "__AVR_ATmega161__" },
-  { "atmega162", 5, "__AVR_ATmega162__" },
-  { "atmega163", 5, "__AVR_ATmega163__" },
-  { "atmega164p",5, "__AVR_ATmega164P__" },
-  { "atmega165", 5, "__AVR_ATmega165__" },
-  { "atmega165p",5, "__AVR_ATmega165P__" },
-  { "atmega168", 5, "__AVR_ATmega168__" },
-  { "atmega169", 5, "__AVR_ATmega169__" },
-  { "atmega169p",5, "__AVR_ATmega169P__" },
-  { "atmega32",  5, "__AVR_ATmega32__" },
-  { "atmega323", 5, "__AVR_ATmega323__" },
-  { "atmega324p",5, "__AVR_ATmega324P__" },
-  { "atmega325", 5, "__AVR_ATmega325__" },
-  { "atmega325p",  5, "__AVR_ATmega325P__" },
-  { "atmega3250", 5, "__AVR_ATmega3250__" },
-  { "atmega3250p", 5, "__AVR_ATmega3250P__" },
-  { "atmega329", 5, "__AVR_ATmega329__" },
-  { "atmega329p",  5, "__AVR_ATmega329P__" },
-  { "atmega3290", 5, "__AVR_ATmega3290__" },
-  { "atmega3290p", 5, "__AVR_ATmega3290P__" },
-  { "atmega406", 5, "__AVR_ATmega406__" },
-  { "atmega64",  5, "__AVR_ATmega64__" },
-  { "atmega640", 5, "__AVR_ATmega640__" },
-  { "atmega644", 5, "__AVR_ATmega644__" },
-  { "atmega644p",5, "__AVR_ATmega644P__" },
-  { "atmega645", 5, "__AVR_ATmega645__" },
-  { "atmega6450", 5, "__AVR_ATmega6450__" },
-  { "atmega649", 5, "__AVR_ATmega649__" },
-  { "atmega6490", 5, "__AVR_ATmega6490__" },
-  { "atmega128", 5, "__AVR_ATmega128__" },
-  { "atmega1280",5, "__AVR_ATmega1280__" },
-  { "atmega1281",5, "__AVR_ATmega1281__" },
-  { "at90can32", 5, "__AVR_AT90CAN32__" },
-  { "at90can64", 5, "__AVR_AT90CAN64__" },
-  { "at90can128", 5, "__AVR_AT90CAN128__" },
-  { "at90usb162",  5, "__AVR_AT90USB162__" },
-  { "at90usb646", 5, "__AVR_AT90USB646__" },
-  { "at90usb647", 5, "__AVR_AT90USB647__" },
-  { "at90usb1286", 5, "__AVR_AT90USB1286__" },
-  { "at90usb1287", 5, "__AVR_AT90USB1287__" },
-  { "at94k",     5, "__AVR_AT94K__" },
+  { "avr5",         ARCH_AVR5, NULL },
+  { "atmega16",     ARCH_AVR5, "__AVR_ATmega16__" },
+  { "atmega161",    ARCH_AVR5, "__AVR_ATmega161__" },
+  { "atmega162",    ARCH_AVR5, "__AVR_ATmega162__" },
+  { "atmega163",    ARCH_AVR5, "__AVR_ATmega163__" },
+  { "atmega164p",   ARCH_AVR5, "__AVR_ATmega164P__" },
+  { "atmega165",    ARCH_AVR5, "__AVR_ATmega165__" },
+  { "atmega165p",   ARCH_AVR5, "__AVR_ATmega165P__" },
+  { "atmega168",    ARCH_AVR5, "__AVR_ATmega168__" },
+  { "atmega169",    ARCH_AVR5, "__AVR_ATmega169__" },
+  { "atmega169p",   ARCH_AVR5, "__AVR_ATmega169P__" },
+  { "atmega32",     ARCH_AVR5, "__AVR_ATmega32__" },
+  { "atmega323",    ARCH_AVR5, "__AVR_ATmega323__" },
+  { "atmega324p",   ARCH_AVR5, "__AVR_ATmega324P__" },
+  { "atmega325",    ARCH_AVR5, "__AVR_ATmega325__" },
+  { "atmega325p",   ARCH_AVR5, "__AVR_ATmega325P__" },
+  { "atmega3250",   ARCH_AVR5, "__AVR_ATmega3250__" },
+  { "atmega3250p",  ARCH_AVR5, "__AVR_ATmega3250P__" },
+  { "atmega329",    ARCH_AVR5, "__AVR_ATmega329__" },
+  { "atmega329p",   ARCH_AVR5, "__AVR_ATmega329P__" },
+  { "atmega3290",   ARCH_AVR5, "__AVR_ATmega3290__" },
+  { "atmega3290p",  ARCH_AVR5, "__AVR_ATmega3290P__" },
+  { "atmega406",    ARCH_AVR5, "__AVR_ATmega406__" },
+  { "atmega64",     ARCH_AVR5, "__AVR_ATmega64__" },
+  { "atmega640",    ARCH_AVR5, "__AVR_ATmega640__" },
+  { "atmega644",    ARCH_AVR5, "__AVR_ATmega644__" },
+  { "atmega644p",   ARCH_AVR5, "__AVR_ATmega644P__" },
+  { "atmega645",    ARCH_AVR5, "__AVR_ATmega645__" },
+  { "atmega6450",   ARCH_AVR5, "__AVR_ATmega6450__" },
+  { "atmega649",    ARCH_AVR5, "__AVR_ATmega649__" },
+  { "atmega6490",   ARCH_AVR5, "__AVR_ATmega6490__" },
+  { "atmega128",    ARCH_AVR5, "__AVR_ATmega128__" },
+  { "atmega1280",   ARCH_AVR5, "__AVR_ATmega1280__" },
+  { "atmega1281",   ARCH_AVR5, "__AVR_ATmega1281__" },
+  { "at90can32",    ARCH_AVR5, "__AVR_AT90CAN32__" },
+  { "at90can64",    ARCH_AVR5, "__AVR_AT90CAN64__" },
+  { "at90can128",   ARCH_AVR5, "__AVR_AT90CAN128__" },
+  { "at90usb162",   ARCH_AVR5, "__AVR_AT90USB162__" },
+  { "at90usb646",   ARCH_AVR5, "__AVR_AT90USB646__" },
+  { "at90usb647",   ARCH_AVR5, "__AVR_AT90USB647__" },
+  { "at90usb1286",  ARCH_AVR5, "__AVR_AT90USB1286__" },
+  { "at90usb1287",  ARCH_AVR5, "__AVR_AT90USB1287__" },
+  { "at94k",        ARCH_AVR5, "__AVR_AT94K__" },
     /* Assembler only.  */
-  { "avr1",      1, NULL },
-  { "at90s1200", 1, "__AVR_AT90S1200__" },
-  { "attiny11",  1, "__AVR_ATtiny11__" },
-  { "attiny12",  1, "__AVR_ATtiny12__" },
-  { "attiny15",  1, "__AVR_ATtiny15__" },
-  { "attiny28",  1, "__AVR_ATtiny28__" },
-  { NULL,        0, NULL }
+  { "avr1",         ARCH_AVR1, NULL },
+  { "at90s1200",    ARCH_AVR1, "__AVR_AT90S1200__" },
+  { "attiny11",     ARCH_AVR1, "__AVR_ATtiny11__" },
+  { "attiny12",     ARCH_AVR1, "__AVR_ATtiny12__" },
+  { "attiny15",     ARCH_AVR1, "__AVR_ATtiny15__" },
+  { "attiny28",     ARCH_AVR1, "__AVR_ATtiny28__" },
+  { NULL,           ARCH_UNKNOWN, NULL }
 };
 
 int avr_case_values_threshold = 30000;
@@ -316,6 +330,8 @@
   const struct mcu_type_s *t;
   const struct base_arch_s *base;
 
+  flag_delete_null_pointer_checks = 0;
+
   for (t = avr_mcu_types; t->name; t++)
     if (strcmp (t->name, avr_mcu_name) == 0)
       break;
@@ -1025,7 +1041,7 @@
     case REG_Y: return "Y";
     case REG_Z: return "Z";
     default:
-      gcc_unreachable ();
+      output_operand_lossage ("address operand requires constraint for X, Y, or Z register");
     }
   return NULL;
 }
@@ -4698,7 +4714,7 @@
     }
   else
     {
-      const char *func_name = IDENTIFIER_POINTER (DECL_NAME (*node));
+      const char *func_name = IDENTIFIER_POINTER (DECL_ASSEMBLER_NAME (*node));
       const char *attr = IDENTIFIER_POINTER (name);
 
       /* If the function has the 'signal' or 'interrupt' attribute, test to
@@ -5092,6 +5108,7 @@
 	    *total = COSTS_N_INSNS (AVR_MEGA ? 2 : 1);
 	  else
 	    return false;
+	  break;
 
 	case HImode:
 	  if (AVR_ENHANCED)
@@ -5100,6 +5117,7 @@
 	    *total = COSTS_N_INSNS (AVR_MEGA ? 2 : 1);
 	  else
 	    return false;
+	  break;
 
 	default:
 	  return false;
Index: gcc-4_2-branch/gcc/config/avr/avr.h
===================================================================
--- gcc-4_2-branch/gcc/config/avr/avr.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/avr/avr.h	(revision 124164)
@@ -661,7 +661,11 @@
 #define ASM_OUTPUT_SKIP(STREAM, N)		\
 fprintf (STREAM, "\t.skip %lu,0\n", (unsigned long)(N))
 
-#define ASM_OUTPUT_ALIGN(STREAM, POWER)
+#define ASM_OUTPUT_ALIGN(STREAM, POWER)			\
+  do {							\
+      if ((POWER) > 1)					\
+          fprintf (STREAM, "\t.p2align\t%d\n", POWER);	\
+  } while (0)
 
 #define CASE_VECTOR_MODE HImode
 
@@ -758,9 +762,7 @@
   mmcu=at76*:-m avr3}\
 %{mmcu=atmega8*|\
   mmcu=atmega48|\
-  mmcu=at90pwm1|\
-  mmcu=at90pwm2|\
-  mmcu=at90pwm3:-m avr4}\
+  mmcu=at90pwm*:-m avr4}\
 %{mmcu=atmega16*|\
   mmcu=atmega32*|\
   mmcu=atmega406|\
@@ -771,18 +773,14 @@
   mmcu=at94k:-m avr5}\
 %{mmcu=atmega324*|\
   mmcu=atmega325*|\
-  mmcu=atmega3250*|\
   mmcu=atmega329*|\
-  mmcu=atmega3290*|\
   mmcu=atmega406|\
   mmcu=atmega48|\
   mmcu=atmega88|\
   mmcu=atmega64|\
   mmcu=atmega644*|\
-  mmcu=atmega645|\
-  mmcu=atmega6450|\
-  mmcu=atmega649|\
-  mmcu=atmega6490|\
+  mmcu=atmega645*|\
+  mmcu=atmega649*|\
   mmcu=atmega128|\
   mmcu=atmega162|\
   mmcu=atmega164*|\
Index: gcc-4_2-branch/gcc/config/rs6000/darwin.h
===================================================================
--- gcc-4_2-branch/gcc/config/rs6000/darwin.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/rs6000/darwin.h	(revision 124164)
@@ -280,8 +280,6 @@
 
 /* This says how to output an assembler line to define a global common
    symbol.  */
-/* ? */
-#undef  ASM_OUTPUT_ALIGNED_COMMON
 #define ASM_OUTPUT_COMMON(FILE, NAME, SIZE, ROUNDED)			\
   do {									\
     unsigned HOST_WIDE_INT _new_size = SIZE;				\
Index: gcc-4_2-branch/gcc/config/darwin.h
===================================================================
--- gcc-4_2-branch/gcc/config/darwin.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/darwin.h	(revision 124164)
@@ -652,11 +652,11 @@
       }									\
   } while (0)
 
-/* The maximum alignment which the object file format can support.
-   For Mach-O, this is 2^15.  */
+/* The maximum alignment which the object file format can support in
+   bits.  For Mach-O, this is 2^15 bytes.  */
 
 #undef	MAX_OFILE_ALIGNMENT
-#define MAX_OFILE_ALIGNMENT 0x8000
+#define MAX_OFILE_ALIGNMENT (0x8000 * 8)
 
 /* Declare the section variables.  */
 #ifndef USED_FOR_TARGET
Index: gcc-4_2-branch/gcc/config/score/crti.asm
===================================================================
--- gcc-4_2-branch/gcc/config/score/crti.asm	(revision 123014)
+++ gcc-4_2-branch/gcc/config/score/crti.asm	(revision 124164)
@@ -43,8 +43,8 @@
         .mask   0x00000000, 0
 _start:
         la      r28, _gp
-        la      r8, _bss_start
-        la      r9, _bss_end__
+        la      r8, __bss_start
+        la      r9, __bss_end__
         sub!    r9, r8
         srli!   r9, 2
         addi    r9, -1
@@ -91,8 +91,8 @@
         .mask   0x00000000,0
 _start:
         la      r28, _gp
-        la      r8, _bss_start
-        la      r9, _bss_end__
+        la      r8, __bss_start
+        la      r9, __bss_end__
         sub!    r9, r8
         srli!   r9, 2
         addi    r9, -1
Index: gcc-4_2-branch/gcc/config/score/misc.md
===================================================================
--- gcc-4_2-branch/gcc/config/score/misc.md	(revision 123014)
+++ gcc-4_2-branch/gcc/config/score/misc.md	(revision 124164)
@@ -111,7 +111,7 @@
         (zero_extract (match_operand:SI 1 "memory_operand" "")
                       (match_operand:SI 2 "immediate_operand" "")
                       (match_operand:SI 3 "immediate_operand" "")))]
-  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN"
+  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN && TARGET_ULS"
 {
   if (mdx_unaligned_load (operands))
     DONE;
@@ -124,7 +124,7 @@
                       (match_operand:SI 1 "immediate_operand" "")
                       (match_operand:SI 2 "immediate_operand" ""))
         (match_operand:SI 3 "register_operand" ""))]
-  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN"
+  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN && TARGET_ULS"
 {
   if (mdx_unaligned_store (operands))
     DONE;
@@ -137,7 +137,7 @@
         (sign_extract (match_operand:SI 1 "memory_operand" "")
                       (match_operand:SI 2 "immediate_operand" "")
                       (match_operand:SI 3 "immediate_operand" "")))]
-  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN"
+  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN && TARGET_ULS"
 {
   if (mdx_unaligned_load (operands))
     DONE;
@@ -150,7 +150,7 @@
                    (match_operand:BLK 1 "general_operand"))
               (use (match_operand:SI 2 ""))
               (use (match_operand:SI 3 "const_int_operand"))])]
-  "!TARGET_SCORE5U"
+  "!TARGET_SCORE5U && TARGET_ULS"
 {
   if (mdx_block_move (operands))
     DONE;
@@ -164,7 +164,7 @@
                  (match_operand:SI 2 "const_simm12" "")))
    (set (match_operand:QI 3 "register_operand" "=d")
         (mem:QI (match_dup 1)))]
-  "!TARGET_SCORE5U"
+  ""
   "lbu     %3, [%1]+, %2"
   [(set_attr "type" "load")
    (set_attr "mode" "QI")])
@@ -175,7 +175,7 @@
                  (match_operand:SI 2 "const_simm12" "")))
    (set (match_operand:HI 3 "register_operand" "=d")
         (mem:HI (match_dup 1)))]
-  "!TARGET_SCORE5U"
+  ""
   "lhu     %3, [%1]+, %2"
   [(set_attr "type" "load")
    (set_attr "mode" "HI")])
@@ -186,7 +186,7 @@
                  (match_operand:SI 2 "const_simm12" "")))
    (set (match_operand:SI 3 "register_operand" "=d")
         (mem:SI (match_dup 1)))]
-  "!TARGET_SCORE5U"
+  ""
   "lw      %3, [%1]+, %2"
   [(set_attr "type" "load")
    (set_attr "mode" "SI")])
@@ -197,7 +197,7 @@
                  (match_operand:SI 2 "const_simm12" "")))
    (set (mem:QI (match_dup 1))
         (match_operand:QI 3 "register_operand" "d"))]
-  "!TARGET_SCORE5U"
+  ""
   "sb      %3, [%1]+, %2"
   [(set_attr "type" "store")
    (set_attr "mode" "QI")])
@@ -208,7 +208,7 @@
                  (match_operand:SI 2 "const_simm12" "")))
    (set (mem:HI (match_dup 1))
         (match_operand:HI 3 "register_operand" "d"))]
-  "!TARGET_SCORE5U"
+  ""
   "sh      %3, [%1]+, %2"
   [(set_attr "type" "store")
    (set_attr "mode" "HI")])
@@ -219,7 +219,7 @@
                  (match_operand:SI 2 "const_simm12" "")))
    (set (mem:SI (match_dup 1))
         (match_operand:SI 3 "register_operand" "d"))]
-  "!TARGET_SCORE5U"
+  ""
   "sw      %3, [%1]+, %2"
   [(set_attr "type" "store")
    (set_attr "mode" "SI")])
@@ -231,7 +231,7 @@
    (set (match_operand:QI 3 "register_operand" "=d")
         (mem:QI (plus:SI (match_dup 1)
                          (match_dup 2))))]
-  "!TARGET_SCORE5U"
+  ""
   "lbu     %3, [%1, %2]+"
   [(set_attr "type" "load")
    (set_attr "mode" "QI")])
@@ -243,7 +243,7 @@
    (set (match_operand:HI 3 "register_operand" "=d")
         (mem:HI (plus:SI (match_dup 1)
                          (match_dup 2))))]
-  "!TARGET_SCORE5U"
+  ""
   "lhu     %3, [%1, %2]+"
   [(set_attr "type" "load")
    (set_attr "mode" "HI")])
@@ -255,7 +255,7 @@
    (set (match_operand:SI 3 "register_operand" "=d")
         (mem:SI (plus:SI (match_dup 1)
                          (match_dup 2))))]
-  "!TARGET_SCORE5U"
+  ""
   "lw      %3, [%1, %2]+"
   [(set_attr "type" "load")
    (set_attr "mode" "SI")])
@@ -267,7 +267,7 @@
    (set (mem:QI (plus:SI (match_dup 1)
                          (match_dup 2)))
         (match_operand:QI 3 "register_operand" "d"))]
-  "!TARGET_SCORE5U"
+  ""
   "sb      %3, [%1, %2]+"
   [(set_attr "type" "store")
    (set_attr "mode" "QI")])
@@ -279,7 +279,7 @@
    (set (mem:HI (plus:SI (match_dup 1)
                          (match_dup 2)))
         (match_operand:HI 3 "register_operand" "d"))]
-  "!TARGET_SCORE5U"
+  ""
   "sh      %3, [%1, %2]+"
   [(set_attr "type" "store")
    (set_attr "mode" "HI")])
@@ -291,7 +291,7 @@
    (set (mem:SI (plus:SI (match_dup 1)
                          (match_dup 2)))
         (match_operand:SI 3 "register_operand" "d"))]
-  "!TARGET_SCORE5U"
+  ""
   "sw      %3, [%1, %2]+"
   [(set_attr "type" "store")
    (set_attr "mode" "SI")])
@@ -302,7 +302,7 @@
                  (const_int 4)))
    (set (reg:SI LC_REGNUM)
         (unspec:SI [(mem:BLK (match_dup 1))] LCB))]
-  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN"
+  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN && TARGET_ULS"
   "lcb     [%1]+"
   [(set_attr "type" "load")
    (set_attr "mode" "SI")])
@@ -316,7 +316,7 @@
                     (reg:SI LC_REGNUM)] LCW))
    (set (reg:SI LC_REGNUM)
         (unspec:SI [(mem:BLK (match_dup 1))] LCB))]
-  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN"
+  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN && TARGET_ULS"
   "lcw     %2, [%1]+"
   [(set_attr "type" "load")
    (set_attr "mode" "SI")])
@@ -328,7 +328,7 @@
    (set (match_operand:SI 2 "register_operand" "=d")
         (unspec:SI [(mem:BLK (match_dup 1))
                     (reg:SI LC_REGNUM)] LCE))]
-  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN"
+  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN && TARGET_ULS"
   "lce     %2, [%1]+"
   [(set_attr "type" "load")
    (set_attr "mode" "SI")])
@@ -341,7 +341,7 @@
         (unspec:BLK [(match_operand:SI 2 "register_operand" "d")] SCB))
    (set (reg:SI SC_REGNUM)
         (unspec:SI [(match_dup 2)] SCLC))]
-  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN"
+  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN && TARGET_ULS"
   "scb     %2, [%1]+"
   [(set_attr "type" "store")
    (set_attr "mode" "SI")])
@@ -355,7 +355,7 @@
                      (reg:SI SC_REGNUM)] SCW))
    (set (reg:SI SC_REGNUM)
         (unspec:SI [(match_dup 2)] SCLC))]
-  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN"
+  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN && TARGET_ULS"
   "scw     %2, [%1]+"
   [(set_attr "type" "store")
    (set_attr "mode" "SI")])
@@ -366,7 +366,7 @@
                  (const_int 4)))
    (set (mem:BLK (match_dup 1))
         (unspec:BLK [(reg:SI SC_REGNUM)] SCE))]
-  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN"
+  "!TARGET_SCORE5U && !TARGET_LITTLE_ENDIAN && TARGET_ULS"
   "sce     [%1]+"
   [(set_attr "type" "store")
    (set_attr "mode" "SI")])
Index: gcc-4_2-branch/gcc/config/score/mac.md
===================================================================
--- gcc-4_2-branch/gcc/config/score/mac.md	(revision 123014)
+++ gcc-4_2-branch/gcc/config/score/mac.md	(revision 124164)
@@ -26,7 +26,7 @@
   [(set (match_operand:SI 0 "register_operand" "=d")
         (smax:SI (match_operand:SI 1 "register_operand" "d")
                  (match_operand:SI 2 "register_operand" "d")))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "max     %0, %1, %2"
   [(set_attr "type" "arith")
    (set_attr "mode" "SI")])
@@ -35,7 +35,7 @@
   [(set (match_operand:SI 0 "register_operand" "=d")
         (smin:SI (match_operand:SI 1 "register_operand" "d")
                  (match_operand:SI 2 "register_operand" "d")))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "min     %0, %1, %2"
   [(set_attr "type" "arith")
    (set_attr "mode" "SI")])
@@ -43,7 +43,7 @@
 (define_insn "abssi2"
   [(set (match_operand:SI 0 "register_operand" "=d")
         (abs:SI (match_operand:SI 1 "register_operand" "d")))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "abs     %0, %1"
   [(set_attr "type" "arith")
    (set_attr "mode" "SI")])
@@ -51,7 +51,7 @@
 (define_insn "clzsi2"
   [(set (match_operand:SI 0 "register_operand" "=d")
         (clz:SI (match_operand:SI 1 "register_operand" "d")))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "clz     %0, %1"
   [(set_attr "type" "arith")
    (set_attr "mode" "SI")])
@@ -59,7 +59,7 @@
 (define_insn "sffs"
   [(set (match_operand:SI 0 "register_operand" "=d")
         (unspec:SI [(match_operand:SI 1 "register_operand" "d")] SFFS))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "bitrev  %0, %1, r0\;clz     %0, %0\;addi    %0, 0x1"
   [(set_attr "type" "arith")
    (set_attr "mode" "SI")])
@@ -67,7 +67,7 @@
 (define_expand "ffssi2"
   [(set (match_operand:SI 0 "register_operand")
         (ffs:SI (match_operand:SI 1 "register_operand")))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
 {
   emit_insn (gen_sffs (operands[0], operands[1]));
   emit_insn (gen_rtx_SET (VOIDmode, gen_rtx_REG (CC_NZmode, CC_REGNUM),
@@ -85,7 +85,7 @@
         (match_operand:SI 1 "register_operand" ""))
    (set (match_operand:SI 2 "hireg_operand" "")
         (match_operand:SI 3 "register_operand" ""))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   [(parallel
        [(set (match_dup 0) (match_dup 1))
         (set (match_dup 2) (match_dup 3))])])
@@ -95,7 +95,7 @@
         (match_operand:SI 1 "register_operand" ""))
    (set (match_operand:SI 2 "loreg_operand" "")
         (match_operand:SI 3 "register_operand" ""))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   [(parallel
        [(set (match_dup 2) (match_dup 3))
         (set (match_dup 0) (match_dup 1))])])
@@ -106,7 +106,7 @@
              (match_operand:SI 1 "register_operand" "d"))
         (set (match_operand:SI 2 "hireg_operand" "=h")
              (match_operand:SI 3 "register_operand" "d"))])]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "mtcehl  %3, %1"
   [(set_attr "type" "fce")
    (set_attr "mode" "SI")])
@@ -117,7 +117,7 @@
                           (match_operand:SI 3 "register_operand" "d,d,d"))
                  (match_operand:SI 1 "register_operand" "0,d,l")))
    (clobber (reg:SI HI_REGNUM))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "@
    mad     %2, %3
    mtcel%S1 %1\;mad     %2, %3
@@ -130,7 +130,7 @@
                   (mult:SI (match_operand:SI 2 "register_operand" "d,d,d")
                            (match_operand:SI 3 "register_operand" "d,d,d"))))
    (clobber (reg:SI HI_REGNUM))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "@
    msb     %2, %3
    mtcel%S1 %1\;msb     %2, %3
@@ -143,7 +143,7 @@
                   (sign_extend:DI (match_operand:SI 2 "register_operand" "%d"))
                   (sign_extend:DI (match_operand:SI 3 "register_operand" "d")))
                  (match_operand:DI 1 "register_operand" "0")))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "mad     %2, %3"
   [(set_attr "mode" "DI")])
 
@@ -153,7 +153,7 @@
                   (zero_extend:DI (match_operand:SI 2 "register_operand" "%d"))
                   (zero_extend:DI (match_operand:SI 3 "register_operand" "d")))
                  (match_operand:DI 1 "register_operand" "0")))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "madu    %2, %3"
   [(set_attr "mode" "DI")])
 
@@ -164,7 +164,7 @@
          (mult:DI
           (sign_extend:DI (match_operand:SI 2 "register_operand" "%d"))
           (sign_extend:DI (match_operand:SI 3 "register_operand" "d")))))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "msb     %2, %3"
   [(set_attr "mode" "DI")])
 
@@ -176,6 +176,6 @@
                    (match_operand:SI 2 "register_operand" "%d"))
                   (zero_extend:DI
                    (match_operand:SI 3 "register_operand" "d")))))]
-  "TARGET_MAC"
+  "TARGET_MAC || TARGET_SCORE7D"
   "msbu    %2, %3"
   [(set_attr "mode" "DI")])
Index: gcc-4_2-branch/gcc/config/score/score.h
===================================================================
--- gcc-4_2-branch/gcc/config/score/score.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/score/score.h	(revision 124164)
@@ -38,7 +38,9 @@
 
 #undef ASM_SPEC
 #define ASM_SPEC \
-  "%{!mel:-EB} %{mel:-EL} %{mscore5u:-SCORE5U} %{mscore7:-SCORE7} %{G*}"
+  "%{!mel:-EB} %{mel:-EL} %{mscore5:-SCORE5} %{mscore5u:-SCORE5U} \
+   %{mscore7:%{!mmac:-SCORE7}} %{mscore7:%{mmac:-SCORE7D}} \
+   %{mscore7d:-SCORE7D} %{G*}"
 
 #undef LINK_SPEC
 #define LINK_SPEC                "%{!mel:-EB} %{mel:-EL} %{G*}"
@@ -286,6 +288,16 @@
   128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,        \
   144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159        }
 
+/* Macro to conditionally modify fixed_regs/call_used_regs.  */
+#define PIC_OFFSET_TABLE_REGNUM          29
+
+#define CONDITIONAL_REGISTER_USAGE                     \
+{                                                      \
+   if (!flag_pic)                                      \
+     fixed_regs[PIC_OFFSET_TABLE_REGNUM] =             \
+     call_used_regs[PIC_OFFSET_TABLE_REGNUM] = 0;      \
+}
+
 #define HARD_REGNO_NREGS(REGNO, MODE) \
   ((GET_MODE_SIZE (MODE) + UNITS_PER_WORD - 1) / UNITS_PER_WORD)
 
@@ -534,7 +546,7 @@
    If `ACCUMULATE_OUTGOING_ARGS' is also defined, the only effect
    of this macro is to determine whether the space is included in
    `current_function_outgoing_args_size'.  */
-#define OUTGOING_REG_PARM_STACK_SPACE
+#define OUTGOING_REG_PARM_STACK_SPACE   1
 
 #define RETURN_POPS_ARGS(FUNDECL, FUNTYPE, STACK_SIZE) 0
 
Index: gcc-4_2-branch/gcc/config/score/score.md
===================================================================
--- gcc-4_2-branch/gcc/config/score/score.md	(revision 123014)
+++ gcc-4_2-branch/gcc/config/score/score.md	(revision 124164)
@@ -1511,7 +1511,7 @@
    (use (match_operand 2 "" ""))    ; max iterations
    (use (match_operand 3 "" ""))    ; loop level
    (use (match_operand 4 "" ""))]   ; label
-  ""
+  "!TARGET_NHWLOOP"
   {
     if (INTVAL (operands[3]) > 1)
       FAIL;
@@ -1539,6 +1539,6 @@
                  (const_int -1)))
    (clobber (reg:CC CC_REGNUM))
 ]
-  ""
+  "!TARGET_NHWLOOP"
   "bcnz %1"
   [(set_attr "type" "branch")])
Index: gcc-4_2-branch/gcc/config/score/score.opt
===================================================================
--- gcc-4_2-branch/gcc/config/score/score.opt	(revision 123014)
+++ gcc-4_2-branch/gcc/config/score/score.opt	(revision 124164)
@@ -27,10 +27,22 @@
 Target RejectNegative Report Mask(LITTLE_ENDIAN)
 Generate little-endian code
 
+mnhwloop
+Target RejectNegative Report Mask(NHWLOOP)
+Disable bcnz instruction
+
+muls
+Target RejectNegative Report Mask(ULS)
+Enable unaligned load/store instruction
+
 mmac
 Target RejectNegative Report Mask(MAC)
 Enable mac instruction
 
+mscore5
+Target RejectNegative Report Mask(SCORE5)
+Support SCORE 5 ISA
+
 mscore5u
 Target RejectNegative Report Mask(SCORE5U)
 Support SCORE 5U ISA
@@ -39,3 +51,6 @@
 Target RejectNegative Report Mask(SCORE7)
 Support SCORE 7 ISA
 
+mscore7d
+Target RejectNegative Report Mask(SCORE7D)
+Support SCORE 7D ISA
Index: gcc-4_2-branch/gcc/config/arm/linux-gas.h
===================================================================
--- gcc-4_2-branch/gcc/config/arm/linux-gas.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/arm/linux-gas.h	(revision 124164)
@@ -28,7 +28,7 @@
 #define DEFAULT_SIGNED_CHAR 0
 
 #undef  SUBTARGET_CPP_SPEC
-#define SUBTARGET_CPP_SPEC  "%{posix:-D_POSIX_SOURCE}"
+#define SUBTARGET_CPP_SPEC  "%{posix:-D_POSIX_SOURCE} %{pthread:-D_REENTRANT}"
 
 #undef  SIZE_TYPE
 #define SIZE_TYPE "unsigned int"
Index: gcc-4_2-branch/gcc/config/pa/pa.c
===================================================================
--- gcc-4_2-branch/gcc/config/pa/pa.c	(revision 123014)
+++ gcc-4_2-branch/gcc/config/pa/pa.c	(revision 124164)
@@ -9276,7 +9276,7 @@
   gcc_assert (TARGET_SOM);
   if (TARGET_GAS)
     {
-      if (cfun && !cfun->machine->in_nsubspa)
+      if (cfun && cfun->machine && !cfun->machine->in_nsubspa)
 	{
 	  /* We only want to emit a .nsubspa directive once at the
 	     start of the function.  */
@@ -9301,7 +9301,8 @@
 	     text section to output debugging information.  Thus, we
 	     need to forget that we are in the text section so that
 	     varasm.c will call us when text_section is selected again.  */
-	  gcc_assert (!cfun || cfun->machine->in_nsubspa == 2);
+	  gcc_assert (!cfun || !cfun->machine
+		      || cfun->machine->in_nsubspa == 2);
 	  in_section = NULL;
 	}
       output_section_asm_op ("\t.SPACE $TEXT$\n\t.NSUBSPA $CODE$");
Index: gcc-4_2-branch/gcc/config/darwin9.h
===================================================================
--- gcc-4_2-branch/gcc/config/darwin9.h	(revision 123014)
+++ gcc-4_2-branch/gcc/config/darwin9.h	(revision 124164)
@@ -1,2 +1,13 @@
 /* The linker can generate branch islands.  */
 #define DARWIN_LINKER_GENERATES_ISLANDS 1
+
+#undef  ASM_OUTPUT_ALIGNED_COMMON
+#define ASM_OUTPUT_ALIGNED_COMMON(FILE, NAME, SIZE, ALIGN)		\
+  do {									\
+    unsigned HOST_WIDE_INT _new_size = (SIZE);				\
+    fprintf ((FILE), ".comm ");						\
+    assemble_name ((FILE), (NAME));					\
+    if (_new_size == 0) _new_size = 1;					\
+    fprintf ((FILE), ","HOST_WIDE_INT_PRINT_UNSIGNED",%u\n",		\
+	     _new_size, floor_log2 ((ALIGN) / BITS_PER_UNIT));		\
+  } while (0)
Index: gcc-4_2-branch/gcc/reload1.c
===================================================================
--- gcc-4_2-branch/gcc/reload1.c	(revision 123014)
+++ gcc-4_2-branch/gcc/reload1.c	(revision 124164)
@@ -1167,20 +1167,6 @@
       {
 	rtx *pnote;
 
-	/* Clean up invalid ASMs so that they don't confuse later passes.
-	   See PR 21299.  */
-	if (asm_noperands (PATTERN (insn)) >= 0)
-	  {
-	    extract_insn (insn);
-	    if (!constrain_operands (1))
-	      {
-		error_for_asm (insn,
-			       "%<asm%> operand has impossible constraints");
-		delete_insn (insn);
-		continue;
-	      }
-	  }
-
 	if (CALL_P (insn))
 	  replace_pseudos_in (& CALL_INSN_FUNCTION_USAGE (insn),
 			      VOIDmode, CALL_INSN_FUNCTION_USAGE (insn));
@@ -1239,8 +1225,22 @@
 	add_auto_inc_notes (insn, PATTERN (insn));
 #endif
 
-	/* And simplify (subreg (reg)) if it appears as an operand.  */
+	/* Simplify (subreg (reg)) if it appears as an operand.  */
 	cleanup_subreg_operands (insn);
+
+	/* Clean up invalid ASMs so that they don't confuse later passes.
+	   See PR 21299.  */
+	if (asm_noperands (PATTERN (insn)) >= 0)
+	  {
+	    extract_insn (insn);
+	    if (!constrain_operands (1))
+	      {
+		error_for_asm (insn,
+			       "%<asm%> operand has impossible constraints");
+		delete_insn (insn);
+		continue;
+	      }
+	  }
       }
 
   /* If we are doing stack checking, give a warning if this function's
Index: gcc-4_2-branch/libstdc++-v3/include/ext/vstring_util.h
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/ext/vstring_util.h	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/ext/vstring_util.h	(revision 124164)
@@ -1,6 +1,6 @@
 // Versatile string utility -*- C++ -*-
 
-// Copyright (C) 2005, 2006 Free Software Foundation, Inc.
+// Copyright (C) 2005, 2006, 2007 Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
 // software; you can redistribute it and/or modify it under the
@@ -44,6 +44,7 @@
 #include <bits/functexcept.h>
 #include <locale>
 #include <algorithm> // For std::distance, srd::search.
+#include <bits/ostream_insert.h>
 
 _GLIBCXX_BEGIN_NAMESPACE(__gnu_cxx)
 
Index: gcc-4_2-branch/libstdc++-v3/include/ext/vstring.h
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/ext/vstring.h	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/ext/vstring.h	(revision 124164)
@@ -1,6 +1,6 @@
 // Versatile string -*- C++ -*-
 
-// Copyright (C) 2005, 2006 Free Software Foundation, Inc.
+// Copyright (C) 2005, 2006, 2007 Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
 // software; you can redistribute it and/or modify it under the
@@ -2140,10 +2140,15 @@
    */
   template<typename _CharT, typename _Traits, typename _Alloc,
            template <typename, typename, typename> class _Base>
-    basic_ostream<_CharT, _Traits>&
+    inline basic_ostream<_CharT, _Traits>&
     operator<<(basic_ostream<_CharT, _Traits>& __os,
 	       const __gnu_cxx::__versa_string<_CharT, _Traits,
-	                                       _Alloc, _Base>& __str);
+	                                       _Alloc, _Base>& __str)
+    {
+      // _GLIBCXX_RESOLVE_LIB_DEFECTS
+      // 586. string inserter not a formatted function
+      return __ostream_insert(__os, __str.data(), __str.size());
+    }
 
   /**
    *  @brief  Read a line from stream into a string.
Index: gcc-4_2-branch/libstdc++-v3/include/ext/pb_ds/detail/type_utils.hpp
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/ext/pb_ds/detail/type_utils.hpp	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/ext/pb_ds/detail/type_utils.hpp	(revision 124164)
@@ -52,6 +52,7 @@
 #include <utility>
 #include <tr1/type_traits>
 #include <ext/type_traits.h>
+#include <ext/numeric_traits.h>
 
 namespace pb_ds
 {
Index: gcc-4_2-branch/libstdc++-v3/include/ext/numeric_traits.h
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/ext/numeric_traits.h	(revision 0)
+++ gcc-4_2-branch/libstdc++-v3/include/ext/numeric_traits.h	(revision 124164)
@@ -0,0 +1,98 @@
+// -*- C++ -*-
+
+// Copyright (C) 2007 Free Software Foundation, Inc.
+//
+// This file is part of the GNU ISO C++ Library.  This library is free
+// software; you can redistribute it and/or modify it under the terms
+// of the GNU General Public License as published by the Free Software
+// Foundation; either version 2, or (at your option) any later
+// version.
+
+// This library is distributed in the hope that it will be useful, but
+// WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+// General Public License for more details.
+
+// You should have received a copy of the GNU General Public License along
+// with this library; see the file COPYING.  If not, write to the Free
+// Software Foundation, 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+// USA.
+
+// As a special exception, you may use this file as part of a free
+// software library without restriction.  Specifically, if other files
+// instantiate templates or use macros or inline functions from this
+// file, or you compile this file and link it with other files to
+// produce an executable, this file does not by itself cause the
+// resulting executable to be covered by the GNU General Public
+// License.  This exception does not however invalidate any other
+// reasons why the executable file might be covered by the GNU General
+// Public License.
+
+/** @file ext/numeric_traits.h
+ *  This file is a GNU extension to the Standard C++ Library.
+ */
+
+#ifndef _EXT_NUMERIC_TRAITS
+#define _EXT_NUMERIC_TRAITS 1
+
+#pragma GCC system_header
+
+#include <limits>
+#include <bits/cpp_type_traits.h>
+#include <ext/type_traits.h>
+
+_GLIBCXX_BEGIN_NAMESPACE(__gnu_cxx)
+
+  // Compile time constants for builtin types.
+  // Sadly std::numeric_limits member functions cannot be used for this.
+#define __glibcxx_signed(_Tp) ((_Tp)(-1) < 0)
+#define __glibcxx_digits(_Tp) \
+  (sizeof(_Tp) * __CHAR_BIT__ - __glibcxx_signed(_Tp))
+
+#define __glibcxx_min(_Tp) \
+  (__glibcxx_signed(_Tp) ? (_Tp)1 << __glibcxx_digits(_Tp) : (_Tp)0)
+
+#define __glibcxx_max(_Tp) \
+  (__glibcxx_signed(_Tp) ? \
+   (((((_Tp)1 << (__glibcxx_digits(_Tp) - 1)) - 1) << 1) + 1) : ~(_Tp)0)
+
+  template<typename _Value>
+    struct __numeric_traits_integer
+    {
+      // Only integers for initialization of member constant.
+      static const _Value __min = __glibcxx_min(_Value);
+      static const _Value __max = __glibcxx_max(_Value);
+    };
+
+  template<typename _Value>
+    const _Value __numeric_traits_integer<_Value>::__min;
+
+  template<typename _Value>
+    const _Value __numeric_traits_integer<_Value>::__max;
+
+  template<typename _Value>
+    struct __numeric_traits_floating
+    {
+      // Only floating point types. See N1822. 
+      static const int __max_digits10 =
+	2 + std::numeric_limits<_Value>::digits * 3010/10000;
+    };
+
+  template<typename _Value>
+    const int __numeric_traits_floating<_Value>::__max_digits10;
+
+  template<typename _Value>
+    struct __numeric_traits
+    : public __conditional_type<std::__is_integer<_Value>::__value,
+				__numeric_traits_integer<_Value>,
+				__numeric_traits_floating<_Value> >::__type
+    { };
+
+_GLIBCXX_END_NAMESPACE
+
+#undef __glibcxx_signed
+#undef __glibcxx_min
+#undef __glibcxx_max
+#undef __glibcxx_digits
+
+#endif 
Index: gcc-4_2-branch/libstdc++-v3/include/ext/type_traits.h
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/ext/type_traits.h	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/ext/type_traits.h	(revision 124164)
@@ -1,6 +1,6 @@
 // -*- C++ -*-
 
-// Copyright (C) 2005, 2006 Free Software Foundation, Inc.
+// Copyright (C) 2005, 2006, 2007 Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
 // software; you can redistribute it and/or modify it under the terms
@@ -39,8 +39,6 @@
 
 #include <cstddef>
 #include <utility>
-#include <limits>
-#include <iosfwd> // std::streamsize
 #include <bits/cpp_type_traits.h>
 
 _GLIBCXX_BEGIN_NAMESPACE(__gnu_cxx)
@@ -150,51 +148,6 @@
   template<>
     struct __remove_unsigned<wchar_t>;
 
-
-  // Compile time constants for builtin types.
-  // Sadly std::numeric_limits member functions cannot be used for this.
-#define __glibcxx_signed(_Tp) ((_Tp)(-1) < 0)
-#define __glibcxx_digits(_Tp) \
-  (sizeof(_Tp) * __CHAR_BIT__ - __glibcxx_signed(_Tp))
-
-#define __glibcxx_min(_Tp) \
-  (__glibcxx_signed(_Tp) ? (_Tp)1 << __glibcxx_digits(_Tp) : (_Tp)0)
-
-#define __glibcxx_max(_Tp) \
-  (__glibcxx_signed(_Tp) ? ((_Tp)1 << __glibcxx_digits(_Tp)) - 1 : ~(_Tp)0)
-
-  template<typename _Value>
-    struct __numeric_traits_integer
-    {
-      // Only integers for initialization of member constant.
-      static const _Value __min = __glibcxx_min(_Value);
-      static const _Value __max = __glibcxx_max(_Value);
-    };
-
-  template<typename _Value>
-    const _Value __numeric_traits_integer<_Value>::__min;
-
-  template<typename _Value>
-    const _Value __numeric_traits_integer<_Value>::__max;
-
-  template<typename _Value>
-    struct __numeric_traits_floating
-    {
-      // Only floating point types. See N1822. 
-      static const std::streamsize __max_digits10 =
-	2 + std::numeric_limits<_Value>::digits * 3010/10000;
-    };
-
-  template<typename _Value>
-    const std::streamsize __numeric_traits_floating<_Value>::__max_digits10;
-
-  template<typename _Value>
-    struct __numeric_traits 
-    : public __conditional_type<std::__is_integer<_Value>::__value,
-				__numeric_traits_integer<_Value>,
-				__numeric_traits_floating<_Value> >::__type
-    { };
-
 _GLIBCXX_END_NAMESPACE
 
 #endif 
Index: gcc-4_2-branch/libstdc++-v3/include/ext/vstring.tcc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/ext/vstring.tcc	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/ext/vstring.tcc	(revision 124164)
@@ -1,6 +1,6 @@
 // Versatile string -*- C++ -*-
 
-// Copyright (C) 2005, 2006 Free Software Foundation, Inc.
+// Copyright (C) 2005, 2006, 2007 Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
 // software; you can redistribute it and/or modify it under the
@@ -279,7 +279,7 @@
 
       if (__n <= __size)
 	{
-	  for (; __pos + __n <= __size; ++__pos)
+	  for (; __pos <= __size - __n; ++__pos)
 	    if (traits_type::eq(__data[__pos], __s[0])
 		&& traits_type::compare(__data + __pos + 1,
 					__s + 1, __n - 1) == 0)
@@ -615,39 +615,6 @@
 
   template<typename _CharT, typename _Traits, typename _Alloc,
            template <typename, typename, typename> class _Base>
-    basic_ostream<_CharT, _Traits>&
-    operator<<(basic_ostream<_CharT, _Traits>& __out,
-	       const __gnu_cxx::__versa_string<_CharT, _Traits,
-	                                       _Alloc, _Base>& __str)
-    {
-      typedef basic_ostream<_CharT, _Traits>            __ostream_type;
-
-      typename __ostream_type::sentry __cerb(__out);
-      if (__cerb)
-	{
-	  const streamsize __w = __out.width();
-	  streamsize __len = static_cast<streamsize>(__str.size());
-	  const _CharT* __s = __str.data();
-
-	  // _GLIBCXX_RESOLVE_LIB_DEFECTS
-	  // 25. String operator<< uses width() value wrong
-	  if (__w > __len)
-	    {
-	      _CharT* __cs = (static_cast<
-			      _CharT*>(__builtin_alloca(sizeof(_CharT) * __w)));
-	      __pad<_CharT, _Traits>::_S_pad(__out, __out.fill(), __cs,
-					     __s, __w, __len, false);
-	      __s = __cs;
-	      __len = __w;
-	    }
-	  __out._M_write(__s, __len);
-	  __out.width(0);
-	}
-      return __out;
-    }
-
-  template<typename _CharT, typename _Traits, typename _Alloc,
-           template <typename, typename, typename> class _Base>
     basic_istream<_CharT, _Traits>&
     getline(basic_istream<_CharT, _Traits>& __in,
 	    __gnu_cxx::__versa_string<_CharT, _Traits, _Alloc, _Base>& __str,
Index: gcc-4_2-branch/libstdc++-v3/include/bits/stl_map.h
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/bits/stl_map.h	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/bits/stl_map.h	(revision 124164)
@@ -1,6 +1,7 @@
 // Map implementation -*- C++ -*-
 
-// Copyright (C) 2001, 2002, 2004, 2005, 2006 Free Software Foundation, Inc.
+// Copyright (C) 2001, 2002, 2003, 2004, 2005, 2006, 2007
+// Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
 // software; you can redistribute it and/or modify it under the
@@ -394,7 +395,7 @@
        *
        *  Insertion requires logarithmic time.
        */
-      std::pair<iterator,bool>
+      std::pair<iterator, bool>
       insert(const value_type& __x)
       { return _M_t._M_insert_unique(__x); }
 
@@ -422,8 +423,8 @@
        *  Insertion requires logarithmic time (if the hint is not taken).
        */
       iterator
-      insert(iterator position, const value_type& __x)
-      { return _M_t._M_insert_unique(position, __x); }
+      insert(iterator __position, const value_type& __x)
+      { return _M_t._M_insert_unique(__position, __x); }
 
       /**
        *  @brief Template function that attemps to insert a range of elements.
Index: gcc-4_2-branch/libstdc++-v3/include/bits/basic_string.h
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/bits/basic_string.h	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/bits/basic_string.h	(revision 124164)
@@ -1,6 +1,7 @@
 // Components for manipulating sequences of characters -*- C++ -*-
 
-// Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006
+// Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005,
+// 2006, 2007
 // Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
@@ -2400,7 +2401,7 @@
     {
       // _GLIBCXX_RESOLVE_LIB_DEFECTS
       // 586. string inserter not a formatted function
-      return __os._M_insert(__str.data(), __str.size());
+      return __ostream_insert(__os, __str.data(), __str.size());
     }
 
   /**
Index: gcc-4_2-branch/libstdc++-v3/include/bits/ostream.tcc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/bits/ostream.tcc	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/bits/ostream.tcc	(revision 124164)
@@ -283,38 +283,6 @@
 
   template<typename _CharT, typename _Traits>
     basic_ostream<_CharT, _Traits>&
-    basic_ostream<_CharT, _Traits>::
-    _M_insert(const char_type* __s, streamsize __n)
-    {
-      sentry __cerb(*this);
-      if (__cerb)
-	{
-	  try
-	    {
-	      const streamsize __w = this->width();
-	      if (__w > __n)
-		{
-		  const bool __left = ((this->flags() & ios_base::adjustfield)
-				       == ios_base::left);
-		  if (!__left)
-		    _M_write(this->fill(), __w - __n);
-		  if (this->good())
-		    _M_write(__s, __n);
-		  if (__left && this->good())
-		    _M_write(this->fill(), __w - __n);
-		}
-	      else
-		_M_write(__s, __n);
-	      this->width(0);
-	    }
-	  catch(...)
-	    { this->_M_setstate(ios_base::badbit); }
-	}
-      return *this;
-    }
-
-  template<typename _CharT, typename _Traits>
-    basic_ostream<_CharT, _Traits>&
     operator<<(basic_ostream<_CharT, _Traits>& __out, const char* __s)
     {
       if (!__s)
@@ -340,7 +308,7 @@
 
 	  try
 	    {
-	      __out._M_insert(__ws, __clen);
+	      __ostream_insert(__out, __ws, __clen);
 	      delete [] __ws;
 	    }
 	  catch(...)
@@ -366,6 +334,7 @@
   extern template ostream& operator<<(ostream&, const char*);
   extern template ostream& operator<<(ostream&, const unsigned char*);
   extern template ostream& operator<<(ostream&, const signed char*);
+  extern template ostream& __ostream_insert(ostream&, const char*, streamsize);
 
   extern template ostream& ostream::_M_insert(long);
   extern template ostream& ostream::_M_insert(unsigned long);
@@ -387,6 +356,8 @@
   extern template wostream& operator<<(wostream&, char);
   extern template wostream& operator<<(wostream&, const wchar_t*);
   extern template wostream& operator<<(wostream&, const char*);
+  extern template wostream& __ostream_insert(wostream&, const wchar_t*,
+					     streamsize);
 
   extern template wostream& wostream::_M_insert(long);
   extern template wostream& wostream::_M_insert(unsigned long);
Index: gcc-4_2-branch/libstdc++-v3/include/bits/basic_string.tcc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/bits/basic_string.tcc	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/bits/basic_string.tcc	(revision 124164)
@@ -1,6 +1,7 @@
 // Components for manipulating sequences of characters -*- C++ -*-
 
-// Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006
+// Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005,
+// 2006, 2007
 // Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
@@ -726,7 +727,7 @@
 
       if (__n <= __size)
 	{
-	  for (; __pos + __n <= __size; ++__pos)
+	  for (; __pos <= __size - __n; ++__pos)
 	    if (traits_type::eq(__data[__pos], __s[0])
 		&& traits_type::compare(__data + __pos + 1,
 					__s + 1, __n - 1) == 0)
Index: gcc-4_2-branch/libstdc++-v3/include/bits/ostream_insert.h
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/bits/ostream_insert.h	(revision 0)
+++ gcc-4_2-branch/libstdc++-v3/include/bits/ostream_insert.h	(revision 124164)
@@ -0,0 +1,114 @@
+// Helpers for ostream inserters -*- C++ -*-
+
+// Copyright (C) 2007 Free Software Foundation, Inc.
+//
+// This file is part of the GNU ISO C++ Library.  This library is free
+// software; you can redistribute it and/or modify it under the
+// terms of the GNU General Public License as published by the
+// Free Software Foundation; either version 2, or (at your option)
+// any later version.
+
+// This library is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+
+// You should have received a copy of the GNU General Public License along
+// with this library; see the file COPYING.  If not, write to the Free
+// Software Foundation, 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+// USA.
+
+// As a special exception, you may use this file as part of a free software
+// library without restriction.  Specifically, if other files instantiate
+// templates or use macros or inline functions from this file, or you compile
+// this file and link it with other files to produce an executable, this
+// file does not by itself cause the resulting executable to be covered by
+// the GNU General Public License.  This exception does not however
+// invalidate any other reasons why the executable file might be covered by
+// the GNU General Public License.
+
+/** @file ostream_insert.h
+ *  This is an internal header file, included by other library headers.
+ *  You should not attempt to use it directly.
+ */
+
+#ifndef _OSTREAM_INSERT_H
+#define _OSTREAM_INSERT_H 1
+
+#pragma GCC system_header
+
+#include <iosfwd>
+
+_GLIBCXX_BEGIN_NAMESPACE(std)
+
+  template<typename _CharT, typename _Traits>
+    inline void
+    __ostream_write(basic_ostream<_CharT, _Traits>& __out,
+		    const _CharT* __s, streamsize __n)
+    {
+      typedef basic_ostream<_CharT, _Traits>       __ostream_type;      
+      typedef typename __ostream_type::ios_base    __ios_base;
+
+      const streamsize __put = __out.rdbuf()->sputn(__s, __n);
+      if (__put != __n)
+	__out.setstate(__ios_base::badbit);
+    }
+
+  template<typename _CharT, typename _Traits>
+    inline void
+    __ostream_fill(basic_ostream<_CharT, _Traits>& __out, streamsize __n)
+    {
+      typedef basic_ostream<_CharT, _Traits>       __ostream_type;      
+      typedef typename __ostream_type::ios_base    __ios_base;
+
+      const _CharT __c = __out.fill();
+      for (; __n > 0; --__n)
+	{
+	  const typename _Traits::int_type __put = __out.rdbuf()->sputc(__c);
+	  if (_Traits::eq_int_type(__put, _Traits::eof()))
+	    {
+	      __out.setstate(__ios_base::badbit);
+	      break;
+	    }
+	}
+    }
+
+  template<typename _CharT, typename _Traits>
+    basic_ostream<_CharT, _Traits>&
+    __ostream_insert(basic_ostream<_CharT, _Traits>& __out,
+		     const _CharT* __s, streamsize __n)
+    {
+      typedef basic_ostream<_CharT, _Traits>       __ostream_type;
+      typedef typename __ostream_type::ios_base    __ios_base;
+
+      typename __ostream_type::sentry __cerb(__out);
+      if (__cerb)
+	{
+	  try
+	    {
+	      const streamsize __w = __out.width();
+	      if (__w > __n)
+		{
+		  const bool __left = ((__out.flags()
+					& __ios_base::adjustfield)
+				       == __ios_base::left);
+		  if (!__left)
+		    __ostream_fill(__out, __w - __n);
+		  if (__out.good())
+		    __ostream_write(__out, __s, __n);
+		  if (__left && __out.good())
+		    __ostream_fill(__out, __w - __n);
+		}
+	      else
+		__ostream_write(__out, __s, __n);
+	      __out.width(0);
+	    }
+	  catch(...)
+	    { __out._M_setstate(__ios_base::badbit); }
+	}
+      return __out;
+    }
+
+_GLIBCXX_END_NAMESPACE
+
+#endif /* _OSTREAM_INSERT_H */
Index: gcc-4_2-branch/libstdc++-v3/include/Makefile.in
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/Makefile.in	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/Makefile.in	(revision 124164)
@@ -343,6 +343,7 @@
 	${bits_srcdir}/localefwd.h \
 	${bits_srcdir}/mask_array.h \
 	${bits_srcdir}/ostream.tcc \
+	${bits_srcdir}/ostream_insert.h \
 	${bits_srcdir}/postypes.h \
 	${bits_srcdir}/stream_iterator.h \
 	${bits_srcdir}/streambuf_iterator.h \
@@ -756,6 +757,7 @@
 	${ext_srcdir}/mt_allocator.h \
 	${ext_srcdir}/new_allocator.h \
 	${ext_srcdir}/numeric \
+	${ext_srcdir}/numeric_traits.h \
 	${ext_srcdir}/pod_char_traits.h \
 	${ext_srcdir}/pool_allocator.h \
 	${ext_srcdir}/rb_tree \
Index: gcc-4_2-branch/libstdc++-v3/include/tr1/random
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/tr1/random	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/tr1/random	(revision 124164)
@@ -43,6 +43,7 @@
 #include <tr1/type_traits>
 #include <tr1/cmath>
 #include <ext/type_traits.h>
+#include <ext/numeric_traits.h>
 #include <bits/concept_check.h>
 #include <debug/debug.h>
 
Index: gcc-4_2-branch/libstdc++-v3/include/Makefile.am
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/Makefile.am	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/Makefile.am	(revision 124164)
@@ -117,6 +117,7 @@
 	${bits_srcdir}/localefwd.h \
 	${bits_srcdir}/mask_array.h \
 	${bits_srcdir}/ostream.tcc \
+	${bits_srcdir}/ostream_insert.h \
 	${bits_srcdir}/postypes.h \
 	${bits_srcdir}/stream_iterator.h \
 	${bits_srcdir}/streambuf_iterator.h \
@@ -534,6 +535,7 @@
 	${ext_srcdir}/mt_allocator.h \
 	${ext_srcdir}/new_allocator.h \
 	${ext_srcdir}/numeric \
+	${ext_srcdir}/numeric_traits.h \
 	${ext_srcdir}/pod_char_traits.h \
 	${ext_srcdir}/pool_allocator.h \
 	${ext_srcdir}/rb_tree \
Index: gcc-4_2-branch/libstdc++-v3/include/std/std_string.h
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/std/std_string.h	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/std/std_string.h	(revision 124164)
@@ -1,6 +1,7 @@
 // Components for manipulating sequences of characters -*- C++ -*-
 
-// Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2005
+// Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005,
+// 2006, 2007
 // Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
@@ -47,6 +48,7 @@
 #include <memory> 	// For allocator.
 #include <bits/cpp_type_traits.h>
 #include <iosfwd> 	// For operators >>, <<, and getline decls.
+#include <bits/ostream_insert.h>
 #include <bits/stl_iterator.h>
 #include <bits/stl_function.h>  // For less
 #include <bits/basic_string.h>
Index: gcc-4_2-branch/libstdc++-v3/include/std/std_ostream.h
===================================================================
--- gcc-4_2-branch/libstdc++-v3/include/std/std_ostream.h	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/include/std/std_ostream.h	(revision 124164)
@@ -1,6 +1,7 @@
 // Output streams -*- C++ -*-
 
-// Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2005, 2006
+// Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005,
+// 2006, 2007
 // Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
@@ -42,6 +43,7 @@
 #pragma GCC system_header
 
 #include <ios>
+#include <bits/ostream_insert.h>
 
 _GLIBCXX_BEGIN_NAMESPACE(std)
 
@@ -72,31 +74,6 @@
       							__num_put_type;
       typedef ctype<_CharT>           			__ctype_type;
 
-      template<typename _CharT2, typename _Traits2>
-        friend basic_ostream<_CharT2, _Traits2>&
-        operator<<(basic_ostream<_CharT2, _Traits2>&, _CharT2);
- 
-      template<typename _Traits2>
-        friend basic_ostream<char, _Traits2>&
-        operator<<(basic_ostream<char, _Traits2>&, char);
- 
-      template<typename _CharT2, typename _Traits2>
-        friend basic_ostream<_CharT2, _Traits2>&
-        operator<<(basic_ostream<_CharT2, _Traits2>&, const _CharT2*);
- 
-      template<typename _Traits2>
-        friend basic_ostream<char, _Traits2>&
-        operator<<(basic_ostream<char, _Traits2>&, const char*);
- 
-      template<typename _CharT2, typename _Traits2>
-        friend basic_ostream<_CharT2, _Traits2>&
-        operator<<(basic_ostream<_CharT2, _Traits2>&, const char*);
-
-      template<typename _CharT2, typename _Traits2, typename _Alloc>
-        friend basic_ostream<_CharT2, _Traits2>&
-        operator<<(basic_ostream<_CharT2, _Traits2>&,
-		   const basic_string<_CharT2, _Traits2, _Alloc>&);
-
       // [27.6.2.2] constructor/destructor
       /**
        *  @brief  Base constructor.
@@ -318,20 +295,6 @@
 	  this->setstate(ios_base::badbit);
       }
 
-      void
-      _M_write(char_type __c, streamsize __n)
-      {
-	for (; __n > 0; --__n)
-	  {
-	    const int_type __put = this->rdbuf()->sputc(__c);
-	    if (traits_type::eq_int_type(__put, traits_type::eof()))
-	      {
-		this->setstate(ios_base::badbit);
-		break;
-	      }
-	  }
-      }
-
       /**
        *  @brief  Character string insertion.
        *  @param  s  The array to insert.
@@ -405,9 +368,6 @@
       template<typename _ValueT>
         __ostream_type&
         _M_insert(_ValueT __v);
-
-      __ostream_type&
-      _M_insert(const char_type* __s, streamsize __n);
     };
 
   /**
@@ -491,7 +451,7 @@
   template<typename _CharT, typename _Traits>
     inline basic_ostream<_CharT, _Traits>&
     operator<<(basic_ostream<_CharT, _Traits>& __out, _CharT __c)
-    { return __out._M_insert(&__c, 1); }
+    { return __ostream_insert(__out, &__c, 1); }
 
   template<typename _CharT, typename _Traits>
     inline basic_ostream<_CharT, _Traits>&
@@ -502,7 +462,7 @@
   template <class _Traits> 
     inline basic_ostream<char, _Traits>&
     operator<<(basic_ostream<char, _Traits>& __out, char __c)
-    { return __out._M_insert(&__c, 1); }
+    { return __ostream_insert(__out, &__c, 1); }
 
   // Signed and unsigned
   template<class _Traits>
@@ -537,7 +497,8 @@
       if (!__s)
 	__out.setstate(ios_base::badbit);
       else
-	__out._M_insert(__s, static_cast<streamsize>(_Traits::length(__s)));
+	__ostream_insert(__out, __s,
+			 static_cast<streamsize>(_Traits::length(__s)));
       return __out;
     }
 
@@ -553,7 +514,8 @@
       if (!__s)
 	__out.setstate(ios_base::badbit);
       else
-	__out._M_insert(__s, static_cast<streamsize>(_Traits::length(__s)));
+	__ostream_insert(__out, __s,
+			 static_cast<streamsize>(_Traits::length(__s)));
       return __out;
     }
 
Index: gcc-4_2-branch/libstdc++-v3/ChangeLog
===================================================================
--- gcc-4_2-branch/libstdc++-v3/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/ChangeLog	(revision 124164)
@@ -1,3 +1,73 @@
+2007-04-12  Paolo Carlini  <pcarlini@suse.de>
+
+	PR libstdc++/28277 (partial: vstring bits)
+	* include/bits/ostream_insert.h: New.
+	* include/Makefile.am: Add.
+	* include/ext/vstring.h (operator<<(basic_ostream<>&,
+	const __versa_string<>&): Forward to __ostream_insert.
+	* include/bits/basic_string.h (operator<<(basic_ostream<>&,
+	const string<>&)): Likewise.
+	* include/std/std_ostream.h (operator<<(basic_ostream<>&, _CharT),
+	operator<<(basic_ostream<char,>&, char), operator<<(basic_ostream<>&,
+	const _CharT*), operator<<(basic_ostream<char,>&, const char*)):
+	Likewise.
+	* include/ext/vstring.tcc (operator<<(basic_ostream<>&,
+	const __versa_string<>&)): Remove.
+	(class basic_ostream): Remove friend declarations.
+	(basic_ostream<>::_M_write(char_type, streamsize),
+	_M_insert(const char_type*, streamsize)): Remove.
+	* include/bits/ostream.tcc (_M_insert(const char_type*, streamsize)):
+	Remove definition.
+	(operator<<(basic_ostream<>&, const char*)): Use __ostream_insert.
+	* include/ext/vstring_util.h: Include <bits/ostream_insert.h>.
+	* include/std/std_string.h: Likewise.
+	* config/abi/pre/gnu.ver: Adjust.
+	* src/ostream-inst.cc: Add __ostream_insert instantiations.
+	* include/Makefile.in: Rebuild.
+	* testsuite/ext/vstring/inserters_extractors/char/28277.cc: New.
+	* testsuite/ext/vstring/inserters_extractors/wchar_t/28277.cc: New.
+
+2007-04-07  Paolo Carlini  <pcarlini@suse.de>
+
+	PR libstdc++/31481
+	* include/ext/type_traits.h (__numeric_traits): Move...
+	* include/ext/numeric_traits.h: ... here; fix type of
+	__max_digits10.
+	* include/Makefile.am: Add.
+	* include/ext/pb_ds/detail/type_utils.hpp: Include 
+	<ext/numeric_traits.h> too.
+	* include/tr1/random: Likewise.
+	* testsuite/ext/type_traits/numeric_traits.cc: Move...
+	* testsuite/ext/numeric_traits/numeric_traits.cc: ... here.
+	* include/Makefile.in: Regenerate.
+	* testsuite/ext/type_traits/remove_unsigned_integer_neg.cc:
+	Adjust dg-error line number.
+	* testsuite/ext/type_traits/add_unsigned_floating_neg.cc:
+	Likewise.
+	* testsuite/ext/type_traits/remove_unsigned_floating_neg.cc:
+	Likewise.
+	* testsuite/ext/type_traits/add_unsigned_integer_neg.cc:
+	Likewise.
+
+2007-04-03  Paolo Carlini  <pcarlini@suse.de>
+
+	* include/bits/stl_map.h (map<>::insert(iterator, const value_type&):
+	Uglify parameter.
+
+2007-04-02  Paolo Carlini  <pcarlini@suse.de>
+
+	PR libstdc++/31401 (vstring bits)
+	* include/ext/vstring.tcc (find(const _CharT*, size_type,
+	size_type)): Avoid unsigned overflow.
+
+2007-03-30  Paolo Carlini  <pcarlini@suse.de>
+
+	PR libstdc++/31401
+	* include/bits/basic_string.tcc (find(const _CharT*, size_type,
+	size_type)): Avoid unsigned overflow.
+	* testsuite/21_strings/basic_string/find/char/4.cc: New.
+	* testsuite/21_strings/basic_string/find/wchar_t/4.cc: Likewise.
+
 2007-03-06  Paolo Carlini  <pcarlini@suse.de>
 
 	PR libstdc++/28080 (partial)
Index: gcc-4_2-branch/libstdc++-v3/src/ostream-inst.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/src/ostream-inst.cc	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/src/ostream-inst.cc	(revision 124164)
@@ -55,6 +55,7 @@
   template ostream& operator<<(ostream&, _Setbase);
   template ostream& operator<<(ostream&, _Setprecision);
   template ostream& operator<<(ostream&, _Setw);
+  template ostream& __ostream_insert(ostream&, const char*, streamsize);
 
   template ostream& ostream::_M_insert(long);
   template ostream& ostream::_M_insert(unsigned long);
@@ -83,6 +84,7 @@
   template wostream& operator<<(wostream&, _Setbase);
   template wostream& operator<<(wostream&, _Setprecision);
   template wostream& operator<<(wostream&, _Setw);
+  template wostream& __ostream_insert(wostream&, const wchar_t*, streamsize);
 
   template wostream& wostream::_M_insert(long);
   template wostream& wostream::_M_insert(unsigned long);
Index: gcc-4_2-branch/libstdc++-v3/testsuite/21_strings/basic_string/find/wchar_t/4.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/testsuite/21_strings/basic_string/find/wchar_t/4.cc	(revision 0)
+++ gcc-4_2-branch/libstdc++-v3/testsuite/21_strings/basic_string/find/wchar_t/4.cc	(revision 124164)
@@ -0,0 +1,43 @@
+// 2007-03-30  Paolo Carlini  <pcarlini@suse.de>
+
+// Copyright (C) 2007 Free Software Foundation, Inc.
+//
+// This file is part of the GNU ISO C++ Library.  This library is free
+// software; you can redistribute it and/or modify it under the
+// terms of the GNU General Public License as published by the
+// Free Software Foundation; either version 2, or (at your option)
+// any later version.
+
+// This library is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+
+// You should have received a copy of the GNU General Public License along
+// with this library; see the file COPYING.  If not, write to the Free
+// Software Foundation, 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+// USA.
+
+// 21.3.6.1 basic_string find
+
+#include <string>
+#include <testsuite_hooks.h>
+
+// libstdc++/31401
+void test01()
+{
+  bool test __attribute__((unused)) = true;
+  typedef std::wstring::size_type csize_type;
+  csize_type npos = std::wstring::npos;
+
+  std::wstring use = L"anu";
+  csize_type pos1 = use.find(L"a", npos);
+
+  VERIFY( pos1 == npos );
+}
+
+int main()
+{
+  test01();
+  return 0;
+}
Index: gcc-4_2-branch/libstdc++-v3/testsuite/21_strings/basic_string/find/char/4.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/testsuite/21_strings/basic_string/find/char/4.cc	(revision 0)
+++ gcc-4_2-branch/libstdc++-v3/testsuite/21_strings/basic_string/find/char/4.cc	(revision 124164)
@@ -0,0 +1,43 @@
+// 2007-03-30  Paolo Carlini  <pcarlini@suse.de>
+
+// Copyright (C) 2007 Free Software Foundation, Inc.
+//
+// This file is part of the GNU ISO C++ Library.  This library is free
+// software; you can redistribute it and/or modify it under the
+// terms of the GNU General Public License as published by the
+// Free Software Foundation; either version 2, or (at your option)
+// any later version.
+
+// This library is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+
+// You should have received a copy of the GNU General Public License along
+// with this library; see the file COPYING.  If not, write to the Free
+// Software Foundation, 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+// USA.
+
+// 21.3.6.1 basic_string find
+
+#include <string>
+#include <testsuite_hooks.h>
+
+// libstdc++/31401
+void test01()
+{
+  bool test __attribute__((unused)) = true;
+  typedef std::string::size_type csize_type;
+  csize_type npos = std::string::npos;
+
+  std::string use = "anu";
+  csize_type pos1 = use.find("a", npos);
+
+  VERIFY( pos1 == npos );
+}
+
+int main()
+{
+  test01();
+  return 0;
+}
Index: gcc-4_2-branch/libstdc++-v3/testsuite/ext/numeric_traits/numeric_traits.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/testsuite/ext/numeric_traits/numeric_traits.cc	(revision 0)
+++ gcc-4_2-branch/libstdc++-v3/testsuite/ext/numeric_traits/numeric_traits.cc	(revision 124164)
@@ -0,0 +1,28 @@
+// { dg-do compile }
+// { dg-options "-pedantic" }
+// -*- C++ -*-
+
+// Copyright (C) 2006 Free Software Foundation, Inc.
+//
+// This file is part of the GNU ISO C++ Library.  This library is free
+// software; you can redistribute it and/or modify it under the
+// terms of the GNU General Public License as published by the
+// Free Software Foundation; either version 2, or (at your option)
+// any later version.
+//
+// This library is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License along
+// with this library; see the file COPYING.  If not, write to the Free
+// Software Foundation, 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+// USA.
+
+#include <ext/numeric_traits.h>
+
+using __gnu_cxx::__numeric_traits;
+template struct __numeric_traits<short>;
+template struct __numeric_traits<unsigned short>;
+template struct __numeric_traits<double>;
Index: gcc-4_2-branch/libstdc++-v3/testsuite/ext/vstring/inserters_extractors/wchar_t/28277.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/testsuite/ext/vstring/inserters_extractors/wchar_t/28277.cc	(revision 0)
+++ gcc-4_2-branch/libstdc++-v3/testsuite/ext/vstring/inserters_extractors/wchar_t/28277.cc	(revision 124164)
@@ -0,0 +1,48 @@
+// 2007-04-09  Paolo Carlini  <pcarlini@suse.de>
+
+// Copyright (C) 2007 Free Software Foundation
+//
+// This file is part of the GNU ISO C++ Library.  This library is free
+// software; you can redistribute it and/or modify it under the
+// terms of the GNU General Public License as published by the
+// Free Software Foundation; either version 2, or (at your option)
+// any later version.
+
+// This library is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+
+// You should have received a copy of the GNU General Public License along
+// with this library; see the file COPYING.  If not, write to the Free
+// Software Foundation, 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+// USA.
+
+#include <ostream>
+#include <sstream>
+#include <ext/vstring.h>
+#include <testsuite_hooks.h>
+
+// libstdc++/28277
+void test01()
+{
+  using namespace std;
+  bool test __attribute__((unused)) = true;
+
+  wostringstream oss_01;
+  const __gnu_cxx::__wvstring str_01(50, L'a');
+
+  oss_01.width(5000000);
+  const streamsize width = oss_01.width();
+
+  oss_01 << str_01;
+
+  VERIFY( oss_01.good() );
+  VERIFY( oss_01.str().size() == width );
+}
+
+int main()
+{
+  test01();
+  return 0;
+}
Index: gcc-4_2-branch/libstdc++-v3/testsuite/ext/vstring/inserters_extractors/char/28277.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/testsuite/ext/vstring/inserters_extractors/char/28277.cc	(revision 0)
+++ gcc-4_2-branch/libstdc++-v3/testsuite/ext/vstring/inserters_extractors/char/28277.cc	(revision 124164)
@@ -0,0 +1,48 @@
+// 2007-04-09  Paolo Carlini  <pcarlini@suse.de>
+
+// Copyright (C) 2007 Free Software Foundation
+//
+// This file is part of the GNU ISO C++ Library.  This library is free
+// software; you can redistribute it and/or modify it under the
+// terms of the GNU General Public License as published by the
+// Free Software Foundation; either version 2, or (at your option)
+// any later version.
+
+// This library is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+
+// You should have received a copy of the GNU General Public License along
+// with this library; see the file COPYING.  If not, write to the Free
+// Software Foundation, 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+// USA.
+
+#include <ostream>
+#include <sstream>
+#include <ext/vstring.h>
+#include <testsuite_hooks.h>
+
+// libstdc++/28277
+void test01()
+{
+  using namespace std;
+  bool test __attribute__((unused)) = true;
+
+  ostringstream oss_01;
+  const __gnu_cxx::__vstring str_01(50, 'a');
+
+  oss_01.width(20000000);
+  const streamsize width = oss_01.width();
+
+  oss_01 << str_01;
+
+  VERIFY( oss_01.good() );
+  VERIFY( oss_01.str().size() == width );
+}
+
+int main()
+{
+  test01();
+  return 0;
+}
Index: gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/numeric_traits.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/numeric_traits.cc	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/numeric_traits.cc	(revision 124164)
@@ -1,28 +0,0 @@
-// { dg-do compile }
-// { dg-options "-pedantic" }
-// -*- C++ -*-
-
-// Copyright (C) 2006 Free Software Foundation, Inc.
-//
-// This file is part of the GNU ISO C++ Library.  This library is free
-// software; you can redistribute it and/or modify it under the
-// terms of the GNU General Public License as published by the
-// Free Software Foundation; either version 2, or (at your option)
-// any later version.
-//
-// This library is distributed in the hope that it will be useful,
-// but WITHOUT ANY WARRANTY; without even the implied warranty of
-// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-// GNU General Public License for more details.
-//
-// You should have received a copy of the GNU General Public License along
-// with this library; see the file COPYING.  If not, write to the Free
-// Software Foundation, 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
-// USA.
-
-#include <ext/type_traits.h>
-
-using __gnu_cxx::__numeric_traits;
-template struct __numeric_traits<short>;
-template struct __numeric_traits<unsigned short>;
-template struct __numeric_traits<double>;
Index: gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/remove_unsigned_integer_neg.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/remove_unsigned_integer_neg.cc	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/remove_unsigned_integer_neg.cc	(revision 124164)
@@ -1,7 +1,7 @@
 // { dg-do compile }
 // -*- C++ -*-
 
-// Copyright (C) 2006 Free Software Foundation, Inc.
+// Copyright (C) 2006, 2007 Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
 // software; you can redistribute it and/or modify it under the
@@ -37,4 +37,4 @@
 }
 
 // { dg-error "invalid use of incomplete" "" { target *-*-* } 29 } 
-// { dg-error "declaration of" "" { target *-*-* } 114 } 
+// { dg-error "declaration of" "" { target *-*-* } 112 } 
Index: gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/add_unsigned_floating_neg.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/add_unsigned_floating_neg.cc	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/add_unsigned_floating_neg.cc	(revision 124164)
@@ -1,7 +1,7 @@
 // { dg-do compile }
 // -*- C++ -*-
 
-// Copyright (C) 2006 Free Software Foundation, Inc.
+// Copyright (C) 2006, 2007 Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
 // software; you can redistribute it and/or modify it under the
@@ -36,5 +36,5 @@
 }
 
 // { dg-error "instantiated from" "" { target *-*-* } 29 } 
-// { dg-error "no type" "" { target *-*-* } 76 } 
+// { dg-error "no type" "" { target *-*-* } 74 } 
 // { dg-excess-errors "In instantiation of" }
Index: gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/remove_unsigned_floating_neg.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/remove_unsigned_floating_neg.cc	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/remove_unsigned_floating_neg.cc	(revision 124164)
@@ -1,7 +1,7 @@
 // { dg-do compile }
 // -*- C++ -*-
 
-// Copyright (C) 2006 Free Software Foundation, Inc.
+// Copyright (C) 2006, 2007 Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
 // software; you can redistribute it and/or modify it under the
@@ -36,5 +36,5 @@
 }
 
 // { dg-error "instantiated from" "" { target *-*-* } 29 }
-// { dg-error "no type" "" { target *-*-* } 119 }
+// { dg-error "no type" "" { target *-*-* } 117 }
 // { dg-excess-errors "In instantiation of" }
Index: gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/add_unsigned_integer_neg.cc
===================================================================
--- gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/add_unsigned_integer_neg.cc	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/testsuite/ext/type_traits/add_unsigned_integer_neg.cc	(revision 124164)
@@ -1,7 +1,7 @@
 // { dg-do compile }
 // -*- C++ -*-
 
-// Copyright (C) 2006 Free Software Foundation, Inc.
+// Copyright (C) 2006, 2007 Free Software Foundation, Inc.
 //
 // This file is part of the GNU ISO C++ Library.  This library is free
 // software; you can redistribute it and/or modify it under the
@@ -37,4 +37,4 @@
 }
 
 // { dg-error "invalid use of incomplete" "" { target *-*-* } 29 } 
-// { dg-error "declaration of" "" { target *-*-* } 71 } 
+// { dg-error "declaration of" "" { target *-*-* } 69 } 
Index: gcc-4_2-branch/libstdc++-v3/config/abi/pre/gnu.ver
===================================================================
--- gcc-4_2-branch/libstdc++-v3/config/abi/pre/gnu.ver	(revision 123014)
+++ gcc-4_2-branch/libstdc++-v3/config/abi/pre/gnu.ver	(revision 124164)
@@ -676,8 +676,7 @@
 
     _ZSt21__copy_streambufs_eofI[cw]St11char_traitsI[cw]EE[il]PSt15basic_streambuf*;
 
-    _ZNSo9_M_insertEPKc[il];
-    _ZNSt13basic_ostreamIwSt11char_traitsIwEE9_M_insertEPKw[il];
+    _ZSt16__ostream_insert*;
 
     _ZN11__gnu_debug19_Safe_sequence_base12_M_get_mutexEv;
     _ZN11__gnu_debug19_Safe_iterator_base16_M_attach_singleEPNS_19_Safe_sequence_baseEb;
Index: gcc-4_2-branch/libgfortran/configure
===================================================================
--- gcc-4_2-branch/libgfortran/configure	(revision 123014)
+++ gcc-4_2-branch/libgfortran/configure	(revision 124164)
@@ -10222,7 +10222,10 @@
 
 
 
-for ac_func in wait setmode gettimeofday
+
+
+
+for ac_func in wait setmode gettimeofday stat fstat lstat
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
 echo "$as_me:$LINENO: checking for $ac_func" >&5
Index: gcc-4_2-branch/libgfortran/intrinsics/stat.c
===================================================================
--- gcc-4_2-branch/libgfortran/intrinsics/stat.c	(revision 123014)
+++ gcc-4_2-branch/libgfortran/intrinsics/stat.c	(revision 124164)
@@ -49,6 +49,9 @@
 
 #include <errno.h>
 
+
+#ifdef HAVE_STAT
+
 /* SUBROUTINE STAT(FILE, SARRAY, STATUS)
    CHARACTER(len=*), INTENT(IN) :: FILE
    INTEGER, INTENT(OUT), :: SARRAY(13)
@@ -88,9 +91,12 @@
   memcpy (str, name, name_len);
   str[name_len] = '\0';
 
+  /* On platforms that don't provide lstat(), we use stat() instead.  */
+#ifdef HAVE_LSTAT
   if (is_lstat)
     val = lstat(str, &sb);
   else
+#endif
     val = stat(str, &sb);
 
   if (val == 0)
@@ -204,9 +210,12 @@
   memcpy (str, name, name_len);
   str[name_len] = '\0';
 
+  /* On platforms that don't provide lstat(), we use stat() instead.  */
+#ifdef HAVE_LSTAT
   if (is_lstat)
     val = lstat(str, &sb);
   else
+#endif
     val = stat(str, &sb);
 
   if (val == 0)
@@ -319,13 +328,13 @@
 }
 
 
-/* SUBROUTINE STAT(FILE, SARRAY, STATUS)
+/* SUBROUTINE LSTAT(FILE, SARRAY, STATUS)
    CHARACTER(len=*), INTENT(IN) :: FILE
    INTEGER, INTENT(OUT), :: SARRAY(13)
    INTEGER, INTENT(OUT), OPTIONAL :: STATUS
 
-   FUNCTION STAT(FILE, SARRAY)
-   INTEGER STAT
+   FUNCTION LSTAT(FILE, SARRAY)
+   INTEGER LSTAT
    CHARACTER(len=*), INTENT(IN) :: FILE
    INTEGER, INTENT(OUT), :: SARRAY(13)  */
 
@@ -351,8 +360,11 @@
   return val;
 }
 
+#endif
 
 
+#ifdef HAVE_FSTAT
+
 /* SUBROUTINE FSTAT(UNIT, SARRAY, STATUS)
    INTEGER, INTENT(IN) :: UNIT
    INTEGER, INTENT(OUT) :: SARRAY(13)
@@ -546,3 +558,5 @@
   fstat_i8_sub (unit, sarray, &val);
   return val;
 }
+
+#endif
Index: gcc-4_2-branch/libgfortran/ChangeLog
===================================================================
--- gcc-4_2-branch/libgfortran/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/libgfortran/ChangeLog	(revision 124164)
@@ -1,3 +1,19 @@
+2007-04-17  Jerry DeLisle  <jvdelisle@gcc.gnu.org>
+
+	PR libgfortran/31366
+	* io/transfer.c (read_block_direct): Do not generate error when reading
+	past EOF on a short record that is less than the RECL= specified.
+
+2007-04-13  Francois-Xavier Coudert  <fxcoudert@gcc.gnu.org>
+
+	PR libfortran/31335
+	* intrinsics/stat.c: Only provide STAT and FSTAT library routines
+	if stat() and fstat() library functions are available. When lstat()
+	is not available, use stat() instead.
+	* configure.ac: Add checks for stat, fstat and lstat.
+	* configure: Regenerate.
+	* config.h.in: Regenerate.
+
 2007-03-15  Jerry DeLisle  <jvdelisle@gcc.gnu.org>
 
 	PR libgfortran/31099
@@ -3,4 +19,9 @@
 	* io/file_pos.c (st_rewind): Don't set bytes_left to zero.
 
+2007-03-14  Jakub Jelinek  <jakub@redhat.com>
+
+	* io/unix.c (regular_file): For ACTION_UNSPECIFIED retry with
+	O_RDONLY even if errno is EROFS.
+
 2007-03-09  Jerry DeLisle  <jvdelisle@gcc.gnu.org>
 
Index: gcc-4_2-branch/libgfortran/config.h.in
===================================================================
--- gcc-4_2-branch/libgfortran/config.h.in	(revision 123014)
+++ gcc-4_2-branch/libgfortran/config.h.in	(revision 124164)
@@ -357,6 +357,9 @@
 /* libm includes frexpl */
 #undef HAVE_FREXPL
 
+/* Define to 1 if you have the `fstat' function. */
+#undef HAVE_FSTAT
+
 /* Define to 1 if you have the `ftruncate' function. */
 #undef HAVE_FTRUNCATE
 
@@ -462,6 +465,9 @@
 /* libm includes logl */
 #undef HAVE_LOGL
 
+/* Define to 1 if you have the `lstat' function. */
+#undef HAVE_LSTAT
+
 /* Define to 1 if you have the <math.h> header file. */
 #undef HAVE_MATH_H
 
@@ -552,6 +558,9 @@
 /* libm includes sqrtl */
 #undef HAVE_SQRTL
 
+/* Define to 1 if you have the `stat' function. */
+#undef HAVE_STAT
+
 /* Define to 1 if you have the <stddef.h> header file. */
 #undef HAVE_STDDEF_H
 
Index: gcc-4_2-branch/libgfortran/configure.ac
===================================================================
--- gcc-4_2-branch/libgfortran/configure.ac	(revision 123014)
+++ gcc-4_2-branch/libgfortran/configure.ac	(revision 124164)
@@ -177,7 +177,7 @@
 AC_CHECK_FUNCS(getrusage times mkstemp strtof strtold snprintf ftruncate chsize)
 AC_CHECK_FUNCS(chdir strerror getlogin gethostname kill link symlink perror)
 AC_CHECK_FUNCS(sleep time ttyname signal alarm ctime clock access fork execl)
-AC_CHECK_FUNCS(wait setmode gettimeofday)
+AC_CHECK_FUNCS(wait setmode gettimeofday stat fstat lstat)
 
 # Check for types
 AC_CHECK_TYPES([intptr_t])
Index: gcc-4_2-branch/libgfortran/io/unix.c
===================================================================
--- gcc-4_2-branch/libgfortran/io/unix.c	(revision 123014)
+++ gcc-4_2-branch/libgfortran/io/unix.c	(revision 124164)
@@ -1186,7 +1186,7 @@
       break;
 
     case STATUS_REPLACE:
-        crflag = O_CREAT | O_TRUNC;
+      crflag = O_CREAT | O_TRUNC;
       break;
 
     default:
@@ -1202,14 +1202,14 @@
   mode = S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH;
   fd = open (path, rwflag | crflag, mode);
   if (flags->action != ACTION_UNSPECIFIED)
-      return fd;
+    return fd;
 
   if (fd >= 0)
     {
       flags->action = ACTION_READWRITE;
       return fd;
     }
-  if (errno != EACCES)
+  if (errno != EACCES && errno != EROFS)
      return fd;
 
   /* retry for read-only access */
Index: gcc-4_2-branch/libgfortran/io/transfer.c
===================================================================
--- gcc-4_2-branch/libgfortran/io/transfer.c	(revision 123014)
+++ gcc-4_2-branch/libgfortran/io/transfer.c	(revision 124164)
@@ -410,7 +410,6 @@
 	  /* Short read, e.g. if we hit EOF.  Apparently, we read
 	   more than was written to the last record.  */
 	  *nbytes = to_read_record;
-	  generate_error (&dtp->common, ERROR_SHORT_RECORD, NULL);
 	  return;
 	}
 
Index: gcc-4_2-branch/libffi/configure
===================================================================
--- gcc-4_2-branch/libffi/configure	(revision 123014)
+++ gcc-4_2-branch/libffi/configure	(revision 124164)
@@ -5401,7 +5401,11 @@
 sparc-*-linux* | sparc-*-netbsdelf* | sparc-*-knetbsd*-gnu) TARGET=SPARC; TARGETDIR=sparc;;
 sparc*-*-rtems*) TARGET=SPARC; TARGETDIR=sparc;;
 sparc64-*-linux* | sparc64-*-freebsd* | sparc64-*-netbsd* | sparc64-*-knetbsd*-gnu) TARGET=SPARC; TARGETDIR=sparc;;
-alpha*-*-linux* | alpha*-*-osf* | alpha*-*-freebsd* | alpha*-*-kfreebsd*-gnu | alpha*-*-netbsd* | alpha*-*-knetbsd*-gnu) TARGET=ALPHA; TARGETDIR=alpha;;
+alpha*-*-linux* | alpha*-*-osf* | alpha*-*-freebsd* | alpha*-*-kfreebsd*-gnu | alpha*-*-netbsd* | alpha*-*-knetbsd*-gnu)
+	TARGET=ALPHA; TARGETDIR=alpha
+	# Support 128-bit long double, changable via command-line switch.
+	HAVE_LONG_DOUBLE='defined(__LONG_DOUBLE_128__)'
+	;;
 ia64*-*-*) TARGET=IA64; TARGETDIR=ia64;;
 m32r*-*-linux* ) TARGET=M32R; TARGETDIR=m32r;;
 m68k-*-linux*) TARGET=M68K; TARGETDIR=m68k;;
@@ -7142,15 +7146,17 @@
 
 
 # Also AC_SUBST this variable for ffi.h.
-HAVE_LONG_DOUBLE=0
-if test $ac_cv_sizeof_double != $ac_cv_sizeof_long_double; then
-  if test $ac_cv_sizeof_long_double != 0; then
-    HAVE_LONG_DOUBLE=1
+if test -z "$HAVE_LONG_DOUBLE"; then
+  HAVE_LONG_DOUBLE=0
+  if test $ac_cv_sizeof_double != $ac_cv_sizeof_long_double; then
+    if test $ac_cv_sizeof_long_double != 0; then
+      HAVE_LONG_DOUBLE=1
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_LONG_DOUBLE 1
 _ACEOF
 
+    fi
   fi
 fi
 
Index: gcc-4_2-branch/libffi/include/ffi.h.in
===================================================================
--- gcc-4_2-branch/libffi/include/ffi.h.in	(revision 123014)
+++ gcc-4_2-branch/libffi/include/ffi.h.in	(revision 124164)
@@ -153,9 +153,13 @@
 extern ffi_type ffi_type_sint64;
 extern ffi_type ffi_type_float;
 extern ffi_type ffi_type_double;
-extern ffi_type ffi_type_longdouble;
 extern ffi_type ffi_type_pointer;
 
+#if @HAVE_LONG_DOUBLE@
+extern ffi_type ffi_type_longdouble;
+#else
+#define ffi_type_longdouble ffi_type_double
+#endif
 
 typedef enum {
   FFI_OK = 0,
Index: gcc-4_2-branch/libffi/src/alpha/ffi.c
===================================================================
--- gcc-4_2-branch/libffi/src/alpha/ffi.c	(revision 123014)
+++ gcc-4_2-branch/libffi/src/alpha/ffi.c	(revision 124164)
@@ -25,13 +25,24 @@
 
 #include <ffi.h>
 #include <ffi_common.h>
-
 #include <stdlib.h>
 
-extern void ffi_call_osf(void *, unsigned long, unsigned, void *, void (*)());
-extern void ffi_closure_osf(void);
+/* Force FFI_TYPE_LONGDOUBLE to be different than FFI_TYPE_DOUBLE;
+   all further uses in this file will refer to the 128-bit type.  */
+#if defined(__LONG_DOUBLE_128__)
+# if FFI_TYPE_LONGDOUBLE != 4
+#  error FFI_TYPE_LONGDOUBLE out of date
+# endif
+#else
+# undef FFI_TYPE_LONGDOUBLE
+# define FFI_TYPE_LONGDOUBLE 4
+#endif
 
+extern void ffi_call_osf(void *, unsigned long, unsigned, void *, void (*)())
+  FFI_HIDDEN;
+extern void ffi_closure_osf(void) FFI_HIDDEN;
 
+
 ffi_status
 ffi_prep_cif_machdep(ffi_cif *cif)
 {
@@ -49,6 +60,11 @@
       cif->flags = cif->rtype->type;
       break;
 
+    case FFI_TYPE_LONGDOUBLE:
+      /* 128-bit long double is returned in memory, like a struct.  */
+      cif->flags = FFI_TYPE_STRUCT;
+      break;
+
     default:
       cif->flags = FFI_TYPE_INT;
       break;
@@ -57,6 +73,7 @@
   return FFI_OK;
 }
 
+
 void
 ffi_call(ffi_cif *cif, void (*fn)(), void *rvalue, void **avalue)
 {
@@ -64,8 +81,6 @@
   long i, avn;
   ffi_type **arg_types;
   
-  FFI_ASSERT (cif->abi == FFI_OSF);
-
   /* If the return value is a struct and we don't have a return
      value address then we need to make one.  */
   if (rvalue == NULL && cif->flags == FFI_TYPE_STRUCT)
@@ -84,6 +99,8 @@
 
   while (i < avn)
     {
+      size_t size = (*arg_types)->size;
+
       switch ((*arg_types)->type)
 	{
 	case FFI_TYPE_SINT8:
@@ -129,6 +146,12 @@
 	  *(double *) argp = *(double *)(* avalue);
 	  break;
 
+	case FFI_TYPE_LONGDOUBLE:
+	  /* 128-bit long double is passed by reference.  */
+	  *(long double **) argp = (long double *)(* avalue);
+	  size = sizeof (long double *);
+	  break;
+
 	case FFI_TYPE_STRUCT:
 	  memcpy(argp, *avalue, (*arg_types)->size);
 	  break;
@@ -137,7 +160,7 @@
 	  FFI_ASSERT(0);
 	}
 
-      argp += ALIGN((*arg_types)->size, FFI_SIZEOF_ARG) / FFI_SIZEOF_ARG;
+      argp += ALIGN(size, FFI_SIZEOF_ARG) / FFI_SIZEOF_ARG;
       i++, arg_types++, avalue++;
     }
 
@@ -153,8 +176,6 @@
 {
   unsigned int *tramp;
 
-  FFI_ASSERT (cif->abi == FFI_OSF);
-
   tramp = (unsigned int *) &closure->tramp[0];
   tramp[0] = 0x47fb0401;	/* mov $27,$1		*/
   tramp[1] = 0xa77b0010;	/* ldq $27,16($27)	*/
@@ -177,7 +198,8 @@
   return FFI_OK;
 }
 
-int
+
+long FFI_HIDDEN
 ffi_closure_osf_inner(ffi_closure *closure, void *rvalue, unsigned long *argp)
 {
   ffi_cif *cif;
@@ -205,6 +227,8 @@
   /* Grab the addresses of the arguments from the stack frame.  */
   while (i < avn)
     {
+      size_t size = arg_types[i]->size;
+
       switch (arg_types[i]->type)
 	{
 	case FFI_TYPE_SINT8:
@@ -236,16 +260,22 @@
 	  avalue[i] = &argp[argn - (argn < 6 ? 6 : 0)];
 	  break;
 
+	case FFI_TYPE_LONGDOUBLE:
+	  /* 128-bit long double is passed by reference.  */
+	  avalue[i] = (long double *) argp[argn];
+	  size = sizeof (long double *);
+	  break;
+
 	default:
-	  FFI_ASSERT(0);
+	  abort ();
 	}
 
-      argn += ALIGN(arg_types[i]->size, FFI_SIZEOF_ARG) / FFI_SIZEOF_ARG;
+      argn += ALIGN(size, FFI_SIZEOF_ARG) / FFI_SIZEOF_ARG;
       i++;
     }
 
   /* Invoke the closure.  */
-  (closure->fun) (cif, rvalue, avalue, closure->user_data);
+  closure->fun (cif, rvalue, avalue, closure->user_data);
 
   /* Tell ffi_closure_osf how to perform return type promotions.  */
   return cif->rtype->type;
Index: gcc-4_2-branch/libffi/src/alpha/osf.S
===================================================================
--- gcc-4_2-branch/libffi/src/alpha/osf.S	(revision 123014)
+++ gcc-4_2-branch/libffi/src/alpha/osf.S	(revision 124164)
@@ -1,10 +1,8 @@
 /* -----------------------------------------------------------------------
-   osf.S - Copyright (c) 1998, 2001 Red Hat
+   osf.S - Copyright (c) 1998, 2001, 2007 Red Hat
    
    Alpha/OSF Foreign Function Interface 
 
-   $Id$
-
    Permission is hereby granted, free of charge, to any person obtaining
    a copy of this software and associated documentation files (the
    ``Software''), to deal in the Software without restriction, including
@@ -42,6 +40,8 @@
 	.align	3
 	.globl	ffi_call_osf
 	.ent	ffi_call_osf
+	FFI_HIDDEN(ffi_call_osf)
+
 ffi_call_osf:
 	.frame	$15, 32, $26, 0
 	.mask   0x4008000, -32
@@ -129,6 +129,8 @@
 	.align	3
 	.globl	ffi_closure_osf
 	.ent	ffi_closure_osf
+	FFI_HIDDEN(ffi_closure_osf)
+
 ffi_closure_osf:
 	.frame	$30, 16*8, $26, 0
 	.mask	0x4000000, -16*8
@@ -265,7 +267,7 @@
 	.gprel32 $load_32	# FFI_TYPE_INT
 	.gprel32 $load_float	# FFI_TYPE_FLOAT
 	.gprel32 $load_double	# FFI_TYPE_DOUBLE
-	.gprel32 $load_double	# FFI_TYPE_LONGDOUBLE
+	.gprel32 $load_none	# FFI_TYPE_LONGDOUBLE
 	.gprel32 $load_u8	# FFI_TYPE_UINT8
 	.gprel32 $load_s8	# FFI_TYPE_SINT8
 	.gprel32 $load_u16	# FFI_TYPE_UINT16
Index: gcc-4_2-branch/libffi/src/types.c
===================================================================
--- gcc-4_2-branch/libffi/src/types.c	(revision 123014)
+++ gcc-4_2-branch/libffi/src/types.c	(revision 124164)
@@ -57,4 +57,17 @@
 
 FFI_TYPEDEF(float, float, FFI_TYPE_FLOAT);
 FFI_TYPEDEF(double, double, FFI_TYPE_DOUBLE);
+
+#ifdef __alpha__
+/* Even if we're not configured to default to 128-bit long double, 
+   maintain binary compatibility, as -mlong-double-128 can be used
+   at any time.  */
+/* Validate the hard-coded number below.  */
+# if defined(__LONG_DOUBLE_128__) && FFI_TYPE_LONGDOUBLE != 4
+#  error FFI_TYPE_LONGDOUBLE out of date
+# endif
+# undef ffi_type_longdouble
+ffi_type ffi_type_longdouble = { 16, 16, 4, NULL };
+#elif FFI_TYPE_LONGDOUBLE != FFI_TYPE_DOUBLE
 FFI_TYPEDEF(longdouble, long double, FFI_TYPE_LONGDOUBLE);
+#endif
Index: gcc-4_2-branch/libffi/ChangeLog
===================================================================
--- gcc-4_2-branch/libffi/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/libffi/ChangeLog	(revision 124164)
@@ -1,3 +1,16 @@
+2007-04-20  Richard Henderson  <rth@redhat.com>
+
+	* configure.ac (alpha*-*-*): Define HAVE_LONG_DOUBLE.
+	* configure: Regenerate.
+	* include/ffi.h.in (ffi_type_longdouble): Define as ffi_type_double
+	if HAVE_LONG_DOUBLE is false.
+	* src/alpha/ffi.c (ffi_prep_cif_machdep): Support the 128-bit
+	long double type.
+	(ffi_call_osf, ffi_closure_osf): Likewise.
+	* src/alpha/osf.S (ffi_call_osf, ffi_closure_osf): Mark hidden.
+	* src/types.c (ffi_type_longdouble): For alpha, always generate
+	for the 128-bit long double type.
+
 2007-02-13  Andreas Krebbel  <krebbel1@de.ibm.com>
 
 	* src/s390/ffi.c (ffi_prep_args, ffi_prep_cif_machdep,
Index: gcc-4_2-branch/libffi/configure.ac
===================================================================
--- gcc-4_2-branch/libffi/configure.ac	(revision 123014)
+++ gcc-4_2-branch/libffi/configure.ac	(revision 124164)
@@ -59,7 +59,11 @@
 sparc-*-linux* | sparc-*-netbsdelf* | sparc-*-knetbsd*-gnu) TARGET=SPARC; TARGETDIR=sparc;;
 sparc*-*-rtems*) TARGET=SPARC; TARGETDIR=sparc;;
 sparc64-*-linux* | sparc64-*-freebsd* | sparc64-*-netbsd* | sparc64-*-knetbsd*-gnu) TARGET=SPARC; TARGETDIR=sparc;;
-alpha*-*-linux* | alpha*-*-osf* | alpha*-*-freebsd* | alpha*-*-kfreebsd*-gnu | alpha*-*-netbsd* | alpha*-*-knetbsd*-gnu) TARGET=ALPHA; TARGETDIR=alpha;;
+alpha*-*-linux* | alpha*-*-osf* | alpha*-*-freebsd* | alpha*-*-kfreebsd*-gnu | alpha*-*-netbsd* | alpha*-*-knetbsd*-gnu)
+	TARGET=ALPHA; TARGETDIR=alpha
+	# Support 128-bit long double, changable via command-line switch.
+	HAVE_LONG_DOUBLE='defined(__LONG_DOUBLE_128__)'
+	;;
 ia64*-*-*) TARGET=IA64; TARGETDIR=ia64;;
 m32r*-*-linux* ) TARGET=M32R; TARGETDIR=m32r;;
 m68k-*-linux*) TARGET=M68K; TARGETDIR=m68k;;
@@ -132,11 +136,13 @@
 AC_CHECK_SIZEOF(long double)
 
 # Also AC_SUBST this variable for ffi.h.
-HAVE_LONG_DOUBLE=0
-if test $ac_cv_sizeof_double != $ac_cv_sizeof_long_double; then
-  if test $ac_cv_sizeof_long_double != 0; then
-    HAVE_LONG_DOUBLE=1
-    AC_DEFINE(HAVE_LONG_DOUBLE, 1, [Define if you have the long double type and it is bigger than a double])
+if test -z "$HAVE_LONG_DOUBLE"; then
+  HAVE_LONG_DOUBLE=0
+  if test $ac_cv_sizeof_double != $ac_cv_sizeof_long_double; then
+    if test $ac_cv_sizeof_long_double != 0; then
+      HAVE_LONG_DOUBLE=1
+      AC_DEFINE(HAVE_LONG_DOUBLE, 1, [Define if you have the long double type and it is bigger than a double])
+    fi
   fi
 fi
 AC_SUBST(HAVE_LONG_DOUBLE)
Index: gcc-4_2-branch/contrib/ChangeLog
===================================================================
--- gcc-4_2-branch/contrib/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/contrib/ChangeLog	(revision 124164)
@@ -1,3 +1,18 @@
+2007-04-04  Eric Christopher  <echristo@apple.com>
+
+	Backport from mainline:
+	2007-04-04  Zack Weinberg  <zack@mrtock.ucsd.edu>
+
+        * texi2pod.pl: Correct handling of @itemize with no argument.
+
+        2007-02-16  Matthias Klose  <doko@debian.org>
+
+        * texi2pod.pl: Handle @subsubsection, ignore @anchor.
+
+        2007-02-06  Richard Sandiford  <richard@codesourcery.com>
+
+	* texi2pod.pl: Handle @multitable.
+
 2006-09-27  Matthew Sachs  <msachs@apple.com>
 
 	* compareSumTests3: POD syntax fix.
@@ -84,14 +99,14 @@
 
 2005-10-28  Daniel Berlin  <dberlin@dberlin.org>
 	    Ben Elliston <bje@au1.ibm.com>
-	
+
 	* gcc_update: Update for svn.
 	* newcvsroot: Ditto.
 	* gcc_build: Ditto.
 
 2005-10-21  Mark Mitchell  <mark@codesourcery.com>
 
-	* texi2pod.pl: Substitue for @value even when part of @include. 
+	* texi2pod.pl: Substitue for @value even when part of @include.
 
 2005-10-21  Bob Wilson  <bob.wilson@acm.org>
 
Index: gcc-4_2-branch/contrib/texi2pod.pl
===================================================================
--- gcc-4_2-branch/contrib/texi2pod.pl	(revision 123014)
+++ gcc-4_2-branch/contrib/texi2pod.pl	(revision 124164)
@@ -162,6 +162,8 @@
 	} elsif ($ended =~ /^(?:itemize|enumerate|[fv]?table)$/) {
 	    $_ = "\n=back\n";
 	    $ic = pop @icstack;
+	} elsif ($ended eq "multitable") {
+	    $_ = "\n=back\n";
 	} else {
 	    die "unknown command \@end $ended at line $.\n";
 	}
@@ -252,6 +254,8 @@
 	and $_ = "\n=head2 $1\n";
     /^\@subsection\s+(.+)$/
 	and $_ = "\n=head3 $1\n";
+    /^\@subsubsection\s+(.+)$/
+	and $_ = "\n=head4 $1\n";
 
     # Block command handlers:
     /^\@itemize(?:\s+(\@[a-z]+|\*|-))?/ and do {
@@ -260,7 +264,7 @@
 	if (defined $1) {
 	    $ic = $1;
 	} else {
-	    $ic = '@bullet';
+	    $ic = '*';
 	}
 	$_ = "\n=over 4\n";
 	$endw = "itemize";
@@ -278,6 +282,12 @@
 	$endw = "enumerate";
     };
 
+    /^\@multitable\s.*/ and do {
+	push @endwstack, $endw;
+	$endw = "multitable";
+	$_ = "\n=over 4\n";
+    };
+
     /^\@([fv]?table)\s+(\@[a-z]+)/ and do {
 	push @endwstack, $endw;
 	push @icstack, $ic;
@@ -297,6 +307,16 @@
 	$_ = "";	# need a paragraph break
     };
 
+    /^\@item\s+(.*\S)\s*$/ and $endw eq "multitable" and do {
+	@columns = ();
+	for $column (split (/\s*\@tab\s*/, $1)) {
+	    # @strong{...} is used a @headitem work-alike
+	    $column =~ s/^\@strong{(.*)}$/$1/;
+	    push @columns, $column;
+	}
+	$_ = "\n=item ".join (" : ", @columns)."\n";
+    };
+
     /^\@itemx?\s*(.+)?$/ and do {
 	if (defined $1) {
 	    # Entity escapes prevent munging by the <> processing below.
@@ -382,6 +402,9 @@
     s/\@gol//g;
     s/\@\*\s*\n?//g;
 
+    # Anchors are thrown away
+    s/\@anchor\{(?:[^\}]*)\}//g;
+
     # @uref can take one, two, or three arguments, with different
     # semantics each time.  @url and @email are just like @uref with
     # one argument, for our purposes.
Index: gcc-4_2-branch/libjava/configure
===================================================================
--- gcc-4_2-branch/libjava/configure	(revision 123014)
+++ gcc-4_2-branch/libjava/configure	(revision 124164)
@@ -7687,7 +7687,7 @@
   # See if we find them without any special options.
   # Don't add to $LIBS permanently.
   ac_save_LIBS=$LIBS
-  LIBS="-lXt $LIBS"
+  LIBS="-lX11 $LIBS"
   if test x$gcc_no_link = xyes; then
   { { echo "$as_me:$LINENO: error: Link tests are not allowed after GCC_NO_EXECUTABLES." >&5
 echo "$as_me: error: Link tests are not allowed after GCC_NO_EXECUTABLES." >&2;}
@@ -9414,12 +9414,13 @@
 
 
 
+
 for ac_func in strerror ioctl select fstat open fsync sleep opendir \
                    gmtime_r localtime_r readdir_r getpwuid_r getcwd \
 		   access stat lstat mkdir rename rmdir unlink utime chmod readlink \
 		   nl_langinfo setlocale \
 		   inet_pton uname inet_ntoa \
-		   fork execvp pipe sigaction ftruncate mmap \
+		   fork execvp getrlimit pipe sigaction ftruncate mmap \
 		   getifaddrs
 do
 as_ac_var=`echo "ac_cv_func_$ac_func" | $as_tr_sh`
@@ -9875,7 +9876,8 @@
 
 
 
-for ac_header in execinfo.h unistd.h dlfcn.h
+
+for ac_header in execinfo.h unistd.h dlfcn.h sys/resource.h
 do
 as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
 if eval "test \"\${$as_ac_Header+set}\" = set"; then
Index: gcc-4_2-branch/libjava/gnu/java/nio/channels/natFileChannelPosix.cc
===================================================================
--- gcc-4_2-branch/libjava/gnu/java/nio/channels/natFileChannelPosix.cc	(revision 123014)
+++ gcc-4_2-branch/libjava/gnu/java/nio/channels/natFileChannelPosix.cc	(revision 124164)
@@ -178,8 +178,6 @@
       throw new ::java::io::FileNotFoundException (msg->toString ());
     }
 
-  _Jv_platform_close_on_exec (fd);
-
   return fd;
 }
 
Index: gcc-4_2-branch/libjava/gnu/java/net/natPlainSocketImplPosix.cc
===================================================================
--- gcc-4_2-branch/libjava/gnu/java/net/natPlainSocketImplPosix.cc	(revision 123014)
+++ gcc-4_2-branch/libjava/gnu/java/net/natPlainSocketImplPosix.cc	(revision 124164)
@@ -72,8 +72,6 @@
       throw new ::java::io::IOException (JvNewStringUTF (strerr));
     }
 
-  _Jv_platform_close_on_exec (sock);
-
   // We use native_fd in place of fd here.  From leaving fd null we avoid
   // the double close problem in FileDescriptor.finalize.
   native_fd = sock;
@@ -285,8 +283,6 @@
   if (new_socket < 0)
     goto error;
 
-  _Jv_platform_close_on_exec (new_socket);
-
   jbyteArray raddr;
   jint rport;
   if (u.address.sin_family == AF_INET)
Index: gcc-4_2-branch/libjava/gnu/java/net/natPlainDatagramSocketImplPosix.cc
===================================================================
--- gcc-4_2-branch/libjava/gnu/java/net/natPlainDatagramSocketImplPosix.cc	(revision 123014)
+++ gcc-4_2-branch/libjava/gnu/java/net/natPlainDatagramSocketImplPosix.cc	(revision 124164)
@@ -83,8 +83,6 @@
       throw new ::java::net::SocketException (JvNewStringUTF (strerr));
     }
 
-  _Jv_platform_close_on_exec (sock);
-
   // We use native_fd in place of fd here.  From leaving fd null we avoid
   // the double close problem in FileDescriptor.finalize.
   native_fd = sock;
Index: gcc-4_2-branch/libjava/configure.ac
===================================================================
--- gcc-4_2-branch/libjava/configure.ac	(revision 123014)
+++ gcc-4_2-branch/libjava/configure.ac	(revision 124164)
@@ -906,10 +906,10 @@
 		   access stat lstat mkdir rename rmdir unlink utime chmod readlink \
 		   nl_langinfo setlocale \
 		   inet_pton uname inet_ntoa \
-		   fork execvp pipe sigaction ftruncate mmap \
+		   fork execvp getrlimit pipe sigaction ftruncate mmap \
 		   getifaddrs])
    AC_CHECK_FUNCS(inet_aton inet_addr, break)
-   AC_CHECK_HEADERS(execinfo.h unistd.h dlfcn.h)
+   AC_CHECK_HEADERS(execinfo.h unistd.h dlfcn.h sys/resource.h)
    # Do an additional check on dld, HP-UX for example has dladdr in libdld.sl
    AC_CHECK_LIB(dl, dladdr, [
        AC_DEFINE(HAVE_DLADDR, 1, [Define if you have dladdr()])], [
Index: gcc-4_2-branch/libjava/java/lang/natPosixProcess.cc
===================================================================
--- gcc-4_2-branch/libjava/java/lang/natPosixProcess.cc	(revision 123014)
+++ gcc-4_2-branch/libjava/java/lang/natPosixProcess.cc	(revision 124164)
@@ -17,6 +17,9 @@
 #include <fcntl.h>
 #include <sys/types.h>
 #include <sys/wait.h>
+#ifdef HAVE_SYS_RESOURCE_H
+#include <sys/resource.h>
+#endif
 #include <signal.h>
 #include <string.h>
 #include <stdlib.h>
@@ -341,7 +344,31 @@
 		  _exit (127);
 		}
 	    }
-
+          // Make sure all file descriptors are closed.  In
+          // multi-threaded programs, there is a race between when a
+          // descriptor is obtained, when we can set FD_CLOEXEC, and
+          // fork().  If the fork occurs before FD_CLOEXEC is set, the
+          // descriptor would leak to the execed process if we did not
+          // manually close it.  So that is what we do.  Since we
+          // close all the descriptors, it is redundant to set
+          // FD_CLOEXEC on them elsewhere.
+          int max_fd;
+#ifdef HAVE_GETRLIMIT
+          rlimit rl;
+          int rv = getrlimit(RLIMIT_NOFILE, &rl);
+          if (rv == 0)
+            max_fd = rl.rlim_max - 1;
+          else
+            max_fd = 1024 - 1;
+#else
+          max_fd = 1024 - 1;
+#endif
+          while(max_fd > 2)
+            {
+              if (max_fd != msgp[1])
+                close (max_fd);
+              max_fd--;
+            }
 	  // Make sure that SIGCHLD is unblocked for the new process.
 	  sigset_t mask;
 	  sigemptyset (&mask);
@@ -425,11 +452,4 @@
 
   myclose (msgp[0]);
   cleanup (args, env, path);
-
-  if (exception == NULL)
-    {
-      fcntl (outp[1], F_SETFD, FD_CLOEXEC);
-      fcntl (inp[0], F_SETFD, FD_CLOEXEC);
-      fcntl (errp[0], F_SETFD, FD_CLOEXEC);
-    }
 }
Index: gcc-4_2-branch/libjava/include/posix.h
===================================================================
--- gcc-4_2-branch/libjava/include/posix.h	(revision 123014)
+++ gcc-4_2-branch/libjava/include/posix.h	(revision 124164)
@@ -91,15 +91,6 @@
 extern void _Jv_platform_initialize (void);
 extern void _Jv_platform_initProperties (java::util::Properties*);
 
-inline void
-_Jv_platform_close_on_exec (jint fd)
-{
-  // Ignore errors.
-  ::fcntl (fd, F_SETFD, FD_CLOEXEC);
-}
-
-#undef fcntl
-
 #ifdef JV_HASH_SYNCHRONIZATION
 #ifndef HAVE_USLEEP_DECL
 extern "C" int usleep (useconds_t useconds);
Index: gcc-4_2-branch/libjava/include/config.h.in
===================================================================
--- gcc-4_2-branch/libjava/include/config.h.in	(revision 123014)
+++ gcc-4_2-branch/libjava/include/config.h.in	(revision 124164)
@@ -124,6 +124,9 @@
 /* Define to 1 if you have the `getpwuid_r' function. */
 #undef HAVE_GETPWUID_R
 
+/* Define to 1 if you have the `getrlimit' function. */
+#undef HAVE_GETRLIMIT
+
 /* Define to 1 if you have the `gettimeofday' function. */
 #undef HAVE_GETTIMEOFDAY
 
@@ -304,6 +307,9 @@
 /* Define to 1 if you have the <sys/ioctl.h> header file. */
 #undef HAVE_SYS_IOCTL_H
 
+/* Define to 1 if you have the <sys/resource.h> header file. */
+#undef HAVE_SYS_RESOURCE_H
+
 /* Define to 1 if you have the <sys/rw_lock.h> header file. */
 #undef HAVE_SYS_RW_LOCK_H
 
Index: gcc-4_2-branch/libjava/ChangeLog
===================================================================
--- gcc-4_2-branch/libjava/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/libjava/ChangeLog	(revision 124164)
@@ -1,3 +1,19 @@
+2007-03-25  David Daney  <ddaney@avtrex.com>
+
+	PR libgcj/31228
+	* configure.ac: Add checks for getrlimit and sys/resource.h.
+	* include/posix.h (_Jv_platform_close_on_exec): Remove.
+	* include/config.h.in: Regenerate.
+	* configure: Regenerate.
+	* gnu/java/nio/channels/natFileChannelPosix.cc (open): Remove call to
+	_Jv_platform_close_on_exec;
+	* gnu/java/net/natPlainSocketImplPosix.cc (create): Likewise.
+	(accept): Likewise.
+	* gnu/java/net/natPlainDatagramSocketImplPosix.cc (create):Likewise.
+	* java/lang/natPosixProcess.cc: Include sys/resource.h.
+	(nativeSpawn): Close all file descriptors.  Don't set FD_CLOEXEC on
+	pipes.
+
 2007-01-29  Kaloian Doganov  <kaloian@doganov.org>
 
 	PR libgcj/30600:
Index: gcc-4_2-branch/libcpp/ChangeLog
===================================================================
--- gcc-4_2-branch/libcpp/ChangeLog	(revision 123014)
+++ gcc-4_2-branch/libcpp/ChangeLog	(revision 124164)
@@ -1,3 +1,9 @@
+2007-04-23  Tom Tromey  <tromey@redhat.com>
+
+	PR preprocessor/30468:
+	* mkdeps.c (apply_vpath): Strip successive '/'s if we stripped
+	'./'.
+
 2006-12-29  Jakub Jelinek  <jakub@redhat.com>
 
 	PR preprocessor/29612
Index: gcc-4_2-branch/libcpp/mkdeps.c
===================================================================
--- gcc-4_2-branch/libcpp/mkdeps.c	(revision 123014)
+++ gcc-4_2-branch/libcpp/mkdeps.c	(revision 124164)
@@ -1,5 +1,5 @@
 /* Dependency generator for Makefile fragments.
-   Copyright (C) 2000, 2001, 2003 Free Software Foundation, Inc.
+   Copyright (C) 2000, 2001, 2003, 2007 Free Software Foundation, Inc.
    Contributed by Zack Weinberg, Mar 2000
 
 This program is free software; you can redistribute it and/or modify it
@@ -141,7 +141,13 @@
 
   /* Remove leading ./ in any case.  */
   while (t[0] == '.' && IS_DIR_SEPARATOR (t[1]))
-    t += 2;
+    {
+      t += 2;
+      /* If we removed a leading ./, then also remove any /s after the
+	 first.  */
+      while (IS_DIR_SEPARATOR (t[0]))
+	++t;
+    }
 
   return t;
 }
